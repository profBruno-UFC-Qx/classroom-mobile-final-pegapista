

=== ARQUIVO: app/src/main/res/xml/data_extraction_rules.xml ===

<?xml version="1.0" encoding="utf-8"?><!--
   Sample data extraction rules file; uncomment and customize as necessary.
   See https://developer.android.com/about/versions/12/backup-restore#xml-changes
   for details.
-->
<data-extraction-rules>
    <cloud-backup>
        <!-- TODO: Use <include> and <exclude> to control what is backed up.
        <include .../>
        <exclude .../>
        -->
    </cloud-backup>
    <!--
    <device-transfer>
        <include .../>
        <exclude .../>
    </device-transfer>
    -->
</data-extraction-rules>

=== ARQUIVO: app/src/main/res/xml/backup_rules.xml ===

<?xml version="1.0" encoding="utf-8"?><!--
   Sample backup rules file; uncomment and customize as necessary.
   See https://developer.android.com/guide/topics/data/autobackup
   for details.
   Note: This file is ignored for devices older than API 31
   See https://developer.android.com/about/versions/12/backup-restore
-->
<full-backup-content>
    <!--
   <include domain="sharedpref" path="."/>
   <exclude domain="sharedpref" path="device.xml"/>
-->
</full-backup-content>

=== ARQUIVO: app/src/main/res/xml/file_paths.xml ===

<?xml version="1.0" encoding="utf-8"?>
<paths>
    <cache-path name="cache_images" path="." />

    <cache-path name="my_images" path="images/" />

    <files-path name="files" path="." />
</paths>

=== ARQUIVO: app/src/main/res/values/themes.xml ===

<?xml version="1.0" encoding="utf-8"?>
<resources>

    <style name="Theme.PegaPista" parent="android:Theme.Material.Light.NoActionBar" />
</resources>

=== ARQUIVO: app/src/main/res/values/strings.xml ===

<resources>
    <string name="app_name">PegaPista</string>
</resources>

=== ARQUIVO: app/src/main/res/values/colors.xml ===

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="purple_200">#FFBB86FC</color>
    <color name="purple_500">#049AF5</color>
    <color name="purple_700">#FF3700B3</color>
    <color name="teal_200">#FF03DAC5</color>
    <color name="teal_700">#FF018786</color>
    <color name="black">#FF000000</color>
    <color name="white">#FFFFFFFF</color>
</resources>

=== ARQUIVO: app/src/main/res/drawable/ic_launcher_foreground.xml ===

<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="85.84757"
                android:endY="92.4963"
                android:startX="42.9492"
                android:startY="49.59793"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
        android:strokeWidth="1"
        android:strokeColor="#00000000" />
</vector>

=== ARQUIVO: app/src/main/res/drawable/ic_launcher_background.xml ===

<?xml version="1.0" encoding="utf-8"?>
<vector
    android:height="108dp"
    android:width="108dp"
    android:viewportHeight="108"
    android:viewportWidth="108"
    xmlns:android="http://schemas.android.com/apk/res/android">
    <path android:fillColor="#3DDC84"
          android:pathData="M0,0h108v108h-108z"/>
    <path android:fillColor="#00000000" android:pathData="M9,0L9,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,0L19,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,0L29,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,0L39,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,0L49,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,0L59,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,0L69,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,0L79,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M89,0L89,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M99,0L99,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,9L108,9"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,19L108,19"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,29L108,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,39L108,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,49L108,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,59L108,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,69L108,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,79L108,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,89L108,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,99L108,99"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,29L89,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,39L89,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,49L89,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,59L89,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,69L89,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,79L89,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,19L29,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,19L39,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,19L49,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,19L59,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,19L69,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,19L79,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
</vector>


=== ARQUIVO: app/src/main/res/drawable/ic_icone_pega_pista_background.xml ===

<?xml version="1.0" encoding="utf-8"?>
<vector
    android:height="108dp"
    android:width="108dp"
    android:viewportHeight="108"
    android:viewportWidth="108"
    xmlns:android="http://schemas.android.com/apk/res/android">
    <path android:fillColor="#3DDC84"
          android:pathData="M0,0h108v108h-108z"/>
    <path android:fillColor="#00000000" android:pathData="M9,0L9,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,0L19,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,0L29,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,0L39,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,0L49,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,0L59,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,0L69,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,0L79,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M89,0L89,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M99,0L99,108"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,9L108,9"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,19L108,19"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,29L108,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,39L108,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,49L108,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,59L108,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,69L108,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,79L108,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,89L108,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M0,99L108,99"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,29L89,29"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,39L89,39"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,49L89,49"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,59L89,59"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,69L89,69"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M19,79L89,79"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M29,19L29,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M39,19L39,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M49,19L49,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M59,19L59,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M69,19L69,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
    <path android:fillColor="#00000000" android:pathData="M79,19L79,89"
          android:strokeColor="#33FFFFFF" android:strokeWidth="0.8"/>
</vector>


=== ARQUIVO: app/src/main/res/mipmap-anydpi-v26/ic_icone_pega_pista.xml ===

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_icone_pega_pista_background"/>
    <foreground android:drawable="@mipmap/ic_icone_pega_pista_foreground"/>
</adaptive-icon>

=== ARQUIVO: app/src/main/res/mipmap-anydpi-v26/ic_icone_pega_pista_round.xml ===

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_icone_pega_pista_background"/>
    <foreground android:drawable="@mipmap/ic_icone_pega_pista_foreground"/>
</adaptive-icon>

=== ARQUIVO: app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml ===

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_pegapista"/>
</adaptive-icon>

=== ARQUIVO: app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml ===

<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_pegapista"/>
</adaptive-icon>

=== ARQUIVO: app/src/main/java/com/example/pegapista/PegaPistaApplication.kt ===

package com.example.pegapista

import android.app.Application
import com.example.pegapista.di.storageModule // Seu módulo
import com.example.pegapista.di.viewModelModule
import org.koin.android.ext.koin.androidContext
import org.koin.core.context.startKoin

class PegaPistaApplication : Application() {
    override fun onCreate() {
        super.onCreate()

        startKoin {
            androidContext(this@PegaPistaApplication)
            modules(listOf(storageModule, viewModelModule))
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/BuscaViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.data.repository.UserRepository
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

class BuscaViewModel : ViewModel() {
    private val repository = UserRepository()

    private val _textoBusca = MutableStateFlow("")
    val textoBusca = _textoBusca.asStateFlow()

    private val _resultados = MutableStateFlow<List<Usuario>>(emptyList())
    val resultados = _resultados.asStateFlow()

    private val _isLoading = MutableStateFlow(false)
    val isLoading = _isLoading.asStateFlow()

    init {
        carregarSugestoes()
    }
    fun atualizarBusca(novoTexto: String) {
        _textoBusca.value = novoTexto

        if (novoTexto.isBlank()) {
            _resultados.value = emptyList()
            return
        }

        performarBusca(novoTexto)
    }

    private fun performarBusca(query: String) {
        viewModelScope.launch {
            _isLoading.value = true
            val lista = repository.buscarUsuarios(query)
            _resultados.value = lista
            _isLoading.value = false
        }
    }

    private fun carregarSugestoes() {
        viewModelScope.launch {
            _isLoading.value = true
            val lista = repository.getUsuariosSugestao()
            _resultados.value = lista
            _isLoading.value = false
        }
    }

    suspend fun getFotoPerfil(userId: String): String? {
        return try {
            repository.getUsuarioPorId(userId)?.fotoPerfilUrl
        } catch (e: Exception) {
            null
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/AuthViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.repository.AuthRepository
import com.google.firebase.auth.FirebaseAuth
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import com.google.firebase.auth.GoogleAuthProvider



// Estado da UI para autenticação
data class AuthUiState(
    val isLoading: Boolean = false,
    val error: String? = null,
    val isSuccess: Boolean = false
)

class AuthViewModel : ViewModel() {

    private val repository = AuthRepository()

    private val _uiState = MutableStateFlow(AuthUiState())
    val uiState: StateFlow<AuthUiState> = _uiState.asStateFlow()

    fun resetState() {
        _uiState.value = AuthUiState()
    }

    fun login(email: String, senha: String) {
        if (email.isBlank() || senha.isBlank()) {
            _uiState.value = AuthUiState(error = "Preencha todos os campos")
            return
        }

        _uiState.value = AuthUiState(isLoading = true)

        viewModelScope.launch {
            val result = repository.login(email, senha)
            result.onSuccess {
                _uiState.value = AuthUiState(isSuccess = true)
            }.onFailure { exception ->
                _uiState.value = AuthUiState(error = exception.message ?: "Erro desconhecido")
            }
        }
    }

    fun cadastrar(nome: String, email: String, senha: String, confirmarSenha: String) {
        if (nome.isBlank() || email.isBlank() || senha.isBlank()) {
            _uiState.value = AuthUiState(error = "Preencha todos os campos")
            return
        }
        if (senha != confirmarSenha) {
            _uiState.value = AuthUiState(error = "As senhas não coincidem")
            return
        }
        if (senha.length < 6) {
            _uiState.value = AuthUiState(error = "A senha deve ter pelo menos 6 caracteres")
            return
        }

        _uiState.value = AuthUiState(isLoading = true)

        viewModelScope.launch {
            val result = repository.cadastrar(nome, email, senha)
            result.onSuccess {
                _uiState.value = AuthUiState(isSuccess = true)
            }.onFailure { exception ->
                _uiState.value = AuthUiState(error = exception.message ?: "Erro ao cadastrar")
            }
        }
    }

    //GOOGLE

    fun loginComGoogle(idToken: String) {
        _uiState.value = AuthUiState(isLoading = true)
        viewModelScope.launch {
            val result = repository.loginComGoogle(idToken)
            result
                .onSuccess {
                    _uiState.value = AuthUiState(isSuccess = true)
                }
                .onFailure { e ->
                    _uiState.value = AuthUiState(
                        isLoading = false,
                        error = "Erro no Google: ${e.message}"
                    )
                }
        }
    }

}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/ListaUsuariosViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.data.repository.UserRepository
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

class ListaUsuariosViewModel : ViewModel() {
    private val repository = UserRepository()

    private val _listaUsuarios = MutableStateFlow<List<Usuario>>(emptyList())
    val listaUsuarios = _listaUsuarios.asStateFlow()

    private val _isLoading = MutableStateFlow(false)
    val isLoading = _isLoading.asStateFlow()

    fun carregarLista(userId: String, tipo: String) {
        viewModelScope.launch {
            _isLoading.value = true
            try {
                val resultado = if (tipo == "SEGUIDORES") {
                    repository.getListaSeguidores(userId)
                } else {
                    repository.getListaSeguindo(userId)
                }
                _listaUsuarios.value = resultado
            } catch (e: Exception) {
                e.printStackTrace()
            } finally {
                _isLoading.value = false
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/HomeViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.data.repository.UserRepository
import com.example.pegapista.data.repository.PostRepository
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.launch
import android.app.Application
import androidx.lifecycle.AndroidViewModel
import com.example.pegapista.data.local.AppDatabase

class HomeViewModel(application: Application) : AndroidViewModel(application) {

    private val db = AppDatabase.getDatabase(application)
    private val postRepository = PostRepository(db, application)
    private val userRepository = UserRepository()

    private val _usuario = MutableStateFlow<Usuario?>(null)
    val usuario: StateFlow<Usuario?> = _usuario

    private val _ranking = MutableStateFlow<List<Usuario>>(emptyList())
    val ranking: StateFlow<List<Usuario>> = _ranking

    private val _atividadesAmigos = MutableStateFlow<List<Postagem>>(emptyList())
    val atividadesAmigos: StateFlow<List<Postagem>> = _atividadesAmigos

    init {
        carregarDadosUsuario()
    }

    fun carregarDadosUsuario() {
        viewModelScope.launch {
            try {
                val user = userRepository.getUsuarioAtual()
                _usuario.value = user
                _ranking.value = userRepository.getRankingSeguindo()
                val idsSeguindo = userRepository.getIdsSeguindo().toMutableList()
                if (user.id.isNotEmpty()) {
                    idsSeguindo.add(user.id)
                }
                if (idsSeguindo.isNotEmpty()) {
                    val listaIdsSegura = idsSeguindo.take(10)
                    _atividadesAmigos.value = postRepository.getFeedPosts(listaIdsSegura).take(5)
                } else {
                    _atividadesAmigos.value = emptyList()
                }

            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/PostViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import android.app.Application
import android.net.Uri
import android.util.Log
import androidx.lifecycle.AndroidViewModel
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Comentario
import com.example.pegapista.data.models.Corrida
import com.example.pegapista.data.models.Notificacao
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.data.models.TipoNotificacao
import com.example.pegapista.data.repository.NotificationRepository
import com.example.pegapista.data.repository.PostRepository
import com.example.pegapista.data.repository.UserRepository
import com.example.pegapista.utils.copiarImagemParaCache
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.storage.FirebaseStorage
import com.google.firebase.storage.storage
import comprimirImagem
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.tasks.await
import kotlinx.coroutines.withContext
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale
import java.util.UUID


data class PostUiState(
    val isLoading: Boolean = false,
    val isSuccess: Boolean = false,
    val error: String? = null
)

class PostViewModel(
    application: Application,
    private val repository: PostRepository,
    private val userRepository: UserRepository = UserRepository(),
    private val notificationRepository: NotificationRepository = NotificationRepository()
) : AndroidViewModel(application) {

    private val _uiState = MutableStateFlow(PostUiState())
    val uiState = _uiState.asStateFlow()

    private val _feedState = MutableStateFlow<List<Postagem>>(emptyList())
    val feedState = _feedState.asStateFlow()

    private val _comentariosState = MutableStateFlow<List<Comentario>>(emptyList())
    val comentariosState = _comentariosState.asStateFlow()

    private val auth = FirebaseAuth.getInstance()
    val meuId: String
        get() = auth.currentUser?.uid ?: ""

    private val _fotosSelecionadasUris = MutableStateFlow<List<Uri>>(emptyList())
    val fotosSelecionadasUris: StateFlow<List<Uri>> = _fotosSelecionadasUris

    init {
        carregarFeed()
    }

    fun adicionarFoto(uri: Uri) {
        _fotosSelecionadasUris.value += uri
    }

    fun limparFotos() {
        _fotosSelecionadasUris.value = emptyList()
    }


    fun compartilharCorrida(
        titulo: String,
        descricao: String,
        distancia: Double,
        tempo: String,
        pace: String
    ) {
        _uiState.value = PostUiState(isLoading = true)

        viewModelScope.launch(Dispatchers.IO) {
            try {
                val usuarioAtual = userRepository.getUsuarioAtual()


                val listaFotosFinal = _fotosSelecionadasUris.value.mapNotNull { uri ->
                    copiarImagemParaCache(getApplication(), uri)
                }

                val corridaDados = Corrida(
                    distanciaKm = distancia,
                    tempo = tempo,
                    pace = pace
                )
                val tituloFinal = titulo.ifBlank { "Treino finalizado" }
                val descricaoFinal = descricao.ifBlank { "Atividade registrada." }

                val novaPostagem = Postagem(
                    id = repository.gerarIdPost(),
                    autorNome = usuarioAtual.nickname,
                    userId = usuarioAtual.id,
                    titulo = tituloFinal,
                    descricao = descricaoFinal,
                    corrida = corridaDados,
                    urlsFotos = listaFotosFinal,
                    data = System.currentTimeMillis()
                )

                val resultado = repository.criarPost(novaPostagem)

                resultado.onSuccess {
                    _uiState.value = PostUiState(isSuccess = true)
                    limparFotos()
                }.onFailure { e ->
                    _uiState.value = PostUiState(error = e.message ?: "Erro desconhecido")
                }
            } catch (e: Exception) {
                e.printStackTrace()
                _uiState.value = PostUiState(error = e.message ?: "Erro ao criar post")
            }
        }
    }



    fun carregarFeed() {
        viewModelScope.launch {
            val uid = auth.currentUser?.uid ?: return@launch
            val idsAmigos = userRepository.getIdsSeguindo().toMutableList()
            idsAmigos.add(uid)
            val listaAmigosComLimite = idsAmigos.take(10)

            if (listaAmigosComLimite.isNotEmpty()) {
                val posts = repository.getFeedPosts(listaAmigosComLimite)
                _feedState.value = posts
            } else {
                _feedState.value = emptyList()
            }
        }
    }

    fun excluirPost(postId: String) {
        viewModelScope.launch {
            _uiState.value = PostUiState(isLoading = true)
            val resultado = repository.excluirPost(postId)
            resultado.onSuccess {
                carregarFeed()
                _uiState.value = PostUiState(isSuccess = true)
            }.onFailure { e ->
                _uiState.value = PostUiState(error = "Erro ao excluir: ${e.message}")
            }
        }
    }

    fun toggleCurtidaPost(post: Postagem) {
        viewModelScope.launch {
            val uid = meuId.ifEmpty { return@launch }
            val jaCurtiu = post.curtidas.contains(uid)
            val userAtual = userRepository.getUsuarioAtual()

            val sucesso = repository.toggleCurtida(post.id, uid, jaCurtiu)

            if (sucesso) {
                val novaListaFeed = _feedState.value.map { p ->
                    if (p.id == post.id) {
                        val novasCurtidas = p.curtidas.toMutableList()
                        if (jaCurtiu) novasCurtidas.remove(uid) else novasCurtidas.add(uid)
                        p.copy(curtidas = novasCurtidas)
                    } else {
                        p
                    }
                }
                _feedState.value = novaListaFeed

                if (!jaCurtiu && post.userId != uid) {
                    val novaNotificacao = Notificacao(
                        destinatarioId = post.userId,
                        remetenteId = uid,
                        remetenteNome = userAtual.nickname,
                        tipo = TipoNotificacao.CURTIDA,
                        mensagem = "${userAtual.nickname} curtiu a sua corrida!",
                        data = System.currentTimeMillis()
                    )
                    launch { notificationRepository.criarNotificacao(novaNotificacao) }
                }
            }
        }
    }

    fun enviarComentario(postId: String, remetenteId: String, texto: String) {
        if (texto.isBlank()) return
        viewModelScope.launch {
            val usuario = userRepository.getUsuarioAtual()
            val novoComentario = Comentario(
                userId = usuario.id,
                nomeUsuario = usuario.nickname,
                texto = texto,
                data = System.currentTimeMillis()
            )
            val sucesso = repository.enviarComentario(postId, novoComentario)

            if (sucesso) {
                if (remetenteId != meuId) {
                    val novaNotificacao = Notificacao(
                        destinatarioId = remetenteId,
                        remetenteId = meuId,
                        remetenteNome = usuario.nickname,
                        tipo = TipoNotificacao.COMENTARIO,
                        mensagem = "${usuario.nickname} comentou na sua corrida!",
                        data = System.currentTimeMillis()
                    )
                    launch { notificationRepository.criarNotificacao(novaNotificacao) }
                }
                carregarComentarios(postId)
            }
        }
    }

    fun carregarComentarios(postId: String) {
        viewModelScope.launch {
            val lista = repository.getComentarios(postId)
            _comentariosState.value = lista
        }
    }

    fun formatarDataHora(timestamp: Long): String {
        val sdf = SimpleDateFormat("dd/MM/yyyy 'às' HH:mm", Locale("pt", "BR"))
        return sdf.format(Date(timestamp))
    }

    suspend fun getFotoPerfil(userId: String): String? {
        return try {
            userRepository.getUsuarioPorId(userId)?.fotoPerfilUrl
        } catch (e: Exception) {
            null
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/RankingViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.data.repository.UserRepository
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.launch

class RankingViewModel : ViewModel() {
    private val repository = UserRepository()
    private val _ranking = MutableStateFlow<List<Usuario>>(emptyList())
    val ranking: StateFlow<List<Usuario>> = _ranking

    init {
        carregarRanking()
    }

    fun carregarRanking() {
        viewModelScope.launch {
            _ranking.value = repository.getRankingSeguindo()
        }
    }

}


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/NotificationsViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Notificacao
import com.example.pegapista.data.repository.NotificationRepository
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.tasks.await

class NotificationsViewModel : ViewModel() {
    private val db = FirebaseFirestore.getInstance()
    private val auth = FirebaseAuth.getInstance()

    private val repository = NotificationRepository()

    private val _notificacoes = MutableStateFlow<List<Notificacao>>(emptyList())
    val notificacoes: StateFlow<List<Notificacao>> = _notificacoes

    fun carregarNotificacoes() {
        val meuId = auth.currentUser?.uid ?: return

        viewModelScope.launch {
            try {
                val snapshot = db.collection("notificacoes")
                    .whereEqualTo("destinatarioId", meuId)
                    .orderBy("data", com.google.firebase.firestore.Query.Direction.DESCENDING)
                    .get()
                    .await()

                val lista = snapshot.documents.mapNotNull { doc ->
                    val notificacao = doc.toObject(Notificacao::class.java)
                    notificacao?.copy(id = doc.id)
                }

                _notificacoes.value = lista

            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

    fun excluirNotificacao(id: String) {
        viewModelScope.launch {
            val listaAtual = _notificacoes.value.toMutableList()
            listaAtual.removeAll { it.id == id }
            _notificacoes.value = listaAtual

            repository.excluirNotificacao(id)
        }
    }

    fun limparTudo() {
        val meuId = auth.currentUser?.uid ?: return
        viewModelScope.launch {
            _notificacoes.value = emptyList()
            repository.limparTodasNotificacoes(meuId)
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/CorridaViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import android.annotation.SuppressLint
import android.app.Application
import android.content.Intent
import android.location.Location
import android.os.Build
import android.util.Log
import androidx.annotation.RequiresApi
import androidx.compose.runtime.retain.LocalRetainedValuesStoreProvider
import androidx.lifecycle.AndroidViewModel
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.location.LocationManager
import com.example.pegapista.data.models.Corrida
import com.example.pegapista.data.repository.CorridaRepository
import com.example.pegapista.data.repository.UserRepository
import com.example.pegapista.service.RunningService
import com.example.pegapista.service.RunningState
import com.google.android.gms.location.LocationServices
import com.google.android.gms.maps.model.LatLng
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.tasks.await
import org.koin.core.component.KoinComponent
import org.koin.core.component.inject

data class SaveRunState(
    val isLoading: Boolean = false,
    val isSuccess: Boolean = false,
    val error: String? = null
)

class CorridaViewModel(application: Application) : AndroidViewModel(application), KoinComponent {

    private val repository: CorridaRepository by inject()
    private val userRepository: UserRepository by inject()


    private val _saveState = MutableStateFlow(SaveRunState())
    val saveState = _saveState.asStateFlow()

    val distancia = RunningState.distanciaMetros
    val tempoSegundos = RunningState.tempoSegundos
    val pace = RunningState.pace
    val isRastreando = RunningState.isRastreando
    val percurso = RunningState.percurso

    //Para a camera
    private val _localizacaoInicial = MutableStateFlow<LatLng?>(null)
    val localizacaoInicial: StateFlow<LatLng?> = _localizacaoInicial

    init {
        buscarUltimaLocalizacao()
    }

    fun toggleRastreamento() {
        val intent = Intent(getApplication(), RunningService::class.java)
        if (isRastreando.value) {
            intent.action = "PAUSE"
        } else {
            intent.action = "START"
        }
        getApplication<Application>().startService(intent)
    }

    @RequiresApi(Build.VERSION_CODES.O)
    fun iniciarCorrida() {
        if (isRastreando.value) return
        RunningState.tempoSegundos.value = 0L
        RunningState.distanciaMetros.value = 0f
        RunningState.pace.value = "-:--"
        RunningState.percurso.value = emptyList()

        val intent = Intent(getApplication(), RunningService::class.java)
        intent.action = "START"
        getApplication<Application>().startForegroundService(intent)
    }

    fun finalizarESalvarCorrida() {
        val intent = Intent(getApplication(), RunningService::class.java)
        intent.action = "STOP"
        getApplication<Application>().startService(intent)

        _saveState.value = SaveRunState(isLoading = true)

        viewModelScope.launch {
            val distFinal = RunningState.distanciaMetros.value
            val tempoFinal = RunningState.tempoSegundos.value
            val paceFinal = RunningState.pace.value

            val distKm = distFinal / 1000.0
            val caloriasEstimadas = (distKm * 70).toInt()

            val novaCorrida = Corrida(
                id = repository.gerarIdCorrida(),
                distanciaKm = distKm,
                tempo = formatarTempoParaString(tempoFinal),
                pace = paceFinal
            )

            repository.salvarCorrida(novaCorrida).onSuccess {

                launch {
                    try {
                        userRepository.somarEstatisticasCorrida(
                            distanciaKm = distKm,
                            tempoSegundos = tempoFinal,
                            calorias = caloriasEstimadas
                        )
                    } catch (e: Exception) {
                        Log.e("OfflineMode", "Estatísticas não atualizadas (Offline): ${e.message}")
                    }
                }

                _saveState.value = SaveRunState(isSuccess = true)

            }.onFailure {
                _saveState.value = SaveRunState(error = it.message)
                Log.e("PegaPistaLog", "FALHA AO SALVAR LOCALMENTE: ${it.message}")
            }
        }
    }

    fun finalizarCorrida() {
        val intent = Intent(getApplication(), RunningService::class.java)
        intent.action = "STOP"
        getApplication<Application>().startService(intent)
    }

    fun formatarTempoParaString(segundos: Long): String {
        val horas = segundos / 3600
        val minutos = (segundos % 3600) / 60
        val segs = segundos % 60
        return if (horas > 0) "%d:%02d:%02d".format(horas, minutos, segs)
        else "%02d:%02d".format(minutos, segs)
    }

    @SuppressLint("MissingPermission")
    fun buscarUltimaLocalizacao() {
        val context = getApplication<Application>().applicationContext
        val fusedLocationClient = LocationServices.getFusedLocationProviderClient(context)

        viewModelScope.launch {
            try {
                val location = fusedLocationClient.lastLocation.await()
                if (location != null) {
                    _localizacaoInicial.value = LatLng(location.latitude, location.longitude)
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/PerfilViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import android.content.Context
import android.net.Uri
import android.util.Log
import androidx.compose.ui.platform.LocalContext
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.data.repository.UserRepository
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.storage.FirebaseStorage
import comprimirImagem
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.tasks.await
import java.util.UUID

class PerfilViewModel(
    private val userRepository: UserRepository
) : ViewModel() {

    private val auth = FirebaseAuth.getInstance()
    private val _userState = MutableStateFlow<Usuario?>(null)
    val userState = _userState.asStateFlow()

    init {
        carregarPerfil()
    }

    fun carregarPerfil() {
        viewModelScope.launch {
            try {
                val usuario = userRepository.getUsuarioAtual()
                _userState.value = usuario
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

    fun deslogar() {
        auth.signOut()
    }

    fun atualizarFotoPerfil(uriImagem: Uri, context: Context) {
        viewModelScope.launch {
            val usuarioAtual = _userState.value
            if (usuarioAtual?.id.isNullOrEmpty()) return@launch

            try {
                val dadosDaFoto = comprimirImagem(context, uriImagem)
                val storageRef = FirebaseStorage.getInstance().reference
                val nomeArquivo = "${usuarioAtual.id}/${UUID.randomUUID()}.jpg"
                val fotoRef = storageRef.child("fotos_perfil/$nomeArquivo")

                fotoRef.putBytes(dadosDaFoto).await()
                val downloadUrl = fotoRef.downloadUrl.await().toString()

                FirebaseFirestore.getInstance()
                    .collection("usuarios")
                    .document(usuarioAtual.id)
                    .update("fotoPerfilUrl", downloadUrl)
                    .await()

                _userState.value = usuarioAtual.copy(fotoPerfilUrl = downloadUrl)

            } catch (e: Exception) {
                Log.e("PERFIL_VM", "Erro ao atualizar foto: ${e.message}")
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/viewmodels/PerfilUsuarioViewModel.kt ===

package com.example.pegapista.ui.viewmodels

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.example.pegapista.data.models.Notificacao
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.data.models.TipoNotificacao
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.data.repository.NotificationRepository
import com.example.pegapista.data.repository.PostRepository
import com.example.pegapista.data.repository.UserRepository
import kotlinx.coroutines.async
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

class PerfilUsuarioViewModel(
    private val postRepository: PostRepository,
    private val userRepository: UserRepository = UserRepository()
): ViewModel() {

    private val repository = UserRepository()

    private val notificationRepository = NotificationRepository()
    private val _userState = MutableStateFlow(Usuario(nickname = "Carregando..."))
    val userState = _userState.asStateFlow()

    private val _isSeguindo = MutableStateFlow(false)
    val isSeguindo = _isSeguindo.asStateFlow()
    private val _postsUsuario = MutableStateFlow<List<Postagem>>(emptyList())
    val postsUsuario = _postsUsuario.asStateFlow()
    private val _isLoading = MutableStateFlow(false)
    val isLoading = _isLoading.asStateFlow()

    @RequiresApi(Build.VERSION_CODES.O)
    fun carregarPerfilUsuario(userId: String) {
        if (userId.isBlank()) return

        viewModelScope.launch {
            _isLoading.value = true

            val usuarioDeferred = async { repository.getUsuarioPorId(userId) }
            val segueDeferred = async { repository.verificarSeSegue(userId) }
            val postsDeferred = async { postRepository.getPostsPorUsuario(userId) }

            val usuarioEncontrado = usuarioDeferred.await()
            val segueAtualmente = segueDeferred.await()
            val postsEncontrados = postsDeferred.await()

            if (usuarioEncontrado != null) {
                _userState.value = usuarioEncontrado
            }

            _isSeguindo.value = segueAtualmente
            _postsUsuario.value = postsEncontrados

            _isLoading.value = false
        }
    }

    @RequiresApi(Build.VERSION_CODES.O)
    fun carregarPosts(userId: String) {
        viewModelScope.launch {

            val posts = postRepository.getPostsPorUsuario(userId)

        }
    }
    fun toggleSeguir() {
        val userAlvo = _userState.value
        if (userAlvo.id.isBlank()) return

        val jaSegue = _isSeguindo.value

        _isSeguindo.value = !jaSegue

        val ajuste = if (jaSegue) -1 else 1

        _userState.value = userAlvo.copy(
            seguidores = userAlvo.seguidores + ajuste
        )
        viewModelScope.launch {
            val userAtual = repository.getUsuarioAtual()

            if (jaSegue) {
                repository.deixarDeSeguirUsuario(userAlvo.id)
            } else {
                repository.seguirUsuario(userAlvo.id)
                val novaNotificacao = Notificacao(
                    destinatarioId = userAlvo.id,
                    remetenteId = userAtual.id,
                    remetenteNome = userAtual.nickname,
                    tipo = TipoNotificacao.SEGUIR,
                    mensagem = "${userAtual.nickname} começou a seguir você!",
                    data = System.currentTimeMillis()
                )
                launch {
                    try {
                        notificationRepository.criarNotificacao(novaNotificacao)
                    } catch (e: Exception) {
                        e.printStackTrace()
                    }
                }
            }
        }
    }

    fun atualizarLikeNoPostLocal(postId: String, userIdLogado: String) {
        val listaAtual = _postsUsuario.value.toMutableList()
        val index = listaAtual.indexOfFirst { it.id == postId }

        if (index != -1) {
            val postAntigo = listaAtual[index]
            val novasCurtidas = postAntigo.curtidas.toMutableList()

            if (novasCurtidas.contains(userIdLogado)) {
                novasCurtidas.remove(userIdLogado)
            } else {
                novasCurtidas.add(userIdLogado)
            }
            val postNovo = postAntigo.copy(curtidas = novasCurtidas)
            listaAtual[index] = postNovo
            _postsUsuario.value = listaAtual
        }
    }

    fun removerPostLocalmente(postId: String) {
        val listaAtual = _postsUsuario.value.toMutableList()
        listaAtual.removeAll { it.id == postId }
        _postsUsuario.value = listaAtual
    }

}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/home/FeedScreen.kt ===

package com.example.pegapista.ui.screens.home

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.aspectRatio
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.layout.wrapContentHeight
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.pager.HorizontalPager
import androidx.compose.foundation.pager.rememberPagerState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.DeleteOutline
import androidx.compose.material.icons.filled.Favorite
import androidx.compose.material.icons.filled.FavoriteBorder
import androidx.compose.material.icons.filled.MoreVert
import androidx.compose.material.icons.filled.Share
import androidx.compose.material.icons.outlined.ModeComment
import androidx.compose.material.icons.outlined.Search
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.DropdownMenu
import androidx.compose.material3.DropdownMenuItem
import androidx.compose.material3.HorizontalDivider
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import org.koin.androidx.compose.koinViewModel
import coil.compose.AsyncImage
import coil.request.CachePolicy
import coil.request.ImageRequest
import com.example.pegapista.R
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.ui.viewmodels.PostViewModel
import compartilharPost
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.material3.pulltorefresh.PullToRefreshBox
import androidx.compose.material3.pulltorefresh.PullToRefreshDefaults
import androidx.compose.material3.pulltorefresh.rememberPullToRefreshState
import androidx.lifecycle.viewmodel.compose.viewModel
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch

@Composable
fun FeedScreen(
    modifier: Modifier = Modifier.background(Color.White),
    onRankingScreen: () -> Unit,
    onBuscarAmigosScreen: () -> Unit,
    onCommentClick: (Postagem) -> Unit,
    onProfileClick: (String) -> Unit,
    viewModel: PostViewModel = koinViewModel()
) {
    val postagens by viewModel.feedState.collectAsState()
    val meuId = viewModel.meuId
    var showDeleteDialog by remember { mutableStateOf(false) }
    var postDeleteId by remember { mutableStateOf<String?>(null) }

    val pullState = rememberPullToRefreshState()
    var isRefreshing by remember { mutableStateOf(false) }
    val coroutineScope = rememberCoroutineScope()

    val onRefresh: () -> Unit = {
        isRefreshing = true
        coroutineScope.launch {
            delay(1000)
            viewModel.carregarFeed()
            isRefreshing = false
        }
    }


    LaunchedEffect(Unit) {
        viewModel.carregarFeed()
    }

    Column(
        modifier = Modifier.fillMaxSize(),
        verticalArrangement = Arrangement.Center,
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Box(
            modifier = Modifier.height(60.dp).fillMaxWidth()
        ) {
            Text(
                text = "Comunidade",
                modifier = Modifier.align(Alignment.CenterStart).padding(start = 12.dp),
                fontSize = 24.sp,
                color = MaterialTheme.colorScheme.primary,
                fontWeight = FontWeight.Bold
            )
            Row(
                modifier = Modifier
                    .align(Alignment.CenterEnd)
                    .padding(end = 16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "Pesquisar amigos",
                    style = MaterialTheme.typography.labelMedium,
                    color = MaterialTheme.colorScheme.primary,
                    fontSize = 15.sp
                )

                Spacer(modifier = Modifier.width(8.dp))

                IconButton(onClick = { onBuscarAmigosScreen() }) {
                    Icon(
                        imageVector = Icons.Outlined.Search,
                        contentDescription = "Pesquisar Amigos",
                        tint = MaterialTheme.colorScheme.primary
                    )
                }
            }

        }

        Column(
            modifier = modifier
                .fillMaxSize(),
            verticalArrangement = Arrangement.Center,
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                Button(
                    onClick = { viewModel.carregarFeed() },
                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary),
                    shape = RoundedCornerShape(50)
                ) {
                    Text("Feed", color = Color.White, fontWeight = FontWeight.Bold)
                }
                Button(
                    onClick = onRankingScreen,
                    colors = ButtonDefaults.buttonColors(containerColor = Color.White),
                    border = BorderStroke(2.dp, Color.Gray),
                    shape = RoundedCornerShape(50)
                ) {
                    Text(
                        "Ranking",
                        color = MaterialTheme.colorScheme.primary,
                        fontWeight = FontWeight.Bold
                    )
                }
            }
            if (postagens.isEmpty()) {
                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                    Text("Nenhuma corrida ainda...", color = Color.Gray)
                }
            } else {
                PullToRefreshBox(
                    state = pullState,
                    isRefreshing = isRefreshing,
                    onRefresh = onRefresh,
                    modifier = Modifier.fillMaxSize(),
                    indicator = {
                        Box(
                            modifier = Modifier
                                .fillMaxWidth()
                                .wrapContentHeight()
                                .padding(top = 12.dp),
                            contentAlignment = Alignment.TopCenter
                        ) {
                            PullToRefreshDefaults.Indicator(
                                state = pullState,
                                isRefreshing = isRefreshing,
                                containerColor = MaterialTheme.colorScheme.primary,
                                color = Color.White
                            )
                        }
                    }
                ) {
                    LazyColumn(
                        modifier = Modifier.fillMaxSize(),
                        contentPadding = PaddingValues(16.dp),
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        items(postagens) { post ->
                            PostCard(
                                post = post,
                                viewModel = viewModel,
                                data = viewModel.formatarDataHora(post.data),
                                currentUserId = meuId,
                                onLikeClick = {
                                    viewModel.toggleCurtidaPost(post)
                                },
                                onCommentClick = {
                                    onCommentClick(post)
                                },
                                onDeleteClick = { postId ->
                                    showDeleteDialog = true
                                    postDeleteId = postId
                                },
                                onProfileClick = onProfileClick
                            )
                        }
                    }
                }
            }
            if (showDeleteDialog) {
                AlertDialog(
                    onDismissRequest = { showDeleteDialog = false },
                    title = { Text("Excluir atividade?") },
                    text = { Text("Essa ação não pode ser desfeita.") },
                    confirmButton = {
                        TextButton(
                            onClick = {
                                postDeleteId?.let { id ->
                                    viewModel.excluirPost(id)
                                }
                                showDeleteDialog = false
                            },
                            colors = ButtonDefaults.textButtonColors(contentColor = Color.Red)
                        ) { Text("Excluir") }
                    },
                    dismissButton = {
                        TextButton(onClick = { showDeleteDialog = false }) { Text("Cancelar") }
                    }
                )
            }
        }
    }
}

@Composable
fun PostCard(
    post: Postagem,
    viewModel: PostViewModel,
    data: String = "",
    onLikeClick: () -> Unit,
    onCommentClick: (Postagem) -> Unit,
    currentUserId: String?,
    onDeleteClick: (String) -> Unit = {},
    onProfileClick: (String) -> Unit
) {
    val context = LocalContext.current
    val euCurti = post.curtidas.contains(currentUserId)
    val qtdCurtidas = post.curtidas.size
    val qtdComentarios = post.qtdComentarios
    val isUsuario = post.userId == currentUserId

    val listaImagens = post.urlsFotos

    var menuExpandido by remember { mutableStateOf(false) }

    var fotoPerfilUrl by remember { mutableStateOf("") }
    LaunchedEffect(post.userId) {
        val url = viewModel.getFotoPerfil(post.userId)
        if (url != null) {
            fotoPerfilUrl = url
        }
    }
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(10.dp))
            .background(Color.White)
    ) {
        Column (
            modifier = Modifier
                .background(Color.White)
                .padding(10.dp)
                .fillMaxWidth()
        ){
            Row(
                modifier = Modifier.fillMaxWidth()
            ) {
                AsyncImage(
                    model = ImageRequest.Builder(LocalContext.current)
                        .data(fotoPerfilUrl)
                        .crossfade(true)
                        .crossfade(500)
                        .diskCachePolicy(CachePolicy.ENABLED)
                        .memoryCachePolicy(CachePolicy.ENABLED)
                        .build(),
                    contentDescription = "Foto do usuário",
                    modifier = Modifier
                        .size(45.dp)
                        .clip(CircleShape)
                        .border(2.dp, Color.White, CircleShape),
                    contentScale = ContentScale.Crop,
                    placeholder = painterResource(R.drawable.perfil_padrao),
                    error = painterResource(R.drawable.perfil_padrao)
                )
                Spacer(Modifier.width(5.dp))
                Column (
                    modifier = Modifier
                        .weight(1f)
                        .clickable { onProfileClick(post.userId) }
                        .padding(start = 4.dp)
                ){
                    Text(
                        text=post.autorNome,
                        fontWeight = FontWeight.Bold,
                        fontSize = 15.sp,
                        color = Color.DarkGray
                    )
                    Text(
                        text=data,
                        fontSize = 12.sp,
                        color = Color.DarkGray
                    )
                }
                Box {
                    IconButton(onClick = { menuExpandido = true }) {
                        Icon(
                            imageVector = Icons.Default.MoreVert,
                            contentDescription = "Opções",
                            tint = Color.Gray
                        )
                    }

                    DropdownMenu(
                        expanded = menuExpandido,
                        onDismissRequest = { menuExpandido = false },
                        containerColor = Color.White
                    ) { DropdownMenuItem(
                            text = { Text("Compartilhar") },
                            leadingIcon = {
                                Icon(Icons.Default.Share, contentDescription = null)
                            },
                            onClick = {
                                menuExpandido = false
                                compartilharPost(context, post)
                            }
                        )
                        if (isUsuario) {
                            DropdownMenuItem(
                                text = { Text("Excluir") },
                                leadingIcon = {
                                    Icon(Icons.Default.DeleteOutline, contentDescription = null)
                                },
                                onClick = {
                                    menuExpandido = false
                                    onDeleteClick(post.id)
                                }
                            )
                        }
                    }
                }
            }
            Spacer(Modifier.height(15.dp))
            Column {
                Text(
                    text = post.titulo,
                    fontSize = 18.sp,
                    fontWeight = FontWeight.Medium,
                    color = Color.DarkGray
                )
                Spacer(Modifier.height(5.dp))
                Text(
                    text = post.descricao,
                    fontSize = 15.sp,
                    fontWeight = FontWeight.Light,
                    color = Color.DarkGray
                )
                Spacer(Modifier.height(12.dp))
                Row {
                    metadadosCorrida("%.2f km".format(post.corrida.distanciaKm), "Distância")
                    Spacer(Modifier.width(50.dp))
                    metadadosCorrida(post.corrida.tempo, "Tempo")
                    Spacer(Modifier.width(50.dp))
                    metadadosCorrida(post.corrida.pace, "Ritmo")
                }
            }
            Spacer(Modifier.height(15.dp))
            if (listaImagens.isNotEmpty()) {
                val pagerState = rememberPagerState(pageCount = { listaImagens.size })

                Box {
                    HorizontalPager(
                        state = pagerState,
                        modifier = Modifier
                            .fillMaxWidth()
                            .aspectRatio(4f / 4f)
                    ) { page ->
                        AsyncImage(
                            model = listaImagens[page],
                            contentDescription = "Foto da atividade",
                            modifier = Modifier.fillMaxSize(),
                            contentScale = ContentScale.Crop
                        )
                    }

                    if (listaImagens.size > 1) {
                        Row(
                            Modifier
                                .align(Alignment.BottomCenter)
                                .padding(bottom = 10.dp),
                            horizontalArrangement = Arrangement.Center
                        ) {
                            repeat(listaImagens.size) { iteration ->
                                val color = if (pagerState.currentPage == iteration) Color.White else Color.White.copy(alpha = 0.5f)
                                Box(
                                    modifier = Modifier
                                        .padding(3.dp)
                                        .clip(CircleShape)
                                        .background(color)
                                        .size(8.dp)
                                )
                            }
                        }
                    }
                }
            }
            Spacer(Modifier.height(8.dp))
            Row(

            ) {
                IconButton(onClick = onLikeClick) {
                    Icon(
                        imageVector = if (euCurti) {
                            Icons.Filled.Favorite
                        } else {
                            Icons.Filled.FavoriteBorder
                        },
                        contentDescription = "Like",
                        tint = Color.DarkGray
                    )
                }
                Text(
                    text = "$qtdCurtidas",
                    color = Color.DarkGray,
                    modifier = Modifier.align(Alignment.CenterVertically)
                )
                IconButton( onClick = { onCommentClick(post) } ) {
                    Icon(
                        imageVector = Icons.Outlined.ModeComment,
                        contentDescription = "Commentary",
                        tint = Color.DarkGray
                    )
                }
                Text(
                    text = "$qtdComentarios",
                    color = Color.DarkGray,
                    modifier = Modifier.align(Alignment.CenterVertically)
                )
            }
            HorizontalDivider(
                modifier = Modifier.padding(horizontal = 0.dp),
                thickness = 0.8.dp,
                color = MaterialTheme.colorScheme.outlineVariant
            )
        }
       }
}

@Composable
fun metadadosCorrida(dado: String, metadado: String) {
    Column {
        Text(
            text=metadado,
            fontSize = 12.sp,
            color = Color.DarkGray
        )
        Text(
            text=dado,
            fontWeight = FontWeight.Bold,
            fontSize = 18.sp,
            color = Color.DarkGray
        )
    }
}

@Preview(showBackground = true, showSystemUi = true)
@Composable
fun FeedScreenPreview() {
    PegaPistaTheme {
        FeedScreen(onRankingScreen = {}, onBuscarAmigosScreen = {}, onCommentClick = {}, onProfileClick = {})
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/home/HomeScreen.kt ===

package com.example.pegapista.ui.screens.home

import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.AccountCircle
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import coil.compose.AsyncImage
import com.example.pegapista.R
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.ui.viewmodels.PostViewModel
import org.koin.androidx.compose.koinViewModel

@Composable
fun HomeScreen(
    usuario: Usuario?,
    ranking: List<Usuario> = emptyList(),
    atividades: List<Postagem> = emptyList(),
    postviewmodel: PostViewModel = koinViewModel(),
    onIniciarCorrida: () -> Unit
) {
    val scrollState = rememberScrollState()

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.White)
            .verticalScroll(scrollState)
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Card(
            modifier = Modifier.fillMaxWidth(),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.primary)
        ) {
            Row(
                modifier = Modifier.padding(20.dp),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.Center
            ) {
                Image(
                    painter = painterResource(id = R.drawable.logo_fogo),
                    contentDescription = "Foguinho",
                    modifier = Modifier.size(60.dp)
                )
                Spacer(modifier = Modifier.width(16.dp))
                Column {
                    Text(
                        text = "Sua Sequência",
                        color = Color.White.copy(alpha = 0.8f),
                        fontSize = 14.sp
                    )
                    Text(
                        text = "${usuario?.diasSeguidos ?: 0} Dias Seguidos!",
                        color = Color.White,
                        fontSize = 24.sp,
                        fontWeight = FontWeight.ExtraBold
                    )
                }
            }
        }

        Spacer(modifier = Modifier.height(24.dp))

        Text(
            text = "Ranking dos Amigos  🏆",
            modifier = Modifier.fillMaxWidth(),
            fontSize = 18.sp,
            fontWeight = FontWeight.Bold,
            color = Color.Black
        )

        Spacer(modifier = Modifier.height(12.dp))

        if (ranking.isEmpty()) {
            Text(
                "Siga amigos para ver o ranking",
                color = Color.Gray,
                fontSize = 14.sp,
                modifier = Modifier.padding(vertical = 10.dp)
            )
        } else {
            LazyRow(
                modifier = Modifier.fillMaxWidth(),
                contentPadding = PaddingValues(vertical = 8.dp),
                horizontalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                itemsIndexed(ranking) { index, amigo ->
                    CardRankingAmigo(amigo, posicao = index + 1)
                }
            }
        }

        Spacer(modifier = Modifier.height(24.dp))

        Text(
            text = "Últimas Atividades",
            modifier = Modifier.fillMaxWidth(),
            fontSize = 18.sp,
            fontWeight = FontWeight.Bold,
            color = Color.Black
        )

        Spacer(modifier = Modifier.height(12.dp))

        if (atividades.isEmpty()) {
            Text("Nenhuma atividade recente.", color = Color.Gray, fontSize = 14.sp)
        } else {
            atividades.take(3).forEach { post ->
                ItemAtividadeHome(post, postviewmodel)
            }
        }

        Spacer(modifier = Modifier.height(32.dp))

        Button(
            onClick = onIniciarCorrida,
            modifier = Modifier
                .fillMaxWidth()
                .height(56.dp),
            shape = RoundedCornerShape(16.dp),
            colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
        ) {
            Text("INICIAR CORRIDA", fontWeight = FontWeight.ExtraBold, fontSize = 16.sp)
        }

        Spacer(modifier = Modifier.height(20.dp))
    }
}

@Composable
fun CardRankingAmigo(amigo: Usuario, posicao: Int) {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        modifier = Modifier.width(90.dp)
    ) {
        Box(contentAlignment = Alignment.TopEnd) {
            val imageModifier = Modifier
                .size(75.dp)
                .clip(CircleShape)
                .border(2.dp, MaterialTheme.colorScheme.primary, CircleShape)

            if (!amigo.fotoPerfilUrl.isNullOrEmpty()) {
                AsyncImage(
                    model = amigo.fotoPerfilUrl,
                    contentDescription = null,
                    modifier = imageModifier,
                    contentScale = ContentScale.Crop
                )
            } else {
                Image(
                    painter = painterResource(id = R.drawable.perfil_padrao),
                    contentDescription = null,
                    modifier = imageModifier,
                    contentScale = ContentScale.Crop
                )
            }

            Surface(
                color = MaterialTheme.colorScheme.secondary,
                shape = CircleShape,
                modifier = Modifier
                    .size(26.dp)
                    .offset(x = 4.dp, y = (-4).dp)
            ) {
                Text(
                    text = "$posicao",
                    color = Color.White,
                    fontSize = 13.sp,
                    fontWeight = FontWeight.Bold,
                    textAlign = TextAlign.Center,
                    modifier = Modifier.wrapContentHeight()
                )
            }
        }

        Spacer(modifier = Modifier.height(8.dp))

        Text(
            text = amigo.nickname,
            fontSize = 13.sp,
            fontWeight = FontWeight.Bold,
            maxLines = 1,
            overflow = TextOverflow.Ellipsis,
            textAlign = TextAlign.Center
        )

        Row(verticalAlignment = Alignment.CenterVertically) {
            Text(
                text = "${amigo.diasSeguidos}",
                fontSize = 12.sp,
                fontWeight = FontWeight.ExtraBold,
                color = Color.DarkGray
            )
            Spacer(modifier = Modifier.width(2.dp))
            Image(
                painter = painterResource(R.drawable.logo_fogo),
                contentDescription = null,
                modifier = Modifier.size(14.dp)
            )
        }
    }
}

@Composable
fun ItemAtividadeHome(post: Postagem, postviewModel: PostViewModel) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(vertical = 6.dp),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(containerColor = Color(0xFFF5F5F5))
    ) {
        Row(
            modifier = Modifier.padding(12.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            var fotoPerfilUrl by remember { mutableStateOf<String?>(null) }

            LaunchedEffect(post.userId) {
                val url = postviewModel.getFotoPerfil(post.userId)
                fotoPerfilUrl = url
            }

            if (!fotoPerfilUrl.isNullOrEmpty()) {
                AsyncImage(
                    model = fotoPerfilUrl,
                    contentDescription = "Foto de perfil",
                    modifier = Modifier
                        .size(40.dp)
                        .clip(CircleShape)
                        .border(1.dp, Color.LightGray, CircleShape),
                    contentScale = ContentScale.Crop
                )
            } else {
                Image(
                    painter = painterResource(id = R.drawable.perfil_padrao),
                    contentDescription = "Foto padrão",
                    modifier = Modifier
                        .size(40.dp)
                        .clip(CircleShape),
                    contentScale = ContentScale.Crop
                )
            }

            Spacer(modifier = Modifier.width(12.dp))

            Column {
                Text(text = post.autorNome, fontWeight = FontWeight.Bold, fontSize = 14.sp)

                val distanciaFormatada = "%.2f".format(post.corrida.distanciaKm)

                Text(
                    text = "${distanciaFormatada}km em ${post.corrida.tempo}",
                    fontSize = 12.sp,
                    color = Color.DarkGray
                )
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/perfil/BuscarAmigosScreen.kt ===

package com.example.pegapista.ui.screens.perfil

import android.media.Image
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.imePadding
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.outlined.Search
import androidx.compose.material3.Card
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.HorizontalDivider
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import coil.compose.AsyncImage
import coil.request.CachePolicy
import coil.request.ImageRequest
import com.example.pegapista.R
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.ui.viewmodels.BuscaViewModel


@Composable
fun BuscarAmigosScreen(
    modifier: Modifier = Modifier.background(Color.White),
    viewModel: BuscaViewModel = viewModel(),
    onPerfilUsuarioScreen: (idUsuario: String) -> Unit
) {
    val textoBusca by viewModel.textoBusca.collectAsState()
    val usuariosEncontrados by viewModel.resultados.collectAsState()
    val isLoading by viewModel.isLoading.collectAsState()

    Column(
        modifier = modifier
            .fillMaxSize()
            .imePadding()
    ) {
        Column(
            modifier = Modifier.padding(horizontal = 0.dp)
        ) {
            Text (
                text = "Buscar Amigos",
                modifier = Modifier.padding(12.dp),
                fontSize = 24.sp,
                color = MaterialTheme.colorScheme.primary,
                fontWeight = FontWeight.Bold
            )
            HorizontalDivider(
                modifier = Modifier.padding(horizontal = 0.dp),
                thickness = 0.5.dp,
                color = MaterialTheme.colorScheme.outlineVariant
            )
            Spacer(modifier = Modifier.height(20.dp))
            Row {
                OutlinedTextField(
                    value = textoBusca,
                    onValueChange = { viewModel.atualizarBusca(it) },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp),
                    placeholder = { Text("Digite o nome do atleta...") },
                    leadingIcon = {
                        Icon(
                            imageVector = Icons.Outlined.Search,
                            contentDescription = "Pesquisar",
                            tint = MaterialTheme.colorScheme.primary
                        )
                    },
                    singleLine = true,
                    shape = MaterialTheme.shapes.medium
                )
            }
            Spacer(modifier = Modifier.height(25.dp))

            Text(
                text = if (textoBusca.isBlank()) "Sugestões para você" else "Resultados",
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold,
                color = Color.Gray,
                modifier = Modifier.padding(start = 16.dp, bottom = 8.dp)
            )
        }

        if (isLoading) {
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(1f),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator()
            }
        } else {
            LazyColumn(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(1f),
                contentPadding = PaddingValues(bottom = 80.dp)
            ) {
                if (usuariosEncontrados.isEmpty() && textoBusca.isNotEmpty()) {
                    item {
                        Text(
                            text = "Nenhum usuário encontrado.",
                            modifier = Modifier.padding(16.dp),
                            color = Color.Gray
                        )
                    }
                }

                items(usuariosEncontrados) { usuario ->
                    CardUsuario(usuario, onPerfilUsuarioScreen, viewModel)
                }
            }
        }
    }
}

@Composable
fun CardUsuario(
    usuario: Usuario,
    onPerfilUsuarioScreen: (String) -> Unit,
    viewModel: BuscaViewModel
) {
    var fotoPerfilUrl by remember { mutableStateOf("") }

    LaunchedEffect(usuario.id) {
        val url = viewModel.getFotoPerfil(usuario.id)
        if (url != null) {
            fotoPerfilUrl = url
        }
    }
    Card (
        modifier = Modifier,
        onClick = { onPerfilUsuarioScreen(usuario.id) }
    ) {
        Row (
            modifier = Modifier.fillMaxWidth().background(Color.White)
        ) {
            Spacer(Modifier.width(10.dp))
            AsyncImage(
                model = ImageRequest.Builder(LocalContext.current)
                    .data(fotoPerfilUrl)
                    .crossfade(true)
                    .crossfade(500)
                    .diskCachePolicy(CachePolicy.ENABLED)
                    .memoryCachePolicy(CachePolicy.ENABLED)
                    .build(),
                contentDescription = "Foto do usuário",
                modifier = Modifier
                    .size(50.dp)
                    .clip(CircleShape)
                    .border(2.dp, Color.White, CircleShape),
                placeholder = painterResource(R.drawable.perfil_padrao),
                error = painterResource(R.drawable.perfil_padrao)
            )
            Spacer(Modifier.width(10.dp))
            Text(
                text = usuario.nickname,
                fontSize = 18.sp,
                modifier = Modifier.align(Alignment.CenterVertically)
            )
        }
    }
    Spacer(Modifier.height(15.dp))
}

@Preview
@Composable
fun BuscarAmigosScreenPreview() {
    PegaPistaTheme {
        BuscarAmigosScreen(onPerfilUsuarioScreen = {})
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/perfil/PerfilScreen.kt ===

package com.example.pegapista.ui.screens.perfil

import android.Manifest
import android.content.Context
import android.net.Uri
import android.os.Build
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.PickVisualMediaRequest
import androidx.activity.result.contract.ActivityResultContracts
import androidx.annotation.RequiresApi
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ExitToApp
import androidx.compose.material.icons.filled.CameraAlt
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.core.content.FileProvider
import coil.compose.AsyncImage
import coil.request.CachePolicy
import coil.request.ImageRequest
import com.example.pegapista.R
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.ui.viewmodels.PerfilUsuarioViewModel
import com.example.pegapista.ui.viewmodels.PerfilViewModel
import com.example.pegapista.ui.viewmodels.PostViewModel
import org.koin.androidx.compose.koinViewModel
import java.io.File
import androidx.compose.runtime.collectAsState
import com.example.pegapista.data.models.Postagem
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.material3.pulltorefresh.PullToRefreshBox
import androidx.compose.material3.pulltorefresh.PullToRefreshDefaults
import androidx.compose.material3.pulltorefresh.rememberPullToRefreshState
import com.example.pegapista.ui.screens.home.PostCard
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun PerfilScreen(
    onDeslogar: () -> Unit,
    onCommentClick: (Postagem, String?) -> Unit,
    onSeguidoresClick: (String?) -> Unit,
    onSeguindoClick: (String?) -> Unit,
    viewModel: PerfilViewModel = koinViewModel(),
    perfilviewModel: PerfilUsuarioViewModel = koinViewModel(),
    postsviewModel: PostViewModel = koinViewModel()
) {

    val usuario by viewModel.userState.collectAsState()
    val meuId = usuario?.id
    val posts = perfilviewModel.postsUsuario.collectAsState().value

    var showDeleteDialog by remember { mutableStateOf(false) }
    var postDeleteId by remember { mutableStateOf<String?>(null) }

    LaunchedEffect(meuId) {
        if (meuId != null) {
            perfilviewModel.carregarPerfilUsuario(meuId)
        }
    }
    val pullState = rememberPullToRefreshState()
    var isRefreshing by remember { mutableStateOf(false) }
    val coroutineScope = rememberCoroutineScope()

    val onRefresh: () -> Unit = {
        isRefreshing = true
        coroutineScope.launch {
            delay(1000)
            viewModel.carregarPerfil()
            isRefreshing = false
        }
    }
    LaunchedEffect(Unit) {
        viewModel.carregarPerfil()
    }
    PullToRefreshBox(
        state = pullState,
        isRefreshing = isRefreshing,
        onRefresh = onRefresh,
        modifier = Modifier.fillMaxSize(),
        indicator = {
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .wrapContentHeight()
                    .padding(top = 12.dp),
                contentAlignment = Alignment.TopCenter
            ) {
                PullToRefreshDefaults.Indicator(
                    state = pullState,
                    isRefreshing = isRefreshing,
                    containerColor = Color.White,
                    color = MaterialTheme.colorScheme.primary
                )
            }
        }
    ) {
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.primary)
                .padding(20.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {

            item {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.End
                ) {
                    IconButton(onClick = {
                        viewModel.deslogar()
                        onDeslogar()
                    }) {
                        Icon(
                            imageVector = Icons.AutoMirrored.Filled.ExitToApp,
                            contentDescription = "Sair",
                            tint = Color.White
                        )
                    }
                }
            }

            item {
                TopPerfil(usuario, viewModel)
                Spacer(Modifier.height(5.dp))
                MetadadosUsuarioPerfil(
                    user = usuario,
                    onSeguidoresClick = { onSeguidoresClick(usuario?.id) },
                    onSeguindoClick = { onSeguindoClick(usuario?.id) }
                )
                Spacer(Modifier.height(20.dp))
            }

            if (posts.isNotEmpty()) {
                item {
                    Text(
                        text = "Atividades Recentes",
                        color = Color.White,
                        fontSize = 18.sp,
                        fontWeight = FontWeight.Bold
                    )
                }

                items(posts) { post ->
                    Box(modifier = Modifier.padding(vertical = 8.dp)) {
                        PostCard(
                            post = post,
                            viewModel = postsviewModel,
                            data = postsviewModel.formatarDataHora(post.data),
                            currentUserId = usuario?.id,
                            onLikeClick = {
                                postsviewModel.toggleCurtidaPost(post)
                                perfilviewModel.atualizarLikeNoPostLocal(post.id, usuario?.id ?: "")
                            },
                            onCommentClick = {
                                onCommentClick(post, usuario?.id )
                            },
                            onDeleteClick = { postId ->
                                showDeleteDialog = true
                                postDeleteId = postId
                            },
                            onProfileClick = {}
                        )
                    }
                }
            } else {
                item {
                    Text(
                        text = "Nenhuma atividade ainda.",
                        color = Color.White.copy(alpha = 0.7f),
                        fontSize = 14.sp
                    )
                }
            }
        }
        if (showDeleteDialog) {
            AlertDialog(
                onDismissRequest = { showDeleteDialog = false },
                title = { Text("Excluir atividade?") },
                text = { Text("Essa ação não pode ser desfeita.") },
                confirmButton = {
                    TextButton(
                        onClick = {
                            postDeleteId?.let { id ->
                                postsviewModel.excluirPost(id)
                                perfilviewModel.removerPostLocalmente(id)
                            }
                            showDeleteDialog = false
                        },
                        colors = ButtonDefaults.textButtonColors(contentColor = Color.Red)
                    ) { Text("Excluir") }
                },
                dismissButton = {
                    TextButton(onClick = { showDeleteDialog = false }) { Text("Cancelar") }
                }
            )
        }
    }
}



@Composable
fun TopPerfil(
    user: Usuario?,
    viewModel: PerfilViewModel
) {
    val context = LocalContext.current
    var mostrarOpcoes by remember { mutableStateOf(false) }
    var uriTemporaria by remember { mutableStateOf<Uri?>(null) }


    val galeriaLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.PickVisualMedia()
    ) { uri ->
        if (uri != null) viewModel.atualizarFotoPerfil(uri, context)
    }

    val cameraLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.TakePicture()
    ) { sucesso ->
        if (sucesso && uriTemporaria != null) {
            viewModel.atualizarFotoPerfil(uriTemporaria!!, context)
        }
    }

    val permissaoLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { aceitou ->
        if (aceitou) {
            uriTemporaria = criarUriParaFoto(context)
            cameraLauncher.launch(uriTemporaria!!)
        } else {
            Toast.makeText(context, "Permissão necessária para câmera", Toast.LENGTH_SHORT).show()
        }
    }

    Column(
        modifier = Modifier.padding(top = 10.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Box(contentAlignment = Alignment.BottomEnd) {
            val foto = user?.fotoPerfilUrl
            if (!foto.isNullOrEmpty()) {
                AsyncImage(
                    model = ImageRequest.Builder(LocalContext.current)
                        .data(foto)
                        .crossfade(true)
                        .crossfade(500)
                        .diskCachePolicy(CachePolicy.ENABLED)
                        .memoryCachePolicy(CachePolicy.ENABLED)
                        .build(),
                    contentDescription = "Foto do usuário",
                    modifier = Modifier
                        .size(125.dp)
                        .clip(CircleShape)
                        .border(5.dp, Color.White, CircleShape),
                    contentScale = ContentScale.Crop,
                    placeholder = painterResource(R.drawable.perfil_padrao),
                    error = painterResource(R.drawable.perfil_padrao)
                )
            } else {
                Image(
                    painterResource(R.drawable.perfil_padrao),
                    contentDescription = "Foto padrão",
                    modifier = Modifier
                        .size(125.dp)
                        .clip(CircleShape)
                        .border(5.dp, Color.White, CircleShape),
                    contentScale = ContentScale.Crop
                )
            }


            Box(
                modifier = Modifier
                    .offset(x = 5.dp, y = 5.dp)
                    .size(40.dp)
                    .clip(CircleShape)
                    .background(MaterialTheme.colorScheme.secondary)
                    .border(2.dp, Color.White, CircleShape)
                    .clickable { mostrarOpcoes = true },
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = Icons.Default.CameraAlt,
                    contentDescription = "Alterar foto",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
            }
        }

        Spacer(Modifier.height(10.dp))
        Text(
            text = user?.nickname.orEmpty(),
            fontSize = 25.sp,
            fontWeight = FontWeight.SemiBold,
            color = Color.White
        )
    }

    if (mostrarOpcoes) {
        AlertDialog(
            onDismissRequest = { mostrarOpcoes = false },
            title = { Text("Alterar Foto de Perfil") },
            text = { Text("Como você deseja enviar a foto?") },
            confirmButton = {
                TextButton(onClick = {
                    mostrarOpcoes = false
                    galeriaLauncher.launch(
                        PickVisualMediaRequest(ActivityResultContracts.PickVisualMedia.ImageOnly)
                    )
                }) {
                    Text("Galeria")
                }
            },
            dismissButton = {
                TextButton(onClick = {
                    mostrarOpcoes = false
                    permissaoLauncher.launch(Manifest.permission.CAMERA)
                }) {
                    Text("Câmera")
                }
            }
        )
    }
}

@Composable
fun BoxText(metadata: String, data: String) {
    Box(
        modifier = Modifier
            .padding(10.dp)
            .size(120.dp)
            .shadow(
                elevation = 5.dp,
                shape = RoundedCornerShape(10.dp)
            )
            .background(Color.White)
            .clip(RoundedCornerShape(10.dp))
    ) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(4.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            Text(
                text = metadata,
                textAlign = TextAlign.Center,
                fontWeight = FontWeight.W500,
                fontSize = 14.sp,
                modifier = Modifier.fillMaxWidth()
            )
            Spacer(Modifier.height(5.dp))
            Text(
                text = data,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.primary,
                fontWeight = FontWeight.Medium,
                modifier = Modifier.fillMaxWidth()
            )
        }
    }
}

fun formatarHoras(segundos: Long): String {
    val horas = segundos / 3600
    val minutos = (segundos % 3600) / 60
    return "%dh %02dm".format(horas, minutos)
}


fun criarUriParaFoto(context: Context): Uri {
    val arquivo = File.createTempFile(
        "foto_perfil_",
        ".jpg",
        context.cacheDir
    ).apply {
        createNewFile()
        deleteOnExit()
    }
    return FileProvider.getUriForFile(
        context,
        "${context.packageName}.provider",
        arquivo
    )
}


/*@Preview(showBackground = true, showSystemUi = true)
@Composable
fun PerfilScreenPreview() {
    PegaPistaTheme {
        //PerfilScreen(onDeslogar = {})
    }
}
*/


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/perfil/ListaUsuarioScreen.kt ===

package com.example.pegapista.ui.screens.perfil

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import coil.compose.AsyncImage
import coil.request.ImageRequest
import com.example.pegapista.R
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.ui.viewmodels.ListaUsuariosViewModel

@Composable
fun ListaUsuariosScreen(
    titulo: String,
    idUsuarioAlvo: String,
    tipoLista: String,
    onVoltar: () -> Unit,
    onUsuarioClick: (String) -> Unit,
    viewModel: ListaUsuariosViewModel = viewModel()
) {
    val listaUsuarios by viewModel.listaUsuarios.collectAsState()
    val isLoading by viewModel.isLoading.collectAsState()

    LaunchedEffect(Unit) {
        viewModel.carregarLista(idUsuarioAlvo, tipoLista)
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.primary)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(onClick = onVoltar) {
                Icon(Icons.Default.ArrowBack, contentDescription = "Voltar", tint = Color.White)
            }
            Text(
                text = titulo,
                fontSize = 22.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White,
                modifier = Modifier.padding(start = 8.dp)
            )
        }

        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(Color.White, RoundedCornerShape(topStart = 30.dp, topEnd = 30.dp))
                .padding(top = 16.dp)
        ) {
            if (isLoading) {
                CircularProgressIndicator(modifier = Modifier.align(Alignment.Center))
            } else if (listaUsuarios.isEmpty()) {
                Text(
                    text = "Nenhum usuário encontrado.",
                    color = Color.Gray,
                    modifier = Modifier.align(Alignment.Center)
                )
            } else {
                LazyColumn(contentPadding = PaddingValues(16.dp)) {
                    items(listaUsuarios) { usuario ->
                        UsuarioItemCard(usuario = usuario, onClick = { onUsuarioClick(usuario.id) })
                        Spacer(modifier = Modifier.height(12.dp))
                    }
                }
            }
        }
    }
}

@Composable
fun UsuarioItemCard(usuario: Usuario, onClick: () -> Unit) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(12.dp))
            .background(Color(0xFFF5F5F5))
            .clickable { onClick() }
            .padding(12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        AsyncImage(
            model = ImageRequest.Builder(LocalContext.current)
                .data(usuario.fotoPerfilUrl)
                .crossfade(true)
                .build(),
            contentDescription = "Foto",
            placeholder = painterResource(R.drawable.perfil_padrao),
            error = painterResource(R.drawable.perfil_padrao),
            modifier = Modifier
                .size(50.dp)
                .clip(CircleShape)
        )

        Spacer(modifier = Modifier.width(16.dp))

        Column {
            Text(
                text = usuario.nickname,
                fontWeight = FontWeight.Bold,
                fontSize = 16.sp,
                color = Color.Black
            )
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/perfil/PerfilUsuarioScreen.kt ===

package com.example.pegapista.ui.screens.perfil

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import coil.compose.AsyncImage
import coil.request.CachePolicy
import coil.request.ImageRequest
import org.koin.androidx.compose.koinViewModel
import com.example.pegapista.R
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.ui.screens.home.PostCard
import com.example.pegapista.ui.viewmodels.PerfilUsuarioViewModel
import com.example.pegapista.ui.viewmodels.PostViewModel
import kotlin.let

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun PerfilUsuarioScreen(
    modifier: Modifier = Modifier.background(Color.White),
    viewModel: PerfilUsuarioViewModel = koinViewModel(),
    postsviewModel: PostViewModel = koinViewModel(),
    onCommentClick: (Postagem) -> Unit,
    onSeguidoresClick: (String) -> Unit,
    onSeguindoClick: (String) -> Unit,
    idUsuario: String = ""
) {
    val usuario by viewModel.userState.collectAsState()
    val postagens by postsviewModel.feedState.collectAsState()
    val scrollState = rememberScrollState()
    val isSeguindo by viewModel.isSeguindo.collectAsState()
    val posts by viewModel.postsUsuario.collectAsState()
    val meuId = postsviewModel.meuId

    LaunchedEffect(idUsuario) {
        viewModel.carregarPerfilUsuario(idUsuario)
    }
    LazyColumn(
        modifier = modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.primary),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        item {
            Spacer(modifier = Modifier.height(35.dp))
            TopUsuarioPerfil(usuario)
        }
        item {
            Spacer(modifier = Modifier.height(5.dp))
            MetadadosUsuarioPerfil(
                user = usuario,
                onSeguidoresClick = { onSeguidoresClick(usuario.id) },
                onSeguindoClick = { onSeguindoClick(usuario.id) }
                )
        }
        if (usuario.id!=meuId) {
            item {
                Spacer(Modifier.height(30.dp))
                Button(
                    onClick = { viewModel.toggleSeguir() },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = if (isSeguindo) Color.White else Color(0xFF0FDC52),
                        contentColor = if (isSeguindo) MaterialTheme.colorScheme.primary else Color.White
                    ),
                    shape = RoundedCornerShape(50),
                    modifier = Modifier
                        .width(200.dp)
                        .height(50.dp)
                ) {
                    Text(
                        text = if (isSeguindo) "Seguindo ✓" else "Seguir",
                        fontWeight = FontWeight.Bold,
                        fontSize = 16.sp
                    )
                }
            }
        }

        item {
            Spacer(Modifier.height(20.dp))
            if (posts.isNotEmpty()) {
                Spacer(Modifier.height(20.dp))
                Text(
                    text = "Atividades Recentes",
                    color = Color.White,
                    fontSize = 18.sp,
                    fontWeight = FontWeight.Bold,
                    modifier = Modifier.padding(bottom = 10.dp)
                )
            } else {
                Text(
                    text = "Nenhuma atividade ainda.",
                    color = Color.White.copy(alpha = 0.7f),
                    fontSize = 14.sp
                )
            }
        }

        items(posts) { post ->
            Box(modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)) {
                PostCard(
                    post = post,
                    data = postsviewModel.formatarDataHora(post.data),
                    viewModel = postsviewModel,
                    currentUserId = meuId,
                    onLikeClick = {
                        postsviewModel.toggleCurtidaPost(post)
                        viewModel.atualizarLikeNoPostLocal(post.id, meuId ?: "")
                    },
                    onCommentClick = {
                        onCommentClick(post)
                    },
                    onProfileClick = {}
                    )
            }
        }

        item {
            Spacer(Modifier.height(50.dp))
        }
    }
    }


@Composable
fun TopUsuarioPerfil(user: Usuario) {
    Column (
        modifier = Modifier
            .padding(top = 15.dp),
        verticalArrangement = Arrangement.Top,
        horizontalAlignment = Alignment.CenterHorizontally
    ){
        AsyncImage(
            model = ImageRequest.Builder(LocalContext.current)
                .data(user.fotoPerfilUrl)
                .crossfade(true)
                .crossfade(500)
                .diskCachePolicy(CachePolicy.ENABLED)
                .memoryCachePolicy(CachePolicy.ENABLED)
                .build(),
            contentDescription = "Foto do usuário",
            modifier = Modifier
                .size(125.dp)
                .clip(CircleShape)
                .border(5.dp, Color.White, CircleShape),
            placeholder = painterResource(R.drawable.perfil_padrao),
            error = painterResource(R.drawable.perfil_padrao)
        )
        Spacer(Modifier.height(5.dp))
        Text(
            user.nickname,
            fontSize = 25.sp,
            fontWeight = FontWeight.SemiBold,
            color = Color.White
        )
    }
}

@Composable
fun MetadadosUsuarioPerfil(
    user: Usuario?,
    onSeguidoresClick: () -> Unit,
    onSeguindoClick: () -> Unit
) {
    val distanciaKm = user?.distanciaTotalKm ?: 0.0
    val tempoSegundos = user?.tempoTotalSegundos ?: 0L

    val distFormatada = "%.1f km".format(distanciaKm)
    val tempoFormatado = formatarUsuarioHoras(tempoSegundos)

    val ritmoMedio = if (distanciaKm > 0 && tempoSegundos > 0) {
        val minutosTotais = tempoSegundos / 60.0
        val pace = minutosTotais / distanciaKm
        "%.2f min/km".format(pace)
    } else {
        "0:00 min/km"
    }


    Column (
        modifier = Modifier.fillMaxWidth(),
        horizontalAlignment = Alignment.CenterHorizontally
    ){
        Spacer(Modifier.height(15.dp))
        Row (
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceEvenly
        ){
            Column (modifier = Modifier.clickable { onSeguidoresClick() }) {
                Text(
                    text = "Seguidores",
                    fontSize = 20.sp,
                    fontWeight = FontWeight.Normal,
                    color = Color.White
                )
                Text(
                    text = "${user?.seguidores}",
                    fontSize = 20.sp,
                    fontWeight = FontWeight.ExtraBold,
                    color = Color.White
                )
            }
            Spacer(Modifier.width(40.dp))
            Column (modifier = Modifier.clickable { onSeguindoClick() }){
                Text(
                    text = "Seguindo",
                    fontSize = 20.sp,
                    fontWeight = FontWeight.Normal,
                    color = Color.White
                )
                Text(
                    text = "${user?.seguindo}",
                    fontSize = 20.sp,
                    fontWeight = FontWeight.ExtraBold,
                    color = Color.White
                )
            }
        }
        Spacer(Modifier.height(10.dp))
        Text(
            text = "${user?.diasSeguidos} dias!",
            fontSize = 20.sp,
            fontWeight = FontWeight.ExtraBold,
            color = Color.White
        )
        Spacer(Modifier.height(10.dp))
        Box(modifier = Modifier
            .padding(horizontal = 35.dp)
            .fillMaxWidth()
            .shadow(
                elevation = 5.dp,
                shape = RoundedCornerShape(10.dp)
            )
            .background(Color.White)
            .clip(RoundedCornerShape(10.dp))
        ) {
            Text(
                text = "Seu recorde foi de ${user?.recordeDiasSeguidos} dias seguidos!",
                textAlign = TextAlign.Center,
                fontWeight = FontWeight.W500,
                modifier = Modifier.fillMaxWidth()
                    .padding(10.dp)
            )
        }
        Spacer(Modifier.height(35.dp))
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceEvenly
        ) {
            BoxUsuarioText("Distância Total", distFormatada)
            BoxUsuarioText("Tempo Total", tempoFormatado)
        }


        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceEvenly
        ) {
            BoxUsuarioText("Tempo Ritmo", ritmoMedio)
            BoxUsuarioText("Calorias Queimadas", "${user?.caloriasQueimadas} kcal")
        }
    }
}

@Composable
fun BoxUsuarioText(metadata: String, data: String) {
    Box(modifier = Modifier
        .padding(10.dp)
        .size(120.dp)
        .shadow(
            elevation = 5.dp,
            shape = RoundedCornerShape(10.dp)
        )
        .background(Color.White)
        .clip(RoundedCornerShape(10.dp))
    ) {

        Column (modifier = Modifier.fillMaxSize().padding(4.dp),

            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center){
            Text(
                text = metadata,
                textAlign = TextAlign.Center,
                fontWeight = FontWeight.W500,
                fontSize = 12.sp,
                modifier = Modifier.fillMaxWidth()
            )
            Spacer(Modifier.height(5.dp))
            Text(
                text = data,
                textAlign = TextAlign.Center,
                color = MaterialTheme.colorScheme.primary,
                fontWeight = FontWeight.Medium,
                modifier = Modifier.fillMaxWidth()
            )
        }

    }
}


fun formatarUsuarioHoras(segundos: Long?): String {
    val horas = segundos?.div(3600)
    val minutos = (segundos?.rem(3600))?.div(60)
    return "%dh %02dm".format(horas, minutos)
}

/*
@Preview(showBackground = true, showSystemUi = true)
@Composable
fun PerfilUsuarioScreenPreview() {
    PegaPistaTheme {
        PerfilUsuarioScreen()
    }
}
 */

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/social/NotificacoesScreen.kt ===

package com.example.pegapista.ui.screens.social

import androidx.compose.animation.animateColorAsState
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Delete
import androidx.compose.material.icons.filled.DeleteSweep
import androidx.compose.material.icons.filled.EmojiEvents
import androidx.compose.material.icons.filled.ModeComment
import androidx.compose.material.icons.filled.Notifications
import androidx.compose.material.icons.filled.PersonAdd
import androidx.compose.material.icons.filled.ThumbUp
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.pegapista.data.models.Notificacao
import com.example.pegapista.data.models.TipoNotificacao
import com.example.pegapista.ui.viewmodels.NotificationsViewModel
import java.util.concurrent.TimeUnit

@Composable
fun NotificacoesScreen(
    modifier: Modifier = Modifier,
    viewModel: NotificationsViewModel = viewModel()
) {
    val listaNotificacoes by viewModel.notificacoes.collectAsState()
    LaunchedEffect(Unit) {
        viewModel.carregarNotificacoes()
    }

    Column(
        modifier = modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.background)
            .padding(10.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {

        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(bottom = 15.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "Notificações",
                fontSize = 22.sp,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.primary
            )

            if (listaNotificacoes.isNotEmpty()) {
                TextButton(onClick = { viewModel.limparTudo() }) {
                    Text(
                        text = "Limpar Todas",
                        style = MaterialTheme.typography.labelMedium,
                        color = MaterialTheme.colorScheme.primary,
                        fontSize = 15.sp
                    )
                }
            }
        }

        Column(
            modifier = Modifier
                .fillMaxWidth()
                .weight(1f)
                .background(
                    color = MaterialTheme.colorScheme.primary,
                    shape = RoundedCornerShape(20.dp)
                )
                .padding(horizontal = 20.dp, vertical = 20.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {

            if (listaNotificacoes.isEmpty()) {
                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                    Text(
                        text = "Nenhuma notificação ainda.",
                        color = Color.White.copy(alpha = 0.7f)
                    )
                }
            } else {
                LazyColumn(
                    modifier = Modifier.fillMaxSize(),
                    verticalArrangement = Arrangement.spacedBy(15.dp)
                ) {
                    items(
                        items = listaNotificacoes,
                        key = { it.id }
                    ) { item ->
                        SwipeToDeleteContainer(
                            item = item,
                            onDelete = { viewModel.excluirNotificacao(item.id) }
                        )
                    }
                }
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SwipeToDeleteContainer(
    item: Notificacao,
    onDelete: () -> Unit
) {
    val dismissState = rememberSwipeToDismissBoxState(
        confirmValueChange = {
            if (it == SwipeToDismissBoxValue.EndToStart || it == SwipeToDismissBoxValue.StartToEnd) {
                onDelete()
                true
            } else {
                false
            }
        }
    )

    SwipeToDismissBox(
        state = dismissState,
        backgroundContent = {
            val color by animateColorAsState(
                if (dismissState.targetValue == SwipeToDismissBoxValue.Settled) Color.Transparent else Color.Red
            )
            Box(
                Modifier
                    .fillMaxSize()
                    .background(color, RoundedCornerShape(15.dp))
                    .padding(horizontal = 20.dp),
                contentAlignment = Alignment.CenterEnd
            ) {
                Icon(
                    Icons.Default.Delete,
                    contentDescription = "Excluir",
                    tint = Color.White
                )
            }
        },
        content = {
            Box() {
                NotificacaoItem(notificacao = item)
            }
        }
    )
}

@Composable
fun NotificacaoItem(notificacao: Notificacao) {
    val (icon, tituloPadrao) = when (notificacao.tipo) {
        TipoNotificacao.SEGUIR -> Pair(Icons.Default.PersonAdd, "Novo Seguidor")
        TipoNotificacao.CURTIDA -> Pair(Icons.Default.ThumbUp, "Curtida")
        TipoNotificacao.COMENTARIO -> Pair(Icons.Default.ModeComment, "Comentário")
        else -> Pair(Icons.Default.Notifications, "Aviso")
    }

    val tempoRelativo = calcularTempoRelativo(notificacao.data)

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .height(85.dp),
        shape = RoundedCornerShape(15.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (notificacao.lida) MaterialTheme.colorScheme.surface else Color(0xFFEDF7FF) // Leve destaque se não lida
        ),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxSize()
                .padding(10.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Box(
                modifier = Modifier
                    .size(50.dp)
                    .clip(CircleShape)
                    .background(MaterialTheme.colorScheme.primary.copy(alpha = 0.1f)),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = icon,
                    contentDescription = null,
                    tint = MaterialTheme.colorScheme.primary,
                    modifier = Modifier.size(24.dp)
                )
            }
            Spacer(modifier = Modifier.width(12.dp))

            Column(
                modifier = Modifier.weight(1f),
                verticalArrangement = Arrangement.Center
            ) {
                Text(
                    text = tituloPadrao,
                    fontWeight = FontWeight.Bold,
                    fontSize = 17.sp,
                    color = MaterialTheme.colorScheme.primary
                )
                Spacer(Modifier.height(3.dp))
                Text(
                    text = notificacao.mensagem,
                    fontSize = 13.sp,
                    lineHeight = 14.sp,
                    color = MaterialTheme.colorScheme.primary.copy(alpha = 0.8f),
                    maxLines = 2
                )
            }

            Column(
                verticalArrangement = Arrangement.Bottom,
                horizontalAlignment = Alignment.End,
                modifier = Modifier.fillMaxHeight()
            ) {
                Spacer(modifier = Modifier.weight(1f))
                Text(
                    text = tempoRelativo,
                    fontSize = 12.sp,
                    color = Color.Gray
                )
            }
        }
    }
}

fun calcularTempoRelativo(timestamp: Long): String {
    val agora = System.currentTimeMillis()
    val diff = agora - timestamp

    return when {
        diff < TimeUnit.MINUTES.toMillis(1) -> "Agora"
        diff < TimeUnit.HOURS.toMillis(1) -> "Há ${TimeUnit.MILLISECONDS.toMinutes(diff)} min"
        diff < TimeUnit.DAYS.toMillis(1) -> "Há ${TimeUnit.MILLISECONDS.toHours(diff)} h"
        diff < TimeUnit.DAYS.toMillis(7) -> "Há ${TimeUnit.MILLISECONDS.toDays(diff)} dias"
        else -> {
            val sdf = java.text.SimpleDateFormat("dd/MM", java.util.Locale.getDefault())
            sdf.format(java.util.Date(timestamp))
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/social/RankingScreen.kt ===

package com.example.pegapista.ui.screens.social

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.AccountCircle
import androidx.compose.material.icons.outlined.Search
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.IconButton
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.isEmpty
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.runtime.getValue
import androidx.compose.ui.draw.clip
import androidx.compose.ui.platform.LocalContext
import com.example.pegapista.R
import androidx.lifecycle.viewmodel.compose.viewModel
import coil.compose.AsyncImage
import coil.request.CachePolicy
import coil.request.ImageRequest
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.ui.viewmodels.RankingViewModel

@Composable
fun RankingScreen(
    modifier: Modifier = Modifier.background(Color.White),
    onFeedScreen: () -> Unit,
    onBuscarAmigosScreen: () -> Unit,
    viewModel: RankingViewModel = viewModel()
){
    val ranking by viewModel.ranking.collectAsState()
    Column(
        modifier = modifier.fillMaxSize().background(Color.White),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Box(
            modifier = Modifier
                .height(60.dp)
                .fillMaxWidth()
        ){
            Text(
                text = "Comunidade",
                modifier = Modifier
                    .align(Alignment.CenterStart)
                    .padding(start = 12.dp),
                fontSize = 24.sp,
                color = MaterialTheme.colorScheme.primary,
                fontWeight = FontWeight.Bold
            )
            Row(
                modifier = Modifier
                    .align(Alignment.CenterEnd)
                    .padding(end = 16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "Pesquisar amigos",
                    style = MaterialTheme.typography.labelMedium,
                    color = MaterialTheme.colorScheme.primary,
                    fontSize = 15.sp
                )

                Spacer(modifier = Modifier.width(8.dp))

                IconButton(onClick = { onBuscarAmigosScreen() }) {
                    Icon(
                        imageVector = Icons.Outlined.Search,
                        contentDescription = "Pesquisar Amigos",
                        tint = MaterialTheme.colorScheme.primary
                    )
                }
            }

        }


        Column(
            modifier = modifier
                .fillMaxWidth(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                Button(
                    onClick = onFeedScreen,
                    colors = ButtonDefaults.buttonColors(containerColor = Color(0xFFFFFFFF)),
                    border = BorderStroke(2.dp, Color.Gray),
                    shape = RoundedCornerShape(50)
                ) {

                    Text(
                        "Feed",
                        color = MaterialTheme.colorScheme.primary,
                        fontWeight = FontWeight.Bold
                    )
                }
                Button(
                    onClick = { },
                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary),
                    shape = RoundedCornerShape(50)
                ) {
                    Text("Ranking", color = Color.White, fontWeight = FontWeight.Bold)
                }
            }
            Spacer(modifier = Modifier.height(40.dp))

            if (ranking.isEmpty()) {
                Text(
                    "Siga amigos para ver o ranking!",
                    color = Color.Gray,
                    modifier = Modifier.padding(20.dp)
                )
            } else {
                LazyColumn(modifier = Modifier.weight(1f)) {
                    itemsIndexed(ranking) { index, usuario ->
                        ItemRanking(
                            nome = usuario.nickname,
                            sequencia = usuario.diasSeguidos,
                            posição = index + 1,
                            usuario
                        )
                    }
                }
            }
        }
        Spacer(modifier = Modifier.height(16.dp))

        Image(
            painter = painterResource(R.drawable.podio),
            contentDescription = "PodioGeral",
            modifier = Modifier.size(200.dp)
        )
    }
}

@Composable
fun ItemRanking(nome: String, sequencia: Int, posição: Int, usuario: Usuario) {
    Surface(
        color = MaterialTheme.colorScheme.primary,
        shape = RoundedCornerShape(12.dp),
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 12.dp, vertical = 4.dp)
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.padding(12.dp)
        ) {
            Text(
                text = "$posição º",
                color = Color.White,
                fontWeight = FontWeight.Bold,
                fontSize = 18.sp,
                modifier = Modifier.width(45.dp)
            )

            AsyncImage(
                model = ImageRequest.Builder(LocalContext.current)
                    .data(usuario.fotoPerfilUrl)
                    .crossfade(true)
                    .crossfade(500)
                    .diskCachePolicy(CachePolicy.ENABLED)
                    .memoryCachePolicy(CachePolicy.ENABLED)
                    .build(),
                contentDescription = "Foto do usuário",
                modifier = Modifier
                    .size(50.dp)
                    .clip(CircleShape)
                    .border(1.dp, Color.White, CircleShape),
                placeholder = painterResource(R.drawable.perfil_padrao),
                error = painterResource(R.drawable.perfil_padrao)
            )

            Spacer(modifier = Modifier.width(12.dp))

            Text(
                text = nome,
                color = Color.White,
                fontWeight = FontWeight.Bold,
                fontSize = 16.sp,
                modifier = Modifier.weight(1f)
            )
            Row(verticalAlignment = Alignment.CenterVertically) {
                Text(
                    text = "$sequencia",
                    color = Color.White,
                    fontSize = 18.sp,
                    fontWeight = FontWeight.Bold
                )
                Spacer(modifier = Modifier.width(4.dp))
                Icon(
                    painter = painterResource(R.drawable.logo_fogo),
                    contentDescription = null,
                    tint = Color.Unspecified,
                    modifier = Modifier.size(24.dp)
                )
            }
        }
    }
}



=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/social/ComentariosScreen.kt ===

package com.example.pegapista.ui.screens.social

import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.Send
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import coil.compose.AsyncImage
import coil.request.CachePolicy
import coil.request.ImageRequest
import com.example.pegapista.R
import com.example.pegapista.data.models.Comentario
import com.example.pegapista.ui.viewmodels.PostViewModel
import java.text.SimpleDateFormat
import java.util.Date
import org.koin.androidx.compose.koinViewModel
import java.util.Locale

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ComentariosScreen(
    postId: String,
    remetenteId: String,
    onVoltar: () -> Unit,
    viewModel: PostViewModel = koinViewModel()
) {
    LaunchedEffect(postId) {
        viewModel.carregarComentarios(postId)
    }

    val comentarios by viewModel.comentariosState.collectAsState()
    var textoComentario by remember { mutableStateOf("") }
    val focusManager = LocalFocusManager.current

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.White)
            .windowInsetsPadding(WindowInsets.statusBars)
    ) {
        Row(
            modifier = Modifier
                .height(60.dp)
                .fillMaxWidth()
                .padding(horizontal = 8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(onClick = onVoltar) {
                Icon(
                    imageVector = Icons.Default.ArrowBack,
                    contentDescription = "Voltar",
                    tint = MaterialTheme.colorScheme.primary
                )
            }
            Spacer(Modifier.width(16.dp))
            Text(
                text = "Comentários",
                fontSize = 22.sp,
                color = MaterialTheme.colorScheme.primary,
                fontWeight = FontWeight.Bold
            )
        }

        LazyColumn(
            modifier = Modifier
                .weight(1f)
                .fillMaxWidth()
                .padding(horizontal = 16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp),
            contentPadding = PaddingValues(top = 10.dp, bottom = 10.dp)
        ) {
            if (comentarios.isEmpty()) {
                item {
                    Box(modifier = Modifier.fillParentMaxSize(), contentAlignment = Alignment.Center) {
                        Text("Seja o primeiro a comentar!", color = Color.Gray)
                    }
                }
            }
            items(comentarios) { comentario ->
                ItemComentario(comentario, viewModel)
            }
        }

        Row(
            modifier = Modifier
                .fillMaxWidth()
                .background(Color.White)
                .windowInsetsPadding(WindowInsets.ime.union(WindowInsets.navigationBars))
                .padding(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            OutlinedTextField(
                value = textoComentario,
                onValueChange = { textoComentario = it },
                placeholder = { Text("Adicione um comentário...") },
                modifier = Modifier
                    .weight(1f)
                    .padding(end = 8.dp),
                shape = RoundedCornerShape(24.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    unfocusedBorderColor = Color.LightGray,
                    focusedBorderColor = MaterialTheme.colorScheme.primary,
                    focusedContainerColor = Color(0xFFF5F5F5),
                    unfocusedContainerColor = Color(0xFFF5F5F5)
                ),
                maxLines = 3
            )

            IconButton(
                onClick = {
                    if (textoComentario.isNotBlank()) {
                        viewModel.enviarComentario(postId, remetenteId, texto = textoComentario)
                        textoComentario = ""
                        focusManager.clearFocus()
                    }
                },
                modifier = Modifier
                    .background(MaterialTheme.colorScheme.primary, CircleShape)
                    .size(48.dp)
            ) {
                Icon(
                    imageVector = Icons.AutoMirrored.Filled.Send,
                    contentDescription = "Enviar",
                    tint = Color.White
                )
            }
        }
    }
}

@Composable
fun ItemComentario(comentario: Comentario, viewModel: PostViewModel) {
    var fotoPerfilUrl by remember { mutableStateOf("") }
    LaunchedEffect(comentario.userId) {
        val url = viewModel.getFotoPerfil(comentario.userId)
        if (url != null) {
            fotoPerfilUrl = url
        }
    }
    Row(modifier = Modifier.fillMaxWidth()) {
        AsyncImage(
            model = ImageRequest.Builder(LocalContext.current)
                .data(fotoPerfilUrl)
                .crossfade(true)
                .crossfade(500)
                .diskCachePolicy(CachePolicy.ENABLED)
                .memoryCachePolicy(CachePolicy.ENABLED)
                .build(),
            contentDescription = "Foto do usuário",
            modifier = Modifier
                .size(40.dp)
                .clip(CircleShape)
                .border(2.dp, Color.White, CircleShape),
            contentScale = ContentScale.Crop,
            placeholder = painterResource(R.drawable.perfil_padrao),
            error = painterResource(R.drawable.perfil_padrao)
        )
        Spacer(modifier = Modifier.width(10.dp))
        Column {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Text(
                    text = comentario.nomeUsuario,
                    fontWeight = FontWeight.Bold,
                    fontSize = 14.sp
                )
                Spacer(modifier = Modifier.width(8.dp))
                val dataFormatada = try {
                    SimpleDateFormat("dd/MM HH:mm", Locale.getDefault()).format(Date(comentario.data))
                } catch (e: Exception) { "" }
                Text(
                    text = dataFormatada,
                    color = Color.Gray,
                    fontSize = 10.sp
                )
            }
            Spacer(modifier = Modifier.height(2.dp))
            Text(
                text = comentario.texto,
                fontSize = 14.sp,
                color = Color.DarkGray
            )
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/auth/InicialScreen.kt ===

package com.example.pegapista.ui.screens.auth

import com.example.pegapista.R
import androidx.compose.foundation.Image
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.example.pegapista.ui.theme.PegaPistaTheme

@Composable
fun InicialScreen(){
    Column(
        modifier = Modifier
            .fillMaxSize(),
        horizontalAlignment = Alignment.CenterHorizontally,
    ) {
        Spacer(modifier = Modifier.weight(1f))
        Image(
            painter = painterResource(R.drawable.logo_aplicativo),
            contentDescription = "Logo do aplicativo",
            modifier = Modifier
                .size(400.dp)
                .padding(top = 0.dp, ),

        )
        Spacer(modifier = Modifier.weight(1f))

        }
    }



@Preview (showBackground = true)
@Composable
fun InicialScreenPreview() {
    PegaPistaTheme {
        InicialScreen()
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/auth/LoginScreen.kt ===

package com.example.pegapista.ui.screens.auth

import android.widget.Toast
import android.util.Log
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.OutlinedTextFieldDefaults
import androidx.compose.material3.Text

import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.PasswordVisualTransformation
import androidx.compose.ui.text.input.VisualTransformation
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.pegapista.R
import com.example.pegapista.ui.components.BotaoGoogle
import com.example.pegapista.ui.theme.BluePrimary
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.ui.viewmodels.AuthViewModel
import com.google.firebase.auth.FirebaseAuth

@Composable
fun LoginScreen(
    modifier: Modifier = Modifier,
    onEntrarHome: () -> Unit,
    viewModel: AuthViewModel = viewModel()
) {
    val uiState by viewModel.uiState.collectAsState()

    var email by remember { mutableStateOf("") }
    var senha by remember { mutableStateOf("") }
    val context = LocalContext.current

    LaunchedEffect(uiState) {
        if (uiState.error != null) {
            Toast.makeText(context, uiState.error, Toast.LENGTH_LONG).show()
        }
        if (uiState.isSuccess) {
            Toast.makeText(context, "Bem-vindo!", Toast.LENGTH_SHORT).show()
            onEntrarHome()
            viewModel.resetState()
        }
    }

    Column (
        modifier = modifier
            .fillMaxSize()
            .padding(start = 40.dp, end = 40.dp, top = 100.dp, bottom = 100.dp)
            .background(
                color = MaterialTheme.colorScheme.surface,
                shape = RoundedCornerShape(15.dp)
            ),
        verticalArrangement = Arrangement.Top,
        horizontalAlignment = Alignment.CenterHorizontally
    ){
        Image(
            painter = painterResource(R.drawable.logo_aplicativo),
            contentDescription = "Logo do aplicativo",
            modifier = Modifier.size(200.dp)
        )
        Text(
            text = "Login",
            fontWeight = FontWeight.SemiBold,
            fontSize = MaterialTheme.typography.titleLarge.fontSize,
            color = MaterialTheme.colorScheme.primary,
            modifier = Modifier.align(alignment = Alignment.CenterHorizontally)
        )
        Spacer(Modifier.height(25.dp))
        Textsfields(
            value = email,
            onValueChange = {email = it},
            placeholder = "Email"
        )
        Spacer(Modifier.height(15.dp))
        Textsfields(
            value = senha,
            onValueChange = { senha = it },
            placeholder = "Senha"
        )
        Spacer(Modifier.height(40.dp))
        ButtonEntrar(
            onClick = {
                viewModel.login(email, senha)
            }
        )
        Spacer(Modifier.height(15.dp))
        Text(
            text = "ou",
            fontSize = 12.sp,
            color = Color.Gray,
            modifier = Modifier.padding(vertical = 5.dp)
        )
        BotaoGoogle(
            onGoogleSignInSelected = { token ->
                viewModel.loginComGoogle(token)
            },
            onError = { erro ->
                Toast.makeText(context, erro, Toast.LENGTH_SHORT).show()
            }
        )
    }
}

@Composable
fun Textsfields(
    value: String,
    onValueChange: (String) -> Unit,
    placeholder: String
) {
    val isPassword = placeholder == "Senha"
    val visualTransformation =
        if (isPassword) PasswordVisualTransformation() else VisualTransformation.None

    OutlinedTextField(
        value = value,
        onValueChange = onValueChange,
        placeholder = {
            Text(
                text = placeholder,
                fontSize = 14.sp
            )
        },
        label = {
            Text(text = placeholder)
        },
        visualTransformation = visualTransformation,
        shape = RoundedCornerShape(12.dp),
        colors = OutlinedTextFieldDefaults.colors(
            focusedBorderColor = Color(0xFFCCCCCC),
            unfocusedBorderColor = Color(0xFFDDDDDD),
            focusedPlaceholderColor = Color(0xFFBBBBBB),
            unfocusedPlaceholderColor = Color(0xFFBBBBBB),
            focusedContainerColor = Color(0xFFFDFDFD),
            unfocusedContainerColor = Color(0xFFFDFDFD),
            cursorColor = MaterialTheme.colorScheme.primary
        ),
        modifier = Modifier
            .height(60.dp)
            .fillMaxWidth()
            .padding(horizontal = 10.dp)
    )
}

@Composable
fun ButtonEntrar(
    onClick: () -> Unit
) {
    Button(
        onClick = onClick,
        modifier = Modifier
            .padding(horizontal = 30.dp)
            .shadow(
                elevation = 8.dp,
                shape = RoundedCornerShape(12.dp),
                clip = false
            )
            .height(50.dp)
            .fillMaxWidth(),
        shape = RoundedCornerShape(12.dp),
        colors = ButtonDefaults.buttonColors(
            containerColor = BluePrimary
        )
    ) {
        Text("Entrar", fontSize = 15.sp, fontWeight = FontWeight.Bold)
    }
}

@Preview(showBackground = true)
@Composable
fun LoginScreenPreview() {
    PegaPistaTheme {
        LoginScreen(
            onEntrarHome = {}
        )
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/auth/InicioScreen.kt ===

package com.example.pegapista.ui.screens.auth

import com.example.pegapista.R
import androidx.compose.foundation.Image
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontStyle
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.pegapista.ui.theme.PegaPistaTheme

@Composable
fun InicioScreen(
    onEntrarClick: () -> Unit,
    onCadastrarClick: () -> Unit
) {
    Column(
        modifier = Modifier.fillMaxSize(),
        horizontalAlignment = Alignment.CenterHorizontally,
    ) {
        Spacer(modifier = Modifier.weight(1f))

        Image(
            painter = painterResource(R.drawable.logo__aplicativo),
            contentDescription = "Logo do aplicativo",
            modifier = Modifier
                .size(400.dp)
                .padding(top = 0.dp),
        )

        Spacer(modifier = Modifier.weight(1f))

        Card(
            shape = RoundedCornerShape(topStart = 15.dp, topEnd = 15.dp),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.primary
            ),
            elevation = CardDefaults.cardElevation(8.dp),
            modifier = Modifier
                .fillMaxWidth()
                .height(300.dp)
        ) {
            Column(
                modifier = Modifier.fillMaxWidth(),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Top
            ) {
                Text(
                    text = "Seja bem-vindo(a)!",
                    color = Color.White,
                    fontSize = 30.sp,
                    fontWeight = FontWeight.SemiBold,
                    modifier = Modifier.padding(top = 20.dp, start = 20.dp, bottom = 5.dp, end = 20.dp)
                )
                Text(
                    text = "Registre suas atividades, desafie seus amigos e aproveite cada momento!\"",
                    color = Color.White.copy(alpha = 0.8f),
                    fontWeight = FontWeight.SemiBold,
                    fontSize = 15.sp,
                    textAlign = TextAlign.Center,
                    modifier = Modifier.padding(top = 4.dp, start = 20.dp, bottom = 5.dp, end = 20.dp)
                )
                Spacer(Modifier.height(20.dp))

                Button(
                    onClick = onEntrarClick,
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color.White
                    ),
                    shape = RoundedCornerShape(12.dp),
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(50.dp)
                        .padding(top = 10.dp, start = 100.dp, end = 100.dp)
                ) {
                    Text(
                        text = "Entrar",
                        fontSize = 16.sp,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.primary
                    )
                }
                Button(
                    onClick = onCadastrarClick,
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color.White
                    ),
                    shape = RoundedCornerShape(12.dp),
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(50.dp)
                        .padding(top = 10.dp, start = 100.dp, end = 100.dp)
                ) {
                    Text(
                        text = "Cadastre-se",
                        fontSize = 16.sp,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.primary
                    )
                }
            }
        }
    }
}

@Preview (showBackground = true)
@Composable
fun InicioScreenPreview() {
    PegaPistaTheme {
        InicioScreen(onEntrarClick = {}, onCadastrarClick = {})
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/auth/CadastroScreen.kt ===

package com.example.pegapista.ui.screens.auth

import android.widget.Toast
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.OutlinedTextFieldDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.PasswordVisualTransformation
import androidx.compose.ui.text.input.VisualTransformation
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.pegapista.R
import com.example.pegapista.ui.components.BotaoGoogle
import com.example.pegapista.ui.theme.BluePrimary
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.ui.viewmodels.AuthViewModel

@Composable
fun CadastroScreen(
    modifier: Modifier = Modifier,
    onCadastroSucesso: () -> Unit,
    viewModel: AuthViewModel = viewModel()
) {
    var nome by remember { mutableStateOf("") }
    var email by remember { mutableStateOf("") }
    var senha by remember { mutableStateOf("") }
    var confirmarSenha by remember { mutableStateOf("") }

    val uiState by viewModel.uiState.collectAsState()
    val context = LocalContext.current

    LaunchedEffect(uiState) {
        if (uiState.error != null) {
            Toast.makeText(context, uiState.error, Toast.LENGTH_SHORT).show()
        }
        if (uiState.isSuccess) {
            Toast.makeText(context, "Conta criada com sucesso!", Toast.LENGTH_LONG).show()
            onCadastroSucesso()
            viewModel.resetState()
        }
    }

    Column(
        modifier = modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.primary)
            .padding(horizontal = 20.dp),
        verticalArrangement = Arrangement.Center,
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(vertical = 40.dp)
                .background(
                    color = MaterialTheme.colorScheme.surface,
                    shape = RoundedCornerShape(15.dp)
                )
                .padding(vertical = 30.dp, horizontal = 20.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Image(
                painter = painterResource(R.drawable.logo_aplicativo),
                contentDescription = "Logo do aplicativo",
                modifier = Modifier.size(150.dp)
            )

            Text(
                text = "Crie sua conta",
                fontWeight = FontWeight.SemiBold,
                fontSize = MaterialTheme.typography.titleLarge.fontSize,
                color = MaterialTheme.colorScheme.primary,
                modifier = Modifier.align(alignment = Alignment.CenterHorizontally)
            )

            Spacer(Modifier.height(25.dp))

            CampoCadastro(
                value = nome,
                onValueChange = { nome = it },
                label = "Nome Completo"
            )

            Spacer(Modifier.height(15.dp))

            CampoCadastro(
                value = email,
                onValueChange = { email = it },
                label = "E-mail"
            )

            Spacer(Modifier.height(15.dp))

            CampoCadastro(
                value = senha,
                onValueChange = { senha = it },
                label = "Senha",
                isPassword = true
            )

            Spacer(Modifier.height(15.dp))

            CampoCadastro(
                value = confirmarSenha,
                onValueChange = { confirmarSenha = it },
                label = "Confirmar Senha",
                isPassword = true
            )

            Spacer(Modifier.height(40.dp))

            ButtonCadastrar(
                onClick = {
                    viewModel.cadastrar(nome, email, senha, confirmarSenha)
                }
            )
            Spacer(Modifier.height(15.dp))

            Text(
                text = "ou cadastre-se com",
                fontSize = 12.sp,
                color = Color.Gray,
                modifier = Modifier.align(Alignment.CenterHorizontally).padding(bottom = 5.dp)
            )
            BotaoGoogle(
                onGoogleSignInSelected = { token ->
                    viewModel.loginComGoogle(token)
                },
                onError = { erro ->
                    Toast.makeText(context, erro, Toast.LENGTH_SHORT).show()
                }
            )
        }
    }
}
@Composable
fun CampoCadastro(
    value: String,
    onValueChange: (String) -> Unit,
    label: String,
    isPassword: Boolean = false
) {
    val visualTransformation = if (isPassword) PasswordVisualTransformation() else VisualTransformation.None

    OutlinedTextField(
        value = value,
        onValueChange = onValueChange,
        placeholder = {
            Text(text = label, fontSize = 14.sp)
        },
        label = {
            Text(text = label)
        },
        visualTransformation = visualTransformation,
        shape = RoundedCornerShape(12.dp),
        colors = OutlinedTextFieldDefaults.colors(
            focusedBorderColor = Color(0xFFCCCCCC),
            unfocusedBorderColor = Color(0xFFDDDDDD),
            focusedPlaceholderColor = Color(0xFFBBBBBB),
            unfocusedPlaceholderColor = Color(0xFFBBBBBB),
            focusedContainerColor = Color(0xFFFDFDFD),
            unfocusedContainerColor = Color(0xFFFDFDFD),
            cursorColor = MaterialTheme.colorScheme.primary
        ),
        modifier = Modifier
            .height(60.dp)
            .fillMaxWidth(),
        singleLine = true
    )
}

@Composable
fun ButtonCadastrar(onClick: () -> Unit) {
    Button(
        onClick = onClick,
        modifier = Modifier
            .padding(horizontal = 10.dp)
            .shadow(
                elevation = 8.dp,
                shape = RoundedCornerShape(12.dp),
                clip = false
            )
            .height(50.dp)
            .fillMaxWidth(),
        shape = RoundedCornerShape(12.dp),
        colors = ButtonDefaults.buttonColors(
            containerColor = BluePrimary
        )
    ) {
        Text("Cadastrar", fontSize = 15.sp, fontWeight = FontWeight.Bold)
    }
}

@Preview(showBackground = true)
@Composable
fun CadastroScreenPreview() {
    PegaPistaTheme {
        CadastroScreen(
            onCadastroSucesso = {}
        )
    }
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/corrida/AtividadeBeforeScreen.kt ===

package com.example.pegapista.ui.screens.corrida

import android.Manifest
import android.content.pm.PackageManager
import android.os.Build
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.DirectionsRun
import androidx.compose.material.icons.filled.Map
import androidx.compose.material.icons.filled.PlayArrow
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.core.content.ContextCompat
import com.example.pegapista.R
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.utils.showNotification

@Composable
fun AtividadeBeforeScreen(
    modifier: Modifier = Modifier,
    onStartActivity: () -> Unit = {},
    onAbrirMapa: () -> Unit = {}
) {
    val context = LocalContext.current

    val permissionLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestPermission()
    ) { isGranted ->
        if (isGranted) {
            showNotification(context, "Atividade Iniciada!", "Bom treino, continue firme!")
            onStartActivity()
        } else {
            onStartActivity()
        }
    }

    val handleStartClick = {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            val hasPermission = ContextCompat.checkSelfPermission(
                context, Manifest.permission.POST_NOTIFICATIONS
            ) == PackageManager.PERMISSION_GRANTED

            if (hasPermission) {
                showNotification(context, "Atividade Iniciada!", "Bom treino, continue firme!")
                onStartActivity()
            } else {
                permissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
            }
        } else {
            showNotification(context, "Atividade Iniciada!", "Bom treino, continue firme!")
            onStartActivity()
        }
    }
    Column(
        modifier = modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.background)
            .padding(10.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {

        Column(
            modifier = Modifier
                .fillMaxWidth()
                .weight(1f)
                .background(
                    color = MaterialTheme.colorScheme.primary,
                    shape = RoundedCornerShape(20.dp)
                )
                .padding(20.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.SpaceEvenly
        ) {

            TituloAtividade("Tudo pronto para correr!")

            CardIlustracaoAtividade()

            AcoesAtividade(
                onStartClick = { handleStartClick() },
                onMapaClick = { onAbrirMapa() }
            )
        }
    }
}

@Composable
fun TituloAtividade(texto: String) {
    Text(
        text = texto,
        style = MaterialTheme.typography.headlineSmall,
        fontWeight = FontWeight.Bold,
        color = MaterialTheme.colorScheme.onPrimary,
        textAlign = TextAlign.Center
    )
}

@Composable
fun CardIlustracaoAtividade() {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .height(220.dp),
        shape = androidx.compose.foundation.shape.RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        )
    ) {
        Column(
            modifier = Modifier.fillMaxSize()
        ) {
            Box(
                modifier = Modifier
                    .weight(1f)
                    .fillMaxWidth(),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = Icons.Default.DirectionsRun,
                    contentDescription = "Ilustração de corrida",
                    tint = MaterialTheme.colorScheme.primary.copy(alpha = 0.8f),
                    modifier = Modifier.size(80.dp)
                )
            }
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(MaterialTheme.colorScheme.surfaceVariant)
                    .padding(12.dp)
            ) {
                Text(
                    text = "CORRIDA",
                    fontWeight = FontWeight.Bold,
                    fontSize = 12.sp,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    letterSpacing = 1.5.sp
                )
            }
        }
    }
}

@Composable
fun AcoesAtividade(
    onStartClick: () -> Unit,
    onMapaClick: () -> Unit
) {
    Row(
        horizontalArrangement = Arrangement.spacedBy(32.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {

        BotaoCircularGrande(
            cor = Color(0xFF6CDE21),
            icone = Icons.Default.PlayArrow,
            texto = "Iniciar",
            onClick = onStartClick
        )

        BotaoCircularGrande(
            cor = MaterialTheme.colorScheme.secondary,
            icone = Icons.Default.Map,
            texto = "Mapa",
            onClick = onMapaClick
        )
    }
}

@Composable
fun BotaoCircularGrande(
    cor: Color,
    icone: ImageVector,
    texto: String,
    onClick: () -> Unit
) {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        modifier = Modifier.clickable { onClick() }
    ) {
        Box(
            contentAlignment = Alignment.Center,
            modifier = Modifier
                .size(90.dp)
                .shadow(10.dp, CircleShape)
                .background(cor, CircleShape)
        ) {
            Icon(
                imageVector = icone,
                contentDescription = texto,
                tint = Color.White,
                modifier = Modifier.size(48.dp)
            )
        }
        Spacer(modifier = Modifier.height(8.dp))
        Text(
            text = texto,
            color = MaterialTheme.colorScheme.onPrimary,
            fontWeight = FontWeight.SemiBold
        )
    }
}


@Preview(showBackground = true)
@Composable
fun AtividadeBeforePreview() {
    PegaPistaTheme {
        AtividadeBeforeScreen()
    }
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/corrida/AtividadeAfterScreen.kt ===

package com.example.pegapista.ui.screens.corrida

import android.Manifest
import android.os.Build
import android.widget.Toast
import androidx.compose.runtime.getValue
import androidx.compose.runtime.setValue
import androidx.activity.compose.BackHandler
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.annotation.RequiresApi
import androidx.compose.foundation.background
import androidx.compose.foundation.horizontalScroll
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.pegapista.ui.components.MapaEmTempoReal
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.ui.viewmodels.CorridaViewModel
import com.google.android.gms.maps.model.LatLng
import org.koin.androidx.compose.koinViewModel


@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun AtividadeAfterScreen(
    viewModel: CorridaViewModel = koinViewModel(),
    onFinishActivity: (distancia: Double, tempo: String, pace: String, List<LatLng>) -> Unit,
    onCancelActivity: () -> Unit
) {
    val scrollState = rememberScrollState()
    val context = LocalContext.current


    val saveState by viewModel.saveState.collectAsState(initial = null)
    val percurso by viewModel.percurso.collectAsState()
    val distanciaMetros by viewModel.distancia.collectAsState()
    val tempoSegundos by viewModel.tempoSegundos.collectAsState()
    val paceAtual by viewModel.pace.collectAsState()
    val isRastreando by viewModel.isRastreando.collectAsState()
    val distanciaKmExibicao = "%.2f".format(distanciaMetros / 1000)

    val tempoExibicao = remember(tempoSegundos) {
        val horas = tempoSegundos / 3600
        val minutos = (tempoSegundos % 3600) / 60
        val segundos = tempoSegundos % 60
        if (horas > 0) "%d:%02d:%02d".format(horas, minutos, segundos)
        else "%02d:%02d".format(minutos, segundos)
    }

    var showDiscardDialog by remember { mutableStateOf(false) }
    BackHandler {
        showDiscardDialog = true
    }

    if (showDiscardDialog) {
        AlertDialog(
            onDismissRequest = { showDiscardDialog = false },
            title = { Text("Cancelar corrida?") },
            text = { Text("Tem certeza que deseja cancelar a corrida?") },
            confirmButton = {
                TextButton(
                    onClick = {
                        showDiscardDialog = false
                        onCancelActivity()
                        viewModel.finalizarCorrida()
                    },
                    colors = ButtonDefaults.textButtonColors(contentColor = Color.Red)
                ) { Text("Parar Corrida") }
            },
            dismissButton = {
                TextButton(onClick = { showDiscardDialog = false }) { Text("Continuar Corrida") }
            }
        )
    }


    val permissionLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        val fineLocation = permissions[Manifest.permission.ACCESS_FINE_LOCATION] ?: false
        val coarseLocation = permissions[Manifest.permission.ACCESS_COARSE_LOCATION] ?: false
        if (fineLocation || coarseLocation) {
            viewModel.iniciarCorrida()
        } else {
            Toast.makeText(context, "GPS necessário para rastrear", Toast.LENGTH_SHORT).show()
        }
    }

    LaunchedEffect(Unit) {
        val permissoes = mutableListOf(
            Manifest.permission.ACCESS_FINE_LOCATION,
            Manifest.permission.ACCESS_COARSE_LOCATION
        )
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            permissoes.add(Manifest.permission.POST_NOTIFICATIONS)
        }

        permissionLauncher.launch(permissoes.toTypedArray())
    }

    LaunchedEffect(saveState) {
        if (saveState?.isSuccess == true) {
            val distanciaKm = (distanciaMetros / 1000).toDouble()
            val tempoFormatado = viewModel.formatarTempoParaString(tempoSegundos)
            onFinishActivity(distanciaKm, tempoFormatado, paceAtual, percurso)
        }
    }
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.primary),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Box(
            modifier = Modifier
                .weight(0.6f)
                .fillMaxWidth()
        ) {
            MapaEmTempoReal()
        }
        Spacer(Modifier.height(5.dp))

        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceEvenly
        ) {
            BlocoDados(valor = distanciaKmExibicao, label = "Km")
            BlocoDados(valor = tempoExibicao, label = "Tempo")
            BlocoDados(valor = paceAtual, label = "Ritmo")
        }
        Spacer(modifier = Modifier.height(5.dp))
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .horizontalScroll(scrollState),
            horizontalArrangement = Arrangement.SpaceEvenly
        ) {
            Button(
                onClick = { viewModel.toggleRastreamento() },
                colors = ButtonDefaults.buttonColors(
                    containerColor = if (isRastreando) Color(0xFFFF5252) else Color(0xFFFF9800)
                ),
                shape = RoundedCornerShape(50)
            ) {
                Text(
                    text = if (isRastreando) "Pausar" else "Retomar",
                    color = Color.White,
                    fontWeight = FontWeight.Bold
                )
            }

            Button(
                onClick = {
                    viewModel.finalizarESalvarCorrida()
                          },
                colors = ButtonDefaults.buttonColors(containerColor = Color(0xFF0FDC52)),
                shape = RoundedCornerShape(50),

            ) {
                Text("Finalizar", color = Color.White, fontWeight = FontWeight.Bold)
            }
        }
        Spacer(Modifier.height(5.dp))
    }
}


@Composable
fun BlocoDados(valor: String, label: String) {
    Surface(
        color = Color(0xFF0288D1),
        shape = RoundedCornerShape(16.dp),
        modifier = Modifier
            .width(100.dp)
            .padding(vertical = 8.dp)
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            modifier = Modifier.padding(vertical = 16.dp, horizontal = 8.dp)
        ) {
            Text(
                text = valor,
                fontSize = 25.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White
            )
            Text(
                text = label,
                fontSize = 12.sp,
                color = Color.White
            )
        }
    }
}
@Preview (showBackground = true)
@Composable
fun AtividadeAfterScreenPreview() {
    PegaPistaTheme {
        //AtividadeAfterScreen(onFinishActivity = {} as (Double, String, String) -> Unit)
    }
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/corrida/MapaVizualizacaoScreen.kt ===

package com.example.pegapista.ui.screens.corrida

import android.Manifest
import android.annotation.SuppressLint
import android.content.pm.PackageManager
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.core.content.ContextCompat
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.pegapista.R
import com.example.pegapista.ui.viewmodels.CorridaViewModel
import com.google.android.gms.maps.model.CameraPosition
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.MapStyleOptions
import com.google.maps.android.compose.*

@SuppressLint("MissingPermission")
@Composable
fun MapaVisualizacaoScreen(
    onVoltar: () -> Unit,
    viewModel: CorridaViewModel = viewModel()
) {
    val context = LocalContext.current
    val pontoInicial by viewModel.localizacaoInicial.collectAsState()
    var temPermissao by remember {
        mutableStateOf(
            ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.ACCESS_FINE_LOCATION
            ) == PackageManager.PERMISSION_GRANTED
        )
    }

    val launcherPermissao = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestPermission()
    ) { isGranted: Boolean ->
        temPermissao = isGranted
    }

    LaunchedEffect(Unit) {
        if (!temPermissao) {
            launcherPermissao.launch(Manifest.permission.ACCESS_FINE_LOCATION)
        }
    }
    val cameraPositionState = rememberCameraPositionState()
    LaunchedEffect(pontoInicial) {
        pontoInicial?.let { latLng ->
            cameraPositionState.position = CameraPosition.fromLatLngZoom(latLng, 18f)
        }
    }

    Box(modifier = Modifier.fillMaxSize()) {

        GoogleMap(
            modifier = Modifier.fillMaxSize(),
            cameraPositionState = cameraPositionState,
            properties = MapProperties(
                isMyLocationEnabled = temPermissao,
                mapStyleOptions = MapStyleOptions.loadRawResourceStyle(
                    context,
                    R.raw.map_style_clean
                )
            ),
            uiSettings = MapUiSettings(
                zoomControlsEnabled = false,
                compassEnabled = true,
                myLocationButtonEnabled = true
            )
        )
        IconButton(
            onClick = onVoltar,
            modifier = Modifier
                .padding(16.dp)
                .size(48.dp)
                .background(
                    color = MaterialTheme.colorScheme.surface.copy(alpha = 0.9f),
                    shape = CircleShape
                )
                .align(Alignment.TopStart)
        ) {
            Icon(
                imageVector = Icons.Default.ArrowBack,
                contentDescription = "Voltar",
                tint = MaterialTheme.colorScheme.onSurface
            )
        }
    }
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/screens/corrida/RunFinishedScreen.kt ===

package com.example.pegapista.ui.screens.corrida

import android.Manifest
import android.content.Context
import android.net.Uri
import android.widget.Toast
import androidx.activity.compose.BackHandler
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.PickVisualMediaRequest
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.pager.HorizontalPager
import androidx.compose.foundation.pager.rememberPagerState
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.AddPhotoAlternate
import androidx.compose.material.icons.filled.CameraAlt
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Edit
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.core.content.FileProvider
import org.koin.androidx.compose.koinViewModel
import coil.compose.AsyncImage
import com.example.pegapista.R
import com.example.pegapista.ui.components.SnapshotMap
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.ui.viewmodels.PostViewModel
import java.io.File
import com.example.pegapista.utils.MapUtils
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.model.JointType
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.RoundCap
import com.google.maps.android.compose.*

@OptIn(MapsComposeExperimentalApi::class)
@Composable
fun RunFinishedScreen(
    distancia: Double = 0.00,
    tempo: String = "0:00",
    pace: String = "-:--",
    caminhoPercorrido: List<LatLng> = emptyList(),
    onFinishNavigation: () -> Unit = {},
    viewModel: PostViewModel = koinViewModel()
) {

    val context = LocalContext.current
    val uiState by viewModel.uiState.collectAsState()

    var titulo by remember { mutableStateOf("") }
    var descricao by remember { mutableStateOf("") }
    var mostrarOpcoesFoto by remember { mutableStateOf(false) }

    val cameraPositionState = rememberCameraPositionState()
    var mapaAdicionado by remember { mutableStateOf(false) }

    var showDiscardDialog by remember { mutableStateOf(false) }
    BackHandler {
        showDiscardDialog = true
    }

    var uriTemporaria by remember { mutableStateOf<Uri?>(null) }
    val listaFotos by viewModel.fotosSelecionadasUris.collectAsState()
    val galeriaLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.PickMultipleVisualMedia(5)
    ) { uris ->
        uris.forEach { viewModel.adicionarFoto(it) }
    }
    val cameraLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.TakePicture()
    ) { sucesso ->
        if (sucesso && uriTemporaria != null) {
            viewModel.adicionarFoto(uriTemporaria!!)
        }
    }

    val permissaoLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { aceitou ->
        if (aceitou) {
            uriTemporaria = criarUriParaPost(context)
            cameraLauncher.launch(uriTemporaria!!)
        } else {
            Toast.makeText(context, "Permissão de câmera negada", Toast.LENGTH_SHORT).show()
        }
    }

    LaunchedEffect(uiState) {
        if (uiState.isSuccess) {
            Toast.makeText(context, "Compartilhado no Feed!", Toast.LENGTH_SHORT).show()
            onFinishNavigation()
        }
        if (uiState.error != null) {
            Toast.makeText(context, uiState.error, Toast.LENGTH_LONG).show()
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(color = MaterialTheme.colorScheme.primary)
            .padding(20.dp)
            .verticalScroll(rememberScrollState()),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(bottom = 20.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.Start
        ) {
            IconButton(onClick = { showDiscardDialog = true }) {
                Icon(
                    imageVector = Icons.Default.Close,
                    contentDescription = "Cancelar e Sair",
                    tint = Color.White
                )
            }
            Text(
                text = "Nova Publicação",
                color = Color.White,
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                modifier = Modifier.padding(start = 8.dp)
            )
        }
        Card(
            modifier = Modifier.fillMaxWidth().wrapContentHeight(),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(containerColor = Color.White),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                modifier = Modifier.padding(bottom = 20.dp)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .aspectRatio(4f / 4f)
                        .clickable { mostrarOpcoesFoto = true }
                ) {
                        if (listaFotos.isNotEmpty()) {
                            val pagerState = rememberPagerState(pageCount = { listaFotos.size })

                            HorizontalPager(state = pagerState, modifier = Modifier.fillMaxSize()) { page ->
                                AsyncImage(
                                    model = listaFotos[page],
                                    contentDescription = null,
                                    contentScale = ContentScale.Crop,
                                    modifier = Modifier.fillMaxSize()
                                )
                            }
                            if (listaFotos.size > 1) {
                                Row(
                                    Modifier.align(Alignment.BottomCenter).padding(8.dp),
                                    horizontalArrangement = Arrangement.Center
                                ) {
                                    repeat(listaFotos.size) { iteration ->
                                        val color = if (pagerState.currentPage == iteration) Color.White else Color.White.copy(0.5f)
                                        Box(modifier = Modifier.padding(2.dp).clip(CircleShape).background(color).size(6.dp))
                                    }
                                }
                            }
                        }

                        else if (caminhoPercorrido.isNotEmpty() && !mapaAdicionado) {
                            SnapshotMap(
                                caminhoPercorrido = caminhoPercorrido,
                                context = context,
                                onSnapshotPronto = { uri ->
                                    viewModel.adicionarFoto(uri)
                                    mapaAdicionado = true
                                }
                            )
                        }
                        Box(
                            modifier = Modifier
                                .align(Alignment.BottomEnd)
                                .padding(12.dp)
                        ) {
                            FloatingActionButton(
                                onClick = { galeriaLauncher.launch(PickVisualMediaRequest(ActivityResultContracts.PickVisualMedia.ImageOnly)) },
                                containerColor = Color.Black.copy(alpha = 0.7f),
                                contentColor = Color.White,
                                modifier = Modifier.size(40.dp)
                            ) {
                                Icon(Icons.Default.AddPhotoAlternate, contentDescription = "Add Fotos")
                            }
                        }
                }

                Spacer(modifier = Modifier.height(16.dp))

                Text(
                    text = "Corrida finalizada!",
                    fontSize = 20.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color.DarkGray
                )

                Spacer(modifier = Modifier.height(20.dp))

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceEvenly
                ) {
                    StatItem(valor = "%.2f".format(distancia), unidade = "Km")
                    StatItem(valor = tempo, unidade = "Duração")
                    StatItem(valor = pace, unidade = "Pace")
                }

                Spacer(modifier = Modifier.height(20.dp))

                Column(modifier = Modifier.padding(horizontal = 20.dp)) {
                    OutlinedTextField(
                        value = titulo,
                        onValueChange = { titulo = it },
                        placeholder = { Text("Dê um título...", fontSize = 14.sp, color = Color.LightGray) },
                        modifier = Modifier.fillMaxWidth(),
                        shape = RoundedCornerShape(8.dp),
                    )

                    Spacer(modifier = Modifier.height(10.dp))

                    OutlinedTextField(
                        value = descricao,
                        onValueChange = { descricao = it },
                        placeholder = { Text("Descreva como foi...", fontSize = 14.sp, color = Color.LightGray) },
                        modifier = Modifier.fillMaxWidth(),
                        shape = RoundedCornerShape(8.dp),
                    )
                }
            }
        }

        Spacer(modifier = Modifier.height(30.dp))


        Button(
            onClick = {
                viewModel.compartilharCorrida(
                    titulo = titulo,
                    descricao = descricao,
                    distancia = distancia,
                    tempo = tempo,
                    pace = pace
                )
            },
            enabled = !uiState.isLoading,
            modifier = Modifier.fillMaxWidth(0.8f).height(50.dp),
            colors = ButtonDefaults.buttonColors(containerColor = Color.White),
            shape = RoundedCornerShape(12.dp),
            elevation = ButtonDefaults.buttonElevation(defaultElevation = 4.dp)
        ) {
            if (uiState.isLoading) {
                CircularProgressIndicator(modifier = Modifier.size(24.dp), color = MaterialTheme.colorScheme.primary)
            } else {
                Text(
                    text = "Compartilhar",
                    color = MaterialTheme.colorScheme.primary,
                    fontWeight = FontWeight.Bold,
                    fontSize = 16.sp
                )
            }
        }
    }

    if (mostrarOpcoesFoto) {
        AlertDialog(
            onDismissRequest = { mostrarOpcoesFoto = false },
            title = { Text("Adicionar Foto") },
            text = { Text("Escolha uma foto para sua corrida:") },
            confirmButton = {
                TextButton(onClick = {
                    mostrarOpcoesFoto = false
                    galeriaLauncher.launch(PickVisualMediaRequest(ActivityResultContracts.PickVisualMedia.ImageOnly))
                }) { Text("Galeria") }
            },
            dismissButton = {
                TextButton(onClick = {
                    mostrarOpcoesFoto = false
                    permissaoLauncher.launch(Manifest.permission.CAMERA)
                }) { Text("Câmera") }
            }
        )
    }

    if (showDiscardDialog) {
        AlertDialog(
            onDismissRequest = { showDiscardDialog = false },
            title = { Text("Sair sem postar?") },
            text = { Text("Se você sair agora, essa corrida ficará salva no seu histórico, mas não será publicada no Feed.") },
            confirmButton = {
                TextButton(
                    onClick = {
                        showDiscardDialog = false
                        onFinishNavigation()
                    },
                    colors = ButtonDefaults.textButtonColors(contentColor = Color.Red)
                ) { Text("Sair") }
            },
            dismissButton = {
                TextButton(onClick = { showDiscardDialog = false }) { Text("Continuar Editando") }
            }
        )
    }
}


@Composable
fun StatItem(valor: String, unidade: String) {
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Text(
            text = valor,
            fontWeight = FontWeight.Bold,
            fontSize = if (valor.length > 5) 17.sp else 20.sp,
            color = Color.Black,
            maxLines = 1,
            softWrap = false,
            overflow = TextOverflow.Visible
        )
        Text(text = unidade, fontSize = 12.sp, color = Color.Gray)
    }
}

private fun criarUriParaPost(context: Context): Uri {
    val arquivo = File.createTempFile(
        "foto_corrida_",
        ".jpg",
        context.cacheDir
    ).apply {
        createNewFile()
        deleteOnExit()
    }
    return FileProvider.getUriForFile(
        context,
        "${context.packageName}.provider",
        arquivo
    )
}

@Preview(showBackground = true)
@Composable
fun PreviewRunFinished() {
    PegaPistaTheme {
        RunFinishedScreen(
            distancia = 5.2,
            tempo = "00:30:00",
            pace = "05:45"
        )
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/components/SnapshotMap.kt ===

package com.example.pegapista.ui.components

import android.content.Context
import android.net.Uri
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import com.example.pegapista.R
import com.example.pegapista.ui.theme.BluePrimary
import com.example.pegapista.utils.MapUtils
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.model.JointType
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.MapStyleOptions
import com.google.android.gms.maps.model.RoundCap
import com.google.maps.android.compose.*
import androidx.compose.foundation.layout.aspectRatio
import androidx.compose.foundation.layout.fillMaxWidth

@Composable
fun SnapshotMap(
    caminhoPercorrido: List<LatLng>,
    context: Context,
    onSnapshotPronto: (Uri) -> Unit
) {
    var snapshotTirado by remember { mutableStateOf(false) }

    val cameraPositionState = rememberCameraPositionState()

    GoogleMap(
        modifier = Modifier
            .fillMaxWidth()
            .aspectRatio(4f / 4),
        cameraPositionState = cameraPositionState,
        properties = MapProperties(
            mapType = MapType.NORMAL,
            mapStyleOptions = MapStyleOptions.loadRawResourceStyle(context, R.raw.map_style_clean)
        ),
        uiSettings = MapUiSettings(
            zoomControlsEnabled = false,
            scrollGesturesEnabled = false,
            zoomGesturesEnabled = false,
            rotationGesturesEnabled = false,
            mapToolbarEnabled = false
        )
    ) {
        Polyline(
            points = caminhoPercorrido,
            color = BluePrimary,
            width = 7f,
            jointType = JointType.ROUND,
            startCap = RoundCap(),
            endCap = RoundCap()
        )

        MapEffect(caminhoPercorrido) { map ->
            if (!snapshotTirado) {
                val bounds = MapUtils.calcularEnquadramento(caminhoPercorrido)
                if (bounds != null) {
                    try {
                        map.moveCamera(CameraUpdateFactory.newLatLngBounds(bounds, 50))
                        map.setOnMapLoadedCallback {
                            map.snapshot { bitmap ->
                                if (bitmap != null) {
                                    val uri = MapUtils.salvarBitmapTemporario(context, bitmap)
                                    snapshotTirado = true
                                    map.setOnMapLoadedCallback(null)
                                    onSnapshotPronto(uri)
                                }
                            }
                        }
                    } catch (e: Exception) {
                        e.printStackTrace()
                    }
                }
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/components/BottomBar.kt ===

package com.example.pegapista.ui.components

import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.unit.sp

data class BottomItem(
    val route: String,
    val label: String,
    val icon: ImageVector
)

@Composable
fun BottomBar(
    currentRoute: String?,
    onItemClick: (String) -> Unit
) {
    val items = listOf(
        BottomItem("Home", "Início", Icons.Default.Home),
        BottomItem("comunidade", "Comunidade", Icons.Default.Group),
        BottomItem("perfil", "Perfil", Icons.Default.Person),
        BottomItem("AtividadeBefore", "Atividade", Icons.Default.DirectionsRun),
        BottomItem("notificacoes", "Notificações", Icons.Default.Notifications)
    )

    NavigationBar(
        containerColor = MaterialTheme.colorScheme.primary,
        contentColor = MaterialTheme.colorScheme.onPrimary
    ) {
        items.forEach { item ->
            val isSelected = currentRoute == item.route ||
                    (currentRoute == "AtividadeAfter" && item.route == "AtividadeBefore")

            NavigationBarItem(
                selected = isSelected,
                onClick = { onItemClick(item.route) },
                label = { Text(item.label, fontSize = 10.sp, color = Color.White) },
                icon = {
                    Icon(
                        imageVector = item.icon,
                        contentDescription = item.label,
                        tint = if (isSelected) Color.White else Color.White.copy(alpha = 0.6f)
                    )
                },
                colors = NavigationBarItemDefaults.colors(
                    indicatorColor = MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.3f)
                )
            )
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/components/BotaoGoogle.kt ===

package com.example.pegapista.ui.components

import android.app.Activity
import android.util.Log
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.Image
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.pegapista.R // Certifique-se de ter um icone do google ou remova a Image
import com.google.android.gms.auth.api.signin.GoogleSignIn
import com.google.android.gms.auth.api.signin.GoogleSignInOptions
import com.google.android.gms.common.api.ApiException

@Composable
fun BotaoGoogle(
    onGoogleSignInSelected: (String) -> Unit,
    onError: (String) -> Unit
) {
    val context = LocalContext.current

    val WEB_CLIENT_ID = "800822141654-gvr2uinlf53fq85lb6s012qa1trvcl0t.apps.googleusercontent.com"

    val googleSignInClient = remember {
        val gso = GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)
            .requestIdToken(WEB_CLIENT_ID)
            .requestEmail()
            .build()
        GoogleSignIn.getClient(context, gso)
    }

    val launcher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.StartActivityForResult()
    ) { result ->
        if (result.resultCode == Activity.RESULT_OK) {
            val task = GoogleSignIn.getSignedInAccountFromIntent(result.data)
            try {
                val account = task.getResult(ApiException::class.java)
                account?.idToken?.let { token ->
                    onGoogleSignInSelected(token)
                } ?: onError("Token Google nulo")
            } catch (e: ApiException) {
                Log.e("GoogleLogin", "Google sign in failed", e)
                onError("Falha Google: ${e.statusCode}")
            }
        }
    }

    Button(
        onClick = {
            launcher.launch(googleSignInClient.signInIntent)
        },
        modifier = Modifier
            .padding(horizontal = 30.dp)
            .shadow(4.dp, RoundedCornerShape(12.dp), clip = false)
            .height(50.dp)
            .fillMaxWidth(),
        shape = RoundedCornerShape(12.dp),
        colors = ButtonDefaults.buttonColors(
            containerColor = Color.White
        )
    ) {
        Image(
            painter = painterResource(id = R.drawable.ic_google),
            contentDescription = "Logo Google",
            modifier = Modifier.size(24.dp)
         )
        Spacer(modifier = Modifier.width(8.dp))

        Text("Entrar com Google", color = Color.Black, fontSize = 15.sp, fontWeight = FontWeight.Bold)
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/components/MapaEmTempoReal.kt ===

package com.example.pegapista.ui.components

import android.Manifest
import android.annotation.SuppressLint
import android.content.pm.PackageManager
import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.core.content.ContextCompat
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.pegapista.R
import com.example.pegapista.service.RunningState
import com.example.pegapista.ui.theme.BluePrimary
import com.example.pegapista.ui.viewmodels.CorridaViewModel
import com.google.android.gms.location.LocationServices
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.model.CameraPosition
import com.google.android.gms.maps.model.JointType
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.MapStyleOptions
import com.google.android.gms.maps.model.RoundCap
import com.google.maps.android.compose.*

@SuppressLint("MissingPermission")
@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun MapaEmTempoReal(
    viewModel: CorridaViewModel = viewModel(),
    ) {
    val context = LocalContext.current
    val caminhoPercorrido by RunningState.percurso.collectAsState()
    val pontoInicial by viewModel.localizacaoInicial.collectAsState()

    val cameraPositionState = rememberCameraPositionState()
    var cameraJaAjustada by remember { mutableStateOf(false) }

    val temPermissao = remember {
        ContextCompat.checkSelfPermission(
            context,
            Manifest.permission.ACCESS_FINE_LOCATION
        ) == PackageManager.PERMISSION_GRANTED
    }
    LaunchedEffect(pontoInicial) {
        if (!cameraJaAjustada && caminhoPercorrido.isEmpty()) {
            pontoInicial?.let { latLng ->
                cameraPositionState.position = CameraPosition.fromLatLngZoom(latLng, 17f)
                cameraJaAjustada = true
            }
        }
    }

    LaunchedEffect(caminhoPercorrido) {
        if (caminhoPercorrido.isNotEmpty()) {
            val ultimoPonto = caminhoPercorrido.last()

            if (!cameraJaAjustada) {
                cameraPositionState.position = CameraPosition.fromLatLngZoom(ultimoPonto, 17f)
                cameraJaAjustada = true            } else {
                cameraPositionState.animate(
                    CameraUpdateFactory.newLatLng(ultimoPonto),
                    1000
                )
            }
        }
    }

    GoogleMap(
        modifier = Modifier.fillMaxSize(),
        cameraPositionState = cameraPositionState,
        properties = MapProperties(
            isMyLocationEnabled = temPermissao,
            mapStyleOptions = MapStyleOptions.loadRawResourceStyle(context, R.raw.map_style_clean)
        ),
        uiSettings = MapUiSettings(
            zoomControlsEnabled = false,
            myLocationButtonEnabled = true,
            compassEnabled = true
        )
    ) {
        if (caminhoPercorrido.isNotEmpty()) {
            Polyline(
                points = caminhoPercorrido,
                color = BluePrimary,
                width = 8f,
                jointType = JointType.ROUND,
                startCap = RoundCap(),
                endCap = RoundCap()
            )
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/theme/Type.kt ===

package com.example.pegapista.ui.theme
import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

val AppTypography = Typography(

    // Títulos grandes (ex: telas de login, cabeçalhos)
    headlineLarge = TextStyle(
        fontWeight = FontWeight.SemiBold,
        fontSize = 28.sp,
        lineHeight = 34.sp
    ),

    // Títulos médios (ex: cards, seções)
    titleLarge = TextStyle(
        fontWeight = FontWeight.SemiBold,
        fontSize = 22.sp,
        lineHeight = 28.sp
    ),

    // Subtítulos (ex: textos importantes maiores)
    titleMedium = TextStyle(
        fontWeight = FontWeight.Medium,
        fontSize = 18.sp,
        lineHeight = 24.sp
    ),

    // Texto padrão do app
    bodyLarge = TextStyle(
        fontWeight = FontWeight.Normal,
        fontSize = 16.sp,
        lineHeight = 22.sp
    ),

    // Texto pequeno (ex: inputs, descrições)
    bodyMedium = TextStyle(
        fontWeight = FontWeight.Normal,
        fontSize = 14.sp,
        lineHeight = 20.sp
    ),

    // Labels de botões e navegação
    labelLarge = TextStyle(
        fontWeight = FontWeight.Medium,
        fontSize = 14.sp,
        lineHeight = 18.sp
    ),

    // Labels menores (ex: placeholder, detalhes)
    labelMedium = TextStyle(
        fontWeight = FontWeight.Medium,
        fontSize = 12.sp,
        lineHeight = 16.sp
    )
)


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/theme/Theme.kt ===

package com.example.pegapista.ui.theme

import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable

private val LightColors = lightColorScheme(
    primary = BluePrimary,
    onPrimary = OnPrimaryLight,

    background = BackgroundLight,
    onBackground = OnBackgroundLight,

    surface = SurfaceLight,
    onSurface = OnBackgroundLight,

    error = ErrorRed,
    onError = OnError
)

private val DarkColors = darkColorScheme(
    primary = BluePrimaryDark,
    onPrimary = OnPrimaryDark,

    background = BackgroundDark,
    onBackground = OnBackgroundDark,

    surface = SurfaceDark,
    onSurface = OnBackgroundDark,

    error = ErrorRed,
    onError = OnError
)

@Composable
fun PegaPistaTheme(
    darkTheme: Boolean = false,
    content: @Composable () -> Unit
) {
    MaterialTheme(
        colorScheme = if (darkTheme) DarkColors else LightColors,
        typography = AppTypography,
        shapes = MaterialTheme.shapes,
        content = content
    )
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/ui/theme/Color.kt ===

package com.example.pegapista.ui.theme

import androidx.compose.ui.graphics.Color

// Paleta principal PegaPista
val BluePrimary = Color(0xFF049AF5)
val BluePrimaryDark = Color(0xFF006CA8)     // derivado (30% mais escuro)
val BluePrimaryLight = Color(0xFF4FC3F7)    // derivado (mais claro)

// Fundos
val BackgroundLight = Color(0xFFFFFFFF)
val SurfaceLight = Color(0xFFFFFFFF)

val BackgroundDark = Color(0xFF121212)
val SurfaceDark = Color(0xFF1E1E1E)

// Texto
val OnPrimaryLight = Color(0xFFFFFFFF)
val OnPrimaryDark = Color(0xFFFFFFFF)

val OnBackgroundLight = Color(0xFF000000)
val OnBackgroundDark = Color(0xFFFFFFFF)

// Erros (Material padrão)
val ErrorRed = Color(0xFFB00020)
val OnError = Color(0xFFFFFFFF)


=== ARQUIVO: app/src/main/java/com/example/pegapista/di/KoinModules.kt ===

package com.example.pegapista.di

import org.koin.dsl.module
import org.koin.android.ext.koin.androidContext
import org.koin.android.ext.koin.androidApplication
import org.koin.androidx.viewmodel.dsl.viewModel
import com.example.pegapista.data.local.AppDatabase
import com.example.pegapista.data.repository.CorridaRepository
import com.example.pegapista.data.repository.PostRepository
import com.example.pegapista.data.repository.UserRepository
import com.example.pegapista.ui.viewmodels.CorridaViewModel
import com.example.pegapista.ui.viewmodels.PerfilUsuarioViewModel
import com.example.pegapista.ui.viewmodels.PerfilViewModel
import com.example.pegapista.ui.viewmodels.PostViewModel

val storageModule = module {
    single { AppDatabase.getDatabase(androidContext()) }

    single {
        CorridaRepository(
            db = get(),
            context = androidContext()
        )
    }

    single {
        PostRepository(
            db = get(),
            context = androidContext()
        )
    }
    single {
        UserRepository()
    }
}

val viewModelModule = module {


    viewModel { CorridaViewModel(androidApplication()) }


    viewModel { PostViewModel(androidApplication(), get()) }

    viewModel { PerfilUsuarioViewModel(get()) }

    viewModel { PerfilViewModel(get()) }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/worker/SyncCorridasWorker.kt ===

package com.example.pegapista.worker

import android.content.Context
import androidx.work.CoroutineWorker
import androidx.work.WorkerParameters
import com.example.pegapista.data.local.AppDatabase
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await

class SyncCorridasWorker(context: Context, params: WorkerParameters) : CoroutineWorker(context, params) {

    override suspend fun doWork(): Result {
        val dao = AppDatabase.getDatabase(applicationContext).corridaDao()
        val naoSincronizadas = dao.getCorridasNaoSincronizadas()
        val dbFirestore = FirebaseFirestore.getInstance()

        return try {
            naoSincronizadas.forEach { corrida ->

                dbFirestore.collection("corridas")
                    .document(corrida.id)
                    .set(corrida)
                    .await()


                dao.atualizarCorrida(corrida.copy(sincronizado = true))
            }
            Result.success()
        } catch (e: Exception) {
            e.printStackTrace()
            Result.retry()
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/worker/LembreteWorker.kt ===

package com.example.pegapista.worker

import android.content.Context
import androidx.work.Worker
import androidx.work.WorkerParameters
import com.example.pegapista.utils.showNotification

class LembreteWorker(context: Context, workerParams: WorkerParameters) : Worker(context, workerParams) {

    override fun doWork(): Result {
        val mensagens = listOf(
            "Não perca o foco! Que tal uma corrida hoje?",
            "Sua meta está te esperando. Vamos correr?",
            "O dia está ótimo para bater seus recordes!",
            "Lembre-se: constância é a chave do sucesso."
        )

        val mensagemAleatoria = mensagens.random()

        try {
            showNotification(
                applicationContext,
                "Hora de se mexer! 🏃",
                mensagemAleatoria
            )
            return Result.success()
        } catch (e: Exception) {
            return Result.failure()
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/worker/SyncPostagemWorker.kt ===

package com.example.pegapista.worker

import android.content.Context
import android.net.Uri
import android.util.Log
import androidx.work.CoroutineWorker
import androidx.work.WorkerParameters
import com.example.pegapista.data.local.AppDatabase
import com.google.firebase.firestore.FieldValue
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.storage.FirebaseStorage
import kotlinx.coroutines.tasks.await
import java.io.File

class SyncPostagemWorker(
    context: Context,
    workerParams: WorkerParameters
) : CoroutineWorker(context, workerParams) {

    private val db = AppDatabase.getDatabase(context)
    private val postagemDao = db.postagemDao()
    private val remoteDb = FirebaseFirestore.getInstance()
    private val storage = FirebaseStorage.getInstance()

    override suspend fun doWork(): Result {
        return try {
            val postsNaoSincronizados = postagemDao.getPostagemNaoSincronizada()

            if (postsNaoSincronizados.isEmpty()) {
                return Result.success()
            }

            for (entity in postsNaoSincronizados) {

                val urlsNaNuvem = mutableListOf<String>()
                val listaCaminhosLocais = if (entity.fotoUrl.isNullOrBlank()) {
                    emptyList()
                } else {
                    entity.fotoUrl.split(";")
                }

                for (caminhoLocal in listaCaminhosLocais) {
                    try {
                        val arquivo = File(caminhoLocal)
                        if (arquivo.exists()) {
                            val uriArquivo = Uri.fromFile(arquivo)
                            val storageRef = storage.reference.child("posts/${entity.id}/${arquivo.name}")

                            storageRef.putFile(uriArquivo).await()
                            val downloadUrl = storageRef.downloadUrl.await().toString()

                            urlsNaNuvem.add(downloadUrl)
                        }
                    } catch (e: Exception) {
                        e.printStackTrace()
                    }
                }

                val postHashMap = hashMapOf(
                    "id" to entity.id,
                    "userId" to entity.userId,
                    "autorNome" to entity.autorNome,
                    "titulo" to entity.titulo,
                    "descricao" to entity.descricao,
                    "corrida" to hashMapOf(
                        "distanciaKm" to entity.distanciaKm,
                        "tempo" to entity.tempo,
                        "pace" to entity.pace
                    ),
                    "data" to entity.data,
                    "curtidas" to emptyList<String>(),
                    "qtdComentarios" to 0,
                    "urlsFotos" to urlsNaNuvem
                )

                remoteDb.collection("posts").document(entity.id)
                    .set(postHashMap)
                    .await()

                try {
                    val distKm = entity.distanciaKm
                    val tempoSegundos = converterTempoParaSegundos(entity.tempo)
                    val calorias = (distKm * 70).toLong() // Estimativa: 70kcal por km

                    val updates = mapOf(
                        "distanciaTotalKm" to FieldValue.increment(distKm),
                        "tempoTotalSegundos" to FieldValue.increment(tempoSegundos),
                        "caloriasQueimadas" to FieldValue.increment(calorias),
                        "ultimaAtividade" to System.currentTimeMillis()
                    )

                    remoteDb.collection("usuarios").document(entity.userId)
                        .update(updates)
                        .await()

                    Log.d("SyncWorker", "Estatísticas atualizadas para o usuário ${entity.userId}")

                } catch (e: Exception) {
                    Log.e("SyncWorker", "Erro ao somar estatísticas: ${e.message}")

                }

                val postAtualizado = entity.copy(postsincronizado = true)
                postagemDao.salvarPostagem(postAtualizado)
            }

            Result.success()
        } catch (e: Exception) {
            e.printStackTrace()
            Result.retry()
        }
    }

    private fun converterTempoParaSegundos(tempoStr: String): Long {
        return try {
            val partes = tempoStr.split(":").map { it.toLong() }
            when (partes.size) {
                3 -> partes[0] * 3600 + partes[1] * 60 + partes[2]
                2 -> partes[0] * 60 + partes[1]
                else -> 0L
            }
        } catch (e: Exception) {
            0L
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/worker/SyncUsersWorker.kt ===

package com.example.pegapista.worker

import android.content.Context
import androidx.work.CoroutineWorker
import androidx.work.WorkerParameters
import com.example.pegapista.data.local.AppDatabase
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await

class SyncUsersWorker(context: Context, params: WorkerParameters): CoroutineWorker(context,params) {
    override suspend fun doWork(): Result {
        val dao = AppDatabase.getDatabase(applicationContext).userDao()
        val usersNaoSincronizados = dao.getUsernaoSincronizados()
        val dbFirestore = FirebaseFirestore.getInstance()
        return try {
            usersNaoSincronizados.forEach { userEntity ->
                dbFirestore.collection("users")
                    .document(userEntity.id)
                    .set(userEntity)
                    .await()
                dao.atualizarUser(userEntity.copy(userSincronizado = true))
            }
            Result.success()
        } catch (e: Exception) {
            e.printStackTrace()
            Result.retry()
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/repository/UserRepository.kt ===

package com.example.pegapista.data.repository

import com.example.pegapista.data.models.Usuario
import com.example.pegapista.utils.DateUtils
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FieldValue
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await

class UserRepository {

    private val db = FirebaseFirestore.getInstance()
    private val auth = FirebaseAuth.getInstance()
    private val usersRef = db.collection("usuarios")

    suspend fun getUsuarioAtual(): Usuario {
        val firebaseUser = auth.currentUser ?: throw Exception("Não logado")
        val uid = firebaseUser.uid

        val snapshot = usersRef.document(uid).get().await()

        return if (snapshot.exists()) {
            snapshot.toObject(Usuario::class.java)!!.copy(id = uid)
        } else {
            val novoUsuario = Usuario(
                id = uid,
                nickname = firebaseUser.displayName ?: "Atleta PegaPista",
                email = firebaseUser.email ?: "",
                fotoPerfilUrl = firebaseUser.photoUrl?.toString()
            )
            usersRef.document(uid).set(novoUsuario).await()
            novoUsuario
        }
    }

    suspend fun atualizarSequenciaDiaria() {
        val uid = auth.currentUser?.uid ?: return
        val snapshot = usersRef.document(uid).get().await()
        val usuario = snapshot.toObject(Usuario::class.java) ?: return

        val agora = System.currentTimeMillis()
        val ultimaAtiv = usuario.ultimaAtividade

        if (DateUtils.isMesmoDia(agora, ultimaAtiv)) return

        val novaSequencia = if (DateUtils.isOntem(ultimaAtiv)) {
            usuario.diasSeguidos + 1
        } else {
            1
        }

        // Verifica recorde
        val novoRecorde = if (novaSequencia > usuario.recordeDiasSeguidos) {
            novaSequencia
        } else {
            usuario.recordeDiasSeguidos
        }

        // Salva no Firestore
        usersRef.document(uid).update(
            mapOf(
                "diasSeguidos" to novaSequencia,
                "recordeDiasSeguidos" to novoRecorde,
                "ultimaAtividade" to agora
            )
        ).await()
    }

    suspend fun getUsuarioPorId(userId: String): Usuario? {
        return try {
            val snapshot = usersRef.document(userId).get().await()
            if (snapshot.exists()) {
                snapshot.toObject(Usuario::class.java)?.copy(id = userId)
            } else {
                null
            }
        } catch (e: Exception) {
            null
        }
    }


    //BUSCAR USUARIO, TELA DE BUSCA - JULIO EMANUEL

    suspend fun buscarUsuarios(termo: String): List<Usuario> {
        if (termo.isBlank()) return emptyList()

        return try {
            val snapshot = usersRef
                .whereGreaterThanOrEqualTo("nickname", termo)
                .whereLessThanOrEqualTo("nickname", termo + "\uf8ff")
                .limit(20)
                .get()
                .await()

            snapshot.toObjects(Usuario::class.java)
        } catch (e: Exception) {
            emptyList()
        }
    }

    suspend fun getUsuariosSugestao(): List<Usuario> {
        return try {
            val snapshot = usersRef
                .limit(10)
                .get()
                .await()

            snapshot.toObjects(Usuario::class.java)
        } catch (e: Exception) {
            emptyList()
        }
    }


    // LOGICA DE SEGUIR (RELACIONAMENTOS) - JULIO EMANUEL

    // --- ATUALIZE ESSA PARTE (LOGICA DE SEGUIR) ---

    suspend fun seguirUsuario(idAmigo: String): Boolean {
        val meuId = auth.currentUser?.uid ?: return false
        return try {
            val batch = db.batch()

            val euSeguindoRef = db.collection("usuarios").document(meuId)
                .collection("seguindo").document(idAmigo)
            batch.set(euSeguindoRef, mapOf("data" to System.currentTimeMillis()))

            val amigoSeguidoresRef = db.collection("usuarios").document(idAmigo)
                .collection("seguidores").document(meuId)
            batch.set(amigoSeguidoresRef, mapOf("data" to System.currentTimeMillis()))

            val meuPerfilRef = db.collection("usuarios").document(meuId)
            batch.update(meuPerfilRef, "seguindo", FieldValue.increment(1))

            val amigoRef = db.collection("usuarios").document(idAmigo)
            batch.update(amigoRef, "seguidores", FieldValue.increment(1))

            batch.commit().await()
            true
        } catch (e: Exception) {
            e.printStackTrace()
            false
        }
    }

    suspend fun deixarDeSeguirUsuario(idAmigo: String): Boolean {
        val meuId = auth.currentUser?.uid ?: return false
        return try {
            val batch = db.batch()

            val euSeguindoRef = db.collection("usuarios").document(meuId)
                .collection("seguindo").document(idAmigo)
            batch.delete(euSeguindoRef)

            val amigoSeguidoresRef = db.collection("usuarios").document(idAmigo)
                .collection("seguidores").document(meuId)
            batch.delete(amigoSeguidoresRef)

            val meuPerfilRef = db.collection("usuarios").document(meuId)
            batch.update(meuPerfilRef, "seguindo", FieldValue.increment(-1))

            val amigoRef = db.collection("usuarios").document(idAmigo)
            batch.update(amigoRef, "seguidores", FieldValue.increment(-1))

            batch.commit().await()
            true
        } catch (e: Exception) {
            e.printStackTrace()
            false
        }
    }

    suspend fun verificarSeSegue(idAmigo: String): Boolean {
        val meuId = auth.currentUser?.uid ?: return false
        return try {
            val doc = db.collection("usuarios").document(meuId)
                .collection("seguindo").document(idAmigo)
                .get()
                .await()
            doc.exists()
        } catch (e: Exception) {
            false
        }
    }

    suspend fun getIdsSeguindo(): List<String> {
        val meuId = auth.currentUser?.uid ?: return emptyList()

        return try {
            val snapshot = db.collection("usuarios").document(meuId)
                .collection("seguindo")
                .get()
                .await()
            snapshot.documents.map { it.id }
        } catch (e: Exception) {
            emptyList()
        }
    }

    suspend fun getRankingSeguindo(): List<Usuario> {
        return try {
            val idsSeguindo = getIdsSeguindo()
            val meuId = auth.currentUser?.uid ?: return emptyList()

            val todosIds = idsSeguindo.toMutableList().apply { add(meuId) }

            if (todosIds.isEmpty()) return emptyList()

            val snapshot = usersRef
                .whereIn("id", todosIds)
                .get()
                .await()

            snapshot.toObjects(Usuario::class.java)
                .sortedByDescending { it.diasSeguidos }
        } catch (e: Exception) {
            emptyList()
        }
    }

    //SALVAR CORRIDA E INFORMACOES

    suspend fun somarEstatisticasCorrida(distanciaKm: Double, tempoSegundos: Long, calorias: Int) {
        val uid = auth.currentUser?.uid ?: return

        try {
            val updates = mapOf(
                "distanciaTotalKm" to FieldValue.increment(distanciaKm),
                "tempoTotalSegundos" to FieldValue.increment(tempoSegundos),
                "caloriasQueimadas" to FieldValue.increment(calorias.toLong()),
            )
            usersRef.document(uid).update(updates).await()
            atualizarSequenciaDiaria()

        } catch (e: Exception) {
            e.printStackTrace()
        }
    }


    suspend fun getListaSeguindo(userId: String): List<Usuario> {
        return try {
            val snapshot = db.collection("usuarios").document(userId)
                .collection("seguindo")
                .get()
                .await()

            val ids = snapshot.documents.map { it.id }
            if (ids.isEmpty()) return emptyList()

            buscarUsuariosPorIds(ids)
        } catch (e: Exception) {
            e.printStackTrace()
            emptyList()
        }
    }

    suspend fun getListaSeguidores(userId: String): List<Usuario> {
        return try {
            val snapshot = db.collection("usuarios").document(userId)
                .collection("seguidores")
                .get()
                .await()

            val ids = snapshot.documents.map { it.id }
            if (ids.isEmpty()) return emptyList()

            buscarUsuariosPorIds(ids)
        } catch (e: Exception) {
            e.printStackTrace()
            emptyList()
        }
    }

    private suspend fun buscarUsuariosPorIds(ids: List<String>): List<Usuario> {
        val usuariosEncontrados = mutableListOf<Usuario>()

        val lotes = ids.chunked(10)

        for (lote in lotes) {
            val snapshot = usersRef.whereIn("id", lote).get().await()
            val usuariosDoLote = snapshot.toObjects(Usuario::class.java)
            usuariosEncontrados.addAll(usuariosDoLote)
        }

        return usuariosEncontrados
    }


}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/repository/PostRepository.kt ===

package com.example.pegapista.data.repository

import android.content.Context
import android.os.Build
import androidx.annotation.RequiresApi
import androidx.work.*
import com.example.pegapista.data.models.Comentario
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.data.local.AppDatabase
import com.example.pegapista.data.local.entities.PostagemEntity
import com.example.pegapista.worker.SyncPostagemWorker
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FieldValue
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.Query
import kotlinx.coroutines.tasks.await
import java.util.UUID

class PostRepository(
    private val db: AppDatabase,
    private val context: Context
) {
    private val auth = FirebaseAuth.getInstance()
    private val postagemDao = db.postagemDao()
    private val workManager = WorkManager.getInstance(context)
    private val remoteDb = FirebaseFirestore.getInstance()


    suspend fun criarPost(postagem: Postagem): Result<Boolean> {
        return try {
            val user = auth.currentUser ?: throw Exception("Usuário não logado")

            val fotosConcatenadas = postagem.urlsFotos.joinToString(separator = ";")

            val entity = PostagemEntity(
                id = postagem.id.ifEmpty { UUID.randomUUID().toString() },
                userId = user.uid,
                autorNome = postagem.autorNome.ifBlank { user.displayName ?: "Corredor" },
                titulo = postagem.titulo,
                descricao = postagem.descricao,
                distanciaKm = postagem.corrida.distanciaKm,
                tempo = postagem.corrida.tempo,
                pace = postagem.corrida.pace,
                data = System.currentTimeMillis(),

                fotoUrl = fotosConcatenadas,

                postsincronizado = false
            )

            postagemDao.salvarPostagem(entity)
     //       android.util.Log.d("SYNC_DEBUG", "0.5. Salvo no Room com sucesso!")

            agendarSincronizacao()

            Result.success(true)
        } catch (e: Exception) {
            e.printStackTrace()
            Result.failure(e)
        }
    }

    private fun agendarSincronizacao() {
        val constraints = Constraints.Builder()
            .setRequiredNetworkType(NetworkType.CONNECTED)
            .build()

        val syncRequest = OneTimeWorkRequestBuilder<SyncPostagemWorker>()
            .setConstraints(constraints)
            .build()

        workManager.enqueueUniqueWork(
            "sync_postagens",
            ExistingWorkPolicy.REPLACE,
            syncRequest
        )
    }

    fun gerarIdPost(): String = UUID.randomUUID().toString()

    suspend fun excluirPost(postId: String): Result<Unit> {
        return try {
            remoteDb.collection("posts").document(postId).delete().await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    suspend fun getFeedPosts(listaIds: List<String>): List<Postagem> {
        if (listaIds.isEmpty()) return emptyList()
        return try {
            val snapshot = remoteDb.collection("posts")
                .whereIn("userId", listaIds)
                .orderBy("data", Query.Direction.DESCENDING)
                .limit(10)
                .get()
                .await()

            snapshot.toObjects(Postagem::class.java)
        } catch (e: Exception) {
            android.util.Log.e("FEED_ERRO", "Erro: ${e.message}")
            emptyList()
        }
    }

    @RequiresApi(Build.VERSION_CODES.O)
    suspend fun getPostsPorUsuario(userId: String): List<Postagem> {
        return try {
            val snapshot = remoteDb.collection("posts")
                .whereEqualTo("userId", userId)
                .orderBy("data", com.google.firebase.firestore.Query.Direction.DESCENDING)
                .get()
                .await()
            snapshot.toObjects(Postagem::class.java)
        } catch (e: Exception) {
            emptyList()
        }
    }

    // CURTIDA E COMENTARIOS - JULIO EMANUEL

    suspend fun toggleCurtida(postId: String, userId: String, jaCurtiu: Boolean): Boolean {
        return try {
            val postRef = remoteDb.collection("posts").document(postId)

            if (jaCurtiu) {
                postRef.update("curtidas", FieldValue.arrayRemove(userId)).await()
            } else {
                postRef.update("curtidas", FieldValue.arrayUnion(userId)).await()
            }
            true
        } catch (e: Exception) {
            false
        }
    }

    suspend fun enviarComentario(postId: String, comentario: Comentario): Boolean {
        return try {
            val batch = remoteDb.batch()
            val novoComentarioRef = remoteDb.collection("posts").document(postId)
                .collection("comentarios").document()

            batch.set(novoComentarioRef, comentario)

            val postRef = remoteDb.collection("posts").document(postId)
            batch.update(postRef, "qtdComentarios", FieldValue.increment(1))

            batch.commit().await()
            true
        } catch (e: Exception) {
            e.printStackTrace()
            false
        }
    }

    suspend fun getComentarios(postId: String): List<Comentario> {
        return try {
            val snapshot = remoteDb.collection("posts").document(postId)
                .collection("comentarios")
                .orderBy("data")
                .get()
                .await()
            snapshot.toObjects(Comentario::class.java)
        } catch (e: Exception) {
            emptyList()
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/repository/CorridaRepository.kt ===

package com.example.pegapista.data.repository

import android.content.Context
import androidx.work.*
import com.example.pegapista.data.models.Corrida
import com.example.pegapista.data.local.AppDatabase
import com.example.pegapista.data.local.dao.toEntity
import com.example.pegapista.worker.SyncCorridasWorker
import com.google.firebase.auth.FirebaseAuth
import java.util.UUID

class CorridaRepository(
    private val db: AppDatabase,
    private val context: Context
) {
    private val auth = FirebaseAuth.getInstance()
    private val workManager = WorkManager.getInstance(context)

    suspend fun salvarCorrida(corrida: Corrida): Result<Boolean> {
        return try {
            val user = auth.currentUser ?: throw Exception("Usuário não logado")

            val entity = corrida.toEntity().copy(
                userId = user.uid,
                sincronizado = false
            )
            db.corridaDao().salvarCorrida(entity)
            agendarSincronizacao()


            Result.success(true)
        } catch (e: Exception) {
            e.printStackTrace()
            Result.failure(e)
        }
    }

    private fun agendarSincronizacao() {
        val constraints = Constraints.Builder()
            .setRequiredNetworkType(NetworkType.CONNECTED)
            .build()

        val syncRequest = OneTimeWorkRequestBuilder<SyncCorridasWorker>()
            .setConstraints(constraints)
            .build()

        workManager.enqueueUniqueWork(
            "sync_corridas",
            ExistingWorkPolicy.KEEP,
            syncRequest
        )
    }

    fun gerarIdCorrida(): String {
        return UUID.randomUUID().toString()
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/repository/NotificationRepository.kt ===

package com.example.pegapista.data.repository

import com.example.pegapista.data.models.Notificacao
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await

class NotificationRepository {
    private val auth = FirebaseAuth.getInstance()
    private val db = FirebaseFirestore.getInstance()

    suspend fun criarNotificacao(notificacao: Notificacao) {
        db.collection("notificacoes").add(notificacao).await()
    }

    suspend fun excluirNotificacao(notificacaoId: String) {
        try {
            db.collection("notificacoes").document(notificacaoId).delete().await()
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    suspend fun limparTodasNotificacoes(userId: String) {
        try {
            val snapshot = db.collection("notificacoes")
                .whereEqualTo("destinatarioId", userId)
                .get()
                .await()

            val batch = db.batch()
            for (document in snapshot.documents) {
                batch.delete(document.reference)
            }
            batch.commit().await()
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/repository/AuthRepository.kt ===

package com.example.pegapista.data.repository

import com.example.pegapista.data.models.Usuario
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.auth.GoogleAuthProvider
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.SetOptions
import com.google.firebase.messaging.FirebaseMessaging
import kotlinx.coroutines.tasks.await


class AuthRepository {

    private val auth = FirebaseAuth.getInstance()

    fun signOut() {
        auth.signOut()
    }
    private val db = FirebaseFirestore.getInstance()

    suspend fun login(email: String, senha: String): Result<Boolean> {
        return try {
            auth.signInWithEmailAndPassword(email, senha).await()
            salvarFcmToken()
            Result.success(true)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    suspend fun cadastrar(nome: String, email: String, senha: String): Result<Boolean> {
        return try {
            val authResult = auth.createUserWithEmailAndPassword(email, senha).await()
            val user = authResult.user ?: throw Exception("Erro ao criar usuário")

            val novoUsuario = Usuario(
                id = user.uid,
                nickname = nome,
                email = email,
            )

            db.collection("usuarios").document(user.uid).set(novoUsuario).await()
            salvarFcmToken()
            Result.success(true)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    //GOOGLE

    suspend fun loginComGoogle(idToken: String): Result<Boolean> {
        return try {
            val credential = GoogleAuthProvider.getCredential(idToken, null)
            val authResult = auth.signInWithCredential(credential).await()

            val user = authResult.user ?: throw Exception("Usuário nulo")

            val userRef = db.collection("usuarios").document(user.uid)
            val snap = userRef.get().await()
            if (!snap.exists()) {
                val novoUsuario = Usuario(
                    id = user.uid,
                    nickname = user.displayName ?: "Usuário",
                    email = user.email ?: ""
                )
                userRef.set(novoUsuario).await()
            }
            salvarFcmToken()
            Result.success(true)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    fun salvarFcmToken() {
        FirebaseMessaging.getInstance().token
            .addOnSuccessListener { token ->
                val uid = FirebaseAuth.getInstance().currentUser?.uid ?: return@addOnSuccessListener

                FirebaseFirestore.getInstance()
                    .collection("usuarios")
                    .document(uid)
                    .set(
                        mapOf("fcmToken" to token),
                        SetOptions.merge()
                    )
            }
    }


    fun getCurrentUser() = auth.currentUser
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/dao/UserDao.kt ===

package com.example.pegapista.data.local.dao

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query
import androidx.room.Update
import com.example.pegapista.data.models.Usuario
import com.example.pegapista.data.local.entities.UserEntity

@Dao
interface UserDao {
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun salvarUser(user: UserEntity)

    @Query("SELECT * FROM  users WHERE userSincronizado = 0")
    suspend fun getUsernaoSincronizados(): List<UserEntity>

    @Update
    suspend fun atualizarUser(user: UserEntity)
}
fun UserEntity.toModel(): Usuario {
    return Usuario (
        id = this.id,
        nickname = this.nickname,
        email = this.email,
        fotoPerfilUrl = this.fotoPerfilUrl,
        distanciaTotalKm = this.distanciaTotalKm,
        tempoTotalSegundos = this.tempoTotalSegundos,
        caloriasQueimadas = this.caloriasQueimadas,
        diasSeguidos = this.diasSeguidos,
        recordeDiasSeguidos = this.recordeDiasSeguidos
    )
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/dao/CorridaDao.kt ===

package com.example.pegapista.data.local.dao

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query
import androidx.room.Update
import com.example.pegapista.data.models.Corrida
import com.example.pegapista.data.local.entities.CorridaEntity
@Dao
interface CorridaDao {
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun salvarCorrida(corrida: CorridaEntity)

    @Query("SELECT * FROM corridas WHERE sincronizado = 0")
    suspend fun getCorridasNaoSincronizadas(): List<CorridaEntity>

    @Update
    suspend fun atualizarCorrida(corrida: CorridaEntity)

    @Query("SELECT * FROM corridas ORDER BY data DESC")
    suspend fun getTodasCorridas(): List<CorridaEntity>
}

fun CorridaEntity.toModel(): Corrida {
    return Corrida(
        id = this.id,
        distanciaKm = this.distanciaKm,
        tempo = this.tempo,
        pace = this.pace
    )
}

fun Corrida.toEntity(): CorridaEntity {
    return CorridaEntity(
        id = this.id.toString(),
        distanciaKm = this.distanciaKm,
        tempo = this.tempo,
        pace = this.pace,
        sincronizado = false
    )
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/dao/PostagemDao.kt ===

package com.example.pegapista.data.local.dao

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query
import androidx.room.Update
import com.example.pegapista.data.local.entities.PostagemEntity

@Dao
interface PostagemDao {
@Insert(onConflict = OnConflictStrategy.REPLACE)
suspend fun salvarPostagem(postagem: PostagemEntity)

@Query("SELECT * FROM postagem WHERE postsincronizado = 0")
suspend fun getPostagemNaoSincronizada(): List<PostagemEntity>

@Update
suspend fun atualizarPostagem(postagem: PostagemEntity)

@Query("SELECT * FROM postagem ORDER BY data DESC")
suspend fun getTodasPostagem(): List<PostagemEntity>

@Query("SELECT * FROM postagem WHERE userId = :userId ORDER BY data DESC")
suspend fun getPostagensPorUsuario(userId: String): List<PostagemEntity>
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/Converters.kt ===

package com.example.pegapista.data.local

import androidx.room.TypeConverter
import com.example.pegapista.data.models.Corrida
import com.google.gson.Gson

class Converters {
    private val gson = Gson()

    @TypeConverter
    fun fromCorrida(corrida: Corrida): String {
        return gson.toJson(corrida)
    }

    @TypeConverter
    fun toCorrida(corridaString: String): Corrida {
        return gson.fromJson(corridaString, Corrida::class.java)
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/PegaPistaDatabase.kt ===

package com.example.pegapista.data.local

import android.content.Context
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase
import androidx.room.TypeConverters
import com.example.pegapista.data.local.dao.CorridaDao
import com.example.pegapista.data.local.dao.PostagemDao
import com.example.pegapista.data.local.dao.UserDao
import com.example.pegapista.data.local.entities.CorridaEntity
import com.example.pegapista.data.local.entities.PostagemEntity
import com.example.pegapista.data.local.entities.UserEntity


@Database(
    entities = [CorridaEntity::class, PostagemEntity::class, UserEntity::class],
    version = 4
)
@TypeConverters(Converters::class)
abstract class AppDatabase : RoomDatabase() {

    abstract fun corridaDao(): CorridaDao
    abstract fun userDao(): UserDao
    abstract fun postagemDao(): PostagemDao

    companion object {
        @Volatile
        private var INSTANCE: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    "pegapista_db"
                )
                    .fallbackToDestructiveMigration()
                    .build()
                INSTANCE = instance
                instance
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/entities/PostagemEntity.kt ===

package com.example.pegapista.data.local.entities

import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = "postagem")
data class PostagemEntity(
    @PrimaryKey val id: String = "",
    val userId: String = "",
    val autorNome: String = "Corredor",
    val titulo: String = "",
    val descricao: String = "",

    val distanciaKm: Double = 0.0,
    val tempo: String = "00:00",
    val pace: String = "-:--",

    val data: Long = System.currentTimeMillis(),
    val fotoUrl: String? = null,
    val postsincronizado: Boolean = false
)

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/entities/UserEntity.kt ===

package com.example.pegapista.data.local.entities

import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = "users")
data class UserEntity (
    @PrimaryKey
    val id: String = "",
    val nickname: String = "",
    val email: String = "",
    val fotoPerfilUrl: String? = null,
    val distanciaTotalKm: Double = 0.0,
    val tempoTotalSegundos: Long = 0,
    val caloriasQueimadas: Int = 0,
    val diasSeguidos: Int = 0,
    val recordeDiasSeguidos: Int = 0,
    val userSincronizado: Boolean = false
)

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/local/entities/CorridaEntity.kt ===

package com.example.pegapista.data.local.entities

import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = "corridas")data class CorridaEntity(
    @PrimaryKey
    val id: String = "",
    val userId: String = "",
    val distanciaKm: Double = 0.0,
    val tempo: String = "",
    val pace: String = "",
    val data: Long = System.currentTimeMillis(),
    val sincronizado: Boolean = false
)

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/models/Corrida.kt ===

package com.example.pegapista.data.models

import androidx.room.PrimaryKey
import com.google.firebase.Timestamp
import java.util.Date

data class Corrida(
    @PrimaryKey val id: String = "",
    val userId: String = "",
    val distanciaKm: Double = 0.0,
    val tempo: String = "",
    val pace: String = "",
    val data: Long = System.currentTimeMillis(),
    val sincronizado: Boolean = false
)

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/models/Notificacao.kt ===

package com.example.pegapista.data.models

data class Notificacao (
    val id: String = "",
    val destinatarioId: String = "",
    val remetenteId: String = "",
    val remetenteNome: String = "",
    val remetenteFotoUrl: String = "",
    val tipo: TipoNotificacao = TipoNotificacao.SEGUIR,
    val postId: String? = null,
    val mensagem: String = "",
    val lida: Boolean = false,
    val data: Long = System.currentTimeMillis()
)

enum class TipoNotificacao {
    SEGUIR, CURTIDA, COMENTARIO
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/data/models/Comentario.kt ===

package com.example.pegapista.data.models

data class Comentario(
    val id: String = "",
    val userId: String = "",
    val nomeUsuario: String = "",
    val texto: String = "",
    val data: Long = System.currentTimeMillis()
)


=== ARQUIVO: app/src/main/java/com/example/pegapista/data/models/Usuario.kt ===

package com.example.pegapista.data.models

data class Usuario(
    val id: String = "",
    val nickname: String = "",
    val email: String = "",
    val fotoPerfilUrl: String? = null,
    val distanciaTotalKm: Double? = 0.0,
    val tempoTotalSegundos: Long = 0,
    val caloriasQueimadas: Int = 0,
    val diasSeguidos: Int = 0,
    val recordeDiasSeguidos: Int = 0,
    val ultimaAtividade: Long = 0,
    val seguidores: Int = 0,
    val seguindo: Int = 0
)

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/models/Postagem.kt ===

package com.example.pegapista.data.models

data class Postagem(
    val id: String = "",
    val userId: String = "",
    val autorNome: String = "Corredor",
    val titulo: String = "",
    val descricao: String = "",
    val corrida: Corrida = Corrida(),
    val data: Long = System.currentTimeMillis(),
    val urlsFotos: List<String> = emptyList(),
    val curtidas: List<String> = emptyList(),
    val qtdComentarios: Int = 0
)

=== ARQUIVO: app/src/main/java/com/example/pegapista/data/location/LocationManager.kt ===

package com.example.pegapista.data.location

import android.annotation.SuppressLint
import android.content.Context
import android.location.Location
import android.os.Looper
import com.google.android.gms.location.*

class LocationManager(context: Context) {

    private val fusedLocationClient = LocationServices.getFusedLocationProviderClient(context)
    private var locationCallback: LocationCallback? = null

    private var locationAnterior: Location? = null
    private var distanciaTotal: Float = 0f

    interface LocationListener {
        fun onLocationUpdate(velocidadeKmh: Double, distanciaMetros: Float, location: Location)
    }

    @SuppressLint("MissingPermission")
    fun startTracking(listener: LocationListener) {
        distanciaTotal = 0f
        locationAnterior = null

        val locationRequest = LocationRequest.Builder(Priority.PRIORITY_HIGH_ACCURACY, 2000)
            .setMinUpdateDistanceMeters(2f)
            .build()

        locationCallback = object : LocationCallback() {
            override fun onLocationResult(result: LocationResult) {
                for (location in result.locations) {

                    if (locationAnterior == null) {
                        locationAnterior = location
                        continue
                    }

                    val anterior = locationAnterior!!
                    val distanciaDoPulo = anterior.distanceTo(location)
                    val isPontoValido = location.accuracy <= 20 && distanciaDoPulo >= 4

                    if (isPontoValido) {
                        distanciaTotal += distanciaDoPulo
                        locationAnterior = location

                        val velocidadeKmh = location.speed * 3.6
                        val velocidadeReal = if (velocidadeKmh > 0.5) velocidadeKmh else 0.0

                        listener.onLocationUpdate(velocidadeReal, distanciaTotal, location)
                    }
                }
            }
        }

        fusedLocationClient.requestLocationUpdates(
            locationRequest,
            locationCallback!!,
            Looper.getMainLooper()
        )
    }

    fun stopTracking() {
        locationCallback?.let {
            fusedLocationClient.removeLocationUpdates(it)
        }
        locationCallback = null
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/utils/ImageUtils.kt ===

import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.net.Uri
import java.io.ByteArrayOutputStream
import java.io.InputStream

fun comprimirImagem(context: Context, imageUri: Uri): ByteArray {
    val inputStream: InputStream? = context.contentResolver.openInputStream(imageUri)
    val originalBitmap = BitmapFactory.decodeStream(inputStream)


    val larguraMaxima = 1080
    val alturaProporcional = (originalBitmap.height * larguraMaxima) / originalBitmap.width

    val bitmapRedimensionado = Bitmap.createScaledBitmap(
        originalBitmap,
        larguraMaxima,
        alturaProporcional,
        true
    )

    val baos = ByteArrayOutputStream()
    bitmapRedimensionado.compress(Bitmap.CompressFormat.JPEG, 70, baos)

    return baos.toByteArray()
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/utils/MapUtils.kt ===

package com.example.pegapista.utils

import android.content.Context
import android.graphics.Bitmap
import android.net.Uri
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.LatLngBounds
import java.io.File
import java.io.FileOutputStream

object MapUtils {
    fun calcularEnquadramento(pontos: List<LatLng>): LatLngBounds? {
        if (pontos.isEmpty()) return null

        val builder = LatLngBounds.Builder()
        for (ponto in pontos) {
            builder.include(ponto)
        }
        return builder.build()
    }

    fun salvarBitmapTemporario(context: Context, bitmap: Bitmap): Uri {
        val arquivo = File(context.cacheDir, "snapshot_mapa_${System.currentTimeMillis()}.jpg")
        val stream = FileOutputStream(arquivo)
        bitmap.compress(Bitmap.CompressFormat.JPEG, 80, stream)
        stream.close()
        return Uri.fromFile(arquivo)
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/utils/ShareUtils.kt ===

import android.content.Context
import android.content.Intent
import android.graphics.Bitmap
import android.graphics.drawable.BitmapDrawable
import androidx.core.content.FileProvider
import coil.ImageLoader
import coil.request.ImageRequest
import coil.request.SuccessResult
import com.example.pegapista.data.models.Postagem
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream

fun compartilharPost(context: Context, post: Postagem) {
    val urlImagem = post.urlsFotos.firstOrNull()

    val textoLegenda = """
        🏃‍♂️ *Corrida no PegaPista!*
        
        👤 ${post.autorNome}
        📏 Distância: ${"%.2f".format(post.corrida.distanciaKm)} km
        ⏱️ Tempo: ${post.corrida.tempo}
        ⚡ Pace: ${post.corrida.pace}
        
        ${post.titulo}
        ${post.descricao}
    """.trimIndent()

    if (urlImagem == null) {
        val shareIntent = Intent().apply {
            action = Intent.ACTION_SEND
            putExtra(Intent.EXTRA_TEXT, textoLegenda)
            type = "text/plain"
        }
        context.startActivity(Intent.createChooser(shareIntent, "Compartilhar..."))
        return
    }

    CoroutineScope(Dispatchers.IO).launch {
        try {
            val loader = ImageLoader(context)
            val request = ImageRequest.Builder(context)
                .data(urlImagem)
                .allowHardware(false)
                .build()

            val result = loader.execute(request)

            if (result is SuccessResult) {
                val bitmap = (result.drawable as BitmapDrawable).bitmap

                val cachePath = File(context.cacheDir, "images")
                cachePath.mkdirs()

                val stream = FileOutputStream("$cachePath/share_image.jpg")
                bitmap.compress(Bitmap.CompressFormat.JPEG, 90, stream)
                stream.close()

                val imagePath = File(context.cacheDir, "images")
                val newFile = File(imagePath, "share_image.jpg")
                val contentUri = FileProvider.getUriForFile(
                    context,
                    "${context.packageName}.provider",
                    newFile
                )

                val shareIntent = Intent().apply {
                    action = Intent.ACTION_SEND
                    putExtra(Intent.EXTRA_TEXT, textoLegenda)
                    putExtra(Intent.EXTRA_STREAM, contentUri)
                    type = "image/jpeg"
                    addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                }
                withContext(Dispatchers.Main) {
                    context.startActivity(Intent.createChooser(shareIntent, "Compartilhar via..."))
                }
            }
        } catch (e: Exception) {
            e.printStackTrace()
            withContext(Dispatchers.Main) {
                val shareIntent = Intent().apply {
                    action = Intent.ACTION_SEND
                    putExtra(Intent.EXTRA_TEXT, textoLegenda)
                    type = "text/plain"
                }
                context.startActivity(
                    Intent.createChooser(
                        shareIntent,
                        "Compartilhar (erro na img)..."
                    )
                )
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/utils/NotificationUtils.kt ===

package com.example.pegapista.utils

import android.Manifest
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.graphics.BitmapFactory
import androidx.core.app.ActivityCompat
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import com.example.pegapista.MainActivity
import com.example.pegapista.R

const val CHANNEL_ID = "CHANNEL_ID_PEGAPISTA"

fun showNotification(context: Context, titulo: String, mensagem: String) {
    if (ActivityCompat.checkSelfPermission(
            context,
            Manifest.permission.POST_NOTIFICATIONS
        ) != PackageManager.PERMISSION_GRANTED
    ) {
        return
    }

    val intent = Intent(context, MainActivity::class.java).apply {
        flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
    }
    val pendingIntent: PendingIntent = PendingIntent.getActivity(
        context, 0, intent, PendingIntent.FLAG_IMMUTABLE
    )

    val largeIconBitmap = BitmapFactory.decodeResource(context.resources, R.drawable.ic_notification)

    val builder = NotificationCompat.Builder(context, CHANNEL_ID)
        .setSmallIcon(R.drawable.ic_notification)
        .setLargeIcon(largeIconBitmap)
        .setColor(context.getColor(R.color.purple_500))
        .setContentTitle(titulo)
        .setContentText(mensagem)
        .setPriority(NotificationCompat.PRIORITY_DEFAULT)
        .setContentIntent(pendingIntent)
        .setAutoCancel(true)

    with(NotificationManagerCompat.from(context)) {
        notify(System.currentTimeMillis().toInt(), builder.build())
    }
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/utils/ArquivoUtils.kt ===

package com.example.pegapista.utils


import android.content.Context

import android.net.Uri

import java.io.File

import java.io.FileOutputStream

import java.util.UUID

fun copiarImagemParaCache(context: Context, uri: Uri): String? {
    return try {
        val contentResolver = context.contentResolver
        val nomeArquivo = "img_post_${UUID.randomUUID()}.jpg"
        val arquivoDestino = File(context.cacheDir, nomeArquivo)
        val inputStream = contentResolver.openInputStream(uri)
        val outputStream = FileOutputStream(arquivoDestino)


        inputStream?.use { input ->
            outputStream.use { output ->
                input.copyTo(output)
            }
        }
        arquivoDestino.absolutePath

    } catch (e: Exception) {
        e.printStackTrace()
        null
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/utils/Mappers.kt ===

package com.example.pegapista.utils

import com.example.pegapista.data.models.Corrida
import com.example.pegapista.data.models.Postagem
import com.example.pegapista.data.local.entities.PostagemEntity

// Função que converte a Entidade do Banco (PostagemEntity) para o Modelo do App (Postagem)
fun PostagemEntity.toModel(): Postagem {
    return Postagem(
        id = this.id,
        userId = this.userId,
        autorNome = this.autorNome,
        titulo = this.titulo,
        descricao = this.descricao,

        corrida = Corrida(
            distanciaKm = this.distanciaKm,
            tempo = this.tempo,
            pace = this.pace
        ),

        data = this.data,

        urlsFotos = if (this.fotoUrl.isNullOrBlank()) {
            emptyList()
        } else {
            this.fotoUrl.split(";")
        }
    )
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/utils/DateUtils.kt ===

package com.example.pegapista.utils

import java.util.Calendar

object DateUtils {

    fun isMesmoDia(timestamp1: Long, timestamp2: Long): Boolean {
        val cal1 = Calendar.getInstance().apply { timeInMillis = timestamp1 }
        val cal2 = Calendar.getInstance().apply { timeInMillis = timestamp2 }

        return cal1.get(Calendar.YEAR) == cal2.get(Calendar.YEAR) &&
                cal1.get(Calendar.DAY_OF_YEAR) == cal2.get(Calendar.DAY_OF_YEAR)
    }

    fun isOntem(ultimoTimestamp: Long): Boolean {
        val agora = Calendar.getInstance()
        val ontem = Calendar.getInstance().apply {
            add(Calendar.DAY_OF_YEAR, -1)
        }
        val dataUltima = Calendar.getInstance().apply {
            timeInMillis = ultimoTimestamp
        }

        return ontem.get(Calendar.YEAR) == dataUltima.get(Calendar.YEAR) &&
                ontem.get(Calendar.DAY_OF_YEAR) == dataUltima.get(Calendar.DAY_OF_YEAR)
    }
}


=== ARQUIVO: app/src/main/java/com/example/pegapista/PegaPistaScreen.kt ===

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.Scaffold
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.navigation.compose.rememberNavController
import com.example.pegapista.navigation.NavigationGraph

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun PegaPistaScreen() {
    val navController = rememberNavController()
    NavigationGraph(
        navController = navController
    )
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/navigation/NavigationGraph.kt ===

package com.example.pegapista.navigation

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.statusBarsPadding
import androidx.compose.foundation.layout.systemBarsPadding
import androidx.compose.foundation.pager.HorizontalPager
import androidx.compose.foundation.pager.rememberPagerState
import androidx.compose.material3.Scaffold
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavHostController
import androidx.navigation.NavType
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.navArgument
import com.example.pegapista.service.RunningState
import com.example.pegapista.ui.components.BottomBar
import com.example.pegapista.ui.screens.*
import com.example.pegapista.ui.screens.auth.CadastroScreen
import com.example.pegapista.ui.screens.auth.InicioScreen
import com.example.pegapista.ui.screens.auth.LoginScreen
import com.example.pegapista.ui.screens.corrida.AtividadeAfterScreen
import com.example.pegapista.ui.screens.corrida.AtividadeBeforeScreen
import com.example.pegapista.ui.screens.corrida.MapaVisualizacaoScreen
import com.example.pegapista.ui.screens.corrida.RunFinishedScreen
import com.example.pegapista.ui.screens.home.FeedScreen
import com.example.pegapista.ui.screens.home.HomeScreen
import com.example.pegapista.ui.screens.perfil.BuscarAmigosScreen
import com.example.pegapista.ui.screens.perfil.ListaUsuariosScreen
import com.example.pegapista.ui.screens.perfil.PerfilScreen
import com.example.pegapista.ui.screens.perfil.PerfilUsuarioScreen
import com.example.pegapista.ui.screens.social.ComentariosScreen
import com.example.pegapista.ui.screens.social.NotificacoesScreen
import com.example.pegapista.ui.screens.social.RankingScreen
import com.example.pegapista.ui.viewmodels.HomeViewModel
import com.google.android.gms.maps.model.LatLng
import com.google.firebase.auth.FirebaseAuth
import kotlinx.coroutines.launch

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun NavigationGraph(
    navController: NavHostController,
    modifier: Modifier = Modifier
) {
    val auth = FirebaseAuth.getInstance()
    val usuarioAtual = auth.currentUser
    val isCorrendo = RunningState.isRastreando.collectAsState().value || RunningState.tempoSegundos.collectAsState().value > 0f

    val destinoInicial = if (usuarioAtual != null) {
        if (isCorrendo) "AtividadeAfter" else "main"
    } else {
        "inicio"
    }

    NavHost(
        navController = navController,
        startDestination = destinoInicial,
        modifier = modifier
    ) {
        composable("main") {
            MainContainer(
                navController = navController,
                onDeslogar = {
                    navController.navigate("inicio") {
                        popUpTo(0) { inclusive = true }
                        launchSingleTop = true
                    }
                }
            )
        }

        composable("inicio") {
            Box(Modifier.fillMaxSize().background(Color.White).systemBarsPadding()) {
                InicioScreen(
                    onEntrarClick = { navController.navigate("login") },
                    onCadastrarClick = { navController.navigate("cadastro") }
                )
            }
        }

        composable("login") {
            LoginScreen(
                onEntrarHome = {
                    navController.navigate("main") { popUpTo("inicio") { inclusive = true } }
                }
            )
        }

        composable("cadastro") {
            CadastroScreen(
                onCadastroSucesso = {
                    navController.navigate("main") { popUpTo("inicio") { inclusive = true } }
                }
            )
        }

        composable("AtividadeAfter") {
            Box(Modifier.fillMaxSize().background(Color.White).systemBarsPadding()) {
                AtividadeAfterScreen(
                    onFinishActivity = { dist, tempo, pace, listaPontos ->
                        navController.currentBackStackEntry?.savedStateHandle?.set("rota_gps", listaPontos)
                        navController.navigate("RunFinished/$dist/$tempo/$pace")
                    },
                    onCancelActivity = {
                        navController.navigate("main") { popUpTo("main") { inclusive = true } }
                    }
                )
            }
        }

        composable("Mapa") {
            Box(Modifier.fillMaxSize().background(Color.White).statusBarsPadding()) {
                MapaVisualizacaoScreen(onVoltar = { navController.popBackStack() })
            }
        }

        composable(
            route = "RunFinished/{distancia}/{tempo}/{pace}",
            arguments = listOf(
                navArgument("distancia") { type = NavType.FloatType },
                navArgument("tempo") { type = NavType.StringType },
                navArgument("pace") { type = NavType.StringType }
            )
        ) { backStackEntry ->
            val listaPontos = navController.previousBackStackEntry?.savedStateHandle?.get<List<LatLng>>("rota_gps") ?: emptyList()
            val distancia = backStackEntry.arguments?.getFloat("distancia")?.toDouble() ?: 0.0
            val tempo = backStackEntry.arguments?.getString("tempo") ?: "00:00"
            val pace = backStackEntry.arguments?.getString("pace") ?: "-:--"

            Box(Modifier.fillMaxSize().background(Color.White).systemBarsPadding()) {
                RunFinishedScreen(
                    distancia = distancia,
                    tempo = tempo,
                    pace = pace,
                    caminhoPercorrido = listaPontos,
                    onFinishNavigation = {
                        navController.navigate("main") { popUpTo("main") { inclusive = true } }
                    }
                )
            }
        }

        composable("Ranking") {
            Box(Modifier.fillMaxSize().background(Color.White).statusBarsPadding()) {
                RankingScreen(
                    onFeedScreen = { navController.popBackStack() },
                    onBuscarAmigosScreen = { navController.navigate("BuscarAmigos") }
                )
            }
        }

        composable("BuscarAmigos") {
            Box(Modifier.fillMaxSize().background(Color.White).statusBarsPadding()) {
                BuscarAmigosScreen(
                    onPerfilUsuarioScreen = { idUsuario -> navController.navigate("PerfilUsuario/$idUsuario") }
                )
            }
        }

        composable("PerfilUsuario/{idUsuario}") { backStackEntry ->
            val idUsuario = backStackEntry.arguments?.getString("idUsuario") ?: ""
            Box(Modifier.fillMaxSize().background(Color.White).statusBarsPadding()) {
                PerfilUsuarioScreen(
                    idUsuario = idUsuario,
                    onCommentClick = { post -> navController.navigate("comentarios/${post.id}/${idUsuario}") },
                    onSeguidoresClick = { id -> navController.navigate("ListaUsuarios/SEGUIDORES/$id") },
                    onSeguindoClick = { id -> navController.navigate("ListaUsuarios/SEGUINDO/$id") }
                )
            }
        }

        composable(
            route = "ListaUsuarios/{tipo}/{idUsuario}",
            arguments = listOf(
                navArgument("tipo") { type = NavType.StringType },
                navArgument("idUsuario") { type = NavType.StringType }
            )
        ) { backStackEntry ->
            val tipo = backStackEntry.arguments?.getString("tipo") ?: "SEGUIDORES"
            val idUsuario = backStackEntry.arguments?.getString("idUsuario") ?: ""
            val titulo = if (tipo == "SEGUIDORES") "Seguidores" else "Seguindo"

            Box(Modifier.fillMaxSize().background(Color.White).statusBarsPadding()) {
                ListaUsuariosScreen(
                    titulo = titulo,
                    idUsuarioAlvo = idUsuario,
                    tipoLista = tipo,
                    onVoltar = { navController.popBackStack() },
                    onUsuarioClick = { idNovoUsuario ->
                        navController.navigate("PerfilUsuario/$idNovoUsuario")
                    }
                )
            }
        }

        composable(
            route = "comentarios/{postId}/{remetenteId}",
            arguments = listOf(navArgument("postId") { type = NavType.StringType })
        ) { backStackEntry ->
            val postId = backStackEntry.arguments?.getString("postId") ?: ""
            val remetenteId = backStackEntry.arguments?.getString("remetenteId") ?: ""
            ComentariosScreen(
                postId = postId,
                remetenteId = remetenteId,
                onVoltar = { navController.popBackStack() }
            )
        }

        composable("notificacoes") {
            Box(Modifier.fillMaxSize().background(Color.White).statusBarsPadding()) {
                NotificacoesScreen()
            }
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun MainContainer(
    navController: NavHostController,
    onDeslogar: () -> Unit
) {
    val pagerState = rememberPagerState(pageCount = { 5 })
    val scope = rememberCoroutineScope()

    val currentRouteStub = when (pagerState.currentPage) {
        0 -> "Home"
        1 -> "comunidade"
        2 -> "perfil"
        3 -> "AtividadeBefore"
        4 -> "notificacoes"
        else -> "Home"
    }

    Scaffold(
        bottomBar = {
            BottomBar(
                currentRoute = currentRouteStub,
                onItemClick = { route ->
                    val page = when (route) {
                        "Home" -> 0
                        "comunidade" -> 1
                        "perfil" -> 2
                        "AtividadeBefore" -> 3
                        "notificacoes" -> 4
                        else -> 0
                    }
                    scope.launch { pagerState.animateScrollToPage(page) }
                }
            )
        }
    ) { paddingValues ->
        HorizontalPager(
            state = pagerState,
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) { page ->
            when (page) {
                0 -> { // HOME
                    val homeViewModel: HomeViewModel = viewModel()
                    val usuario by homeViewModel.usuario.collectAsState()
                    val ranking by homeViewModel.ranking.collectAsState()
                    val atividades by homeViewModel.atividadesAmigos.collectAsState()
                    LaunchedEffect(Unit) {
                        homeViewModel.carregarDadosUsuario()
                    }
                    HomeScreen(
                        usuario = usuario,
                        ranking = ranking,
                        atividades = atividades,
                        onIniciarCorrida = { scope.launch {
                            pagerState.animateScrollToPage(3)
                        } }
                    )
                }
                1 -> { // COMUNIDADE
                    FeedScreen(
                        onRankingScreen = { navController.navigate("Ranking") },
                        onBuscarAmigosScreen = { navController.navigate("BuscarAmigos") },
                        onCommentClick = { post -> navController.navigate("comentarios/${post.id}/${post.userId}") },
                        onProfileClick = { userId -> navController.navigate("PerfilUsuario/$userId") }
                    )
                }
                2 -> { // PERFIL
                    PerfilScreen(
                        onDeslogar = onDeslogar,
                        onCommentClick = { post, userId ->
                            navController.navigate("comentarios/${post.id}/${userId}")
                        },
                        onSeguidoresClick = { id -> navController.navigate("ListaUsuarios/SEGUIDORES/$id") },
                        onSeguindoClick = { id -> navController.navigate("ListaUsuarios/SEGUINDO/$id") }
                    )
                }
                3 -> { // ATIVIDADE (Aba)
                    AtividadeBeforeScreen(
                        onStartActivity = { navController.navigate("AtividadeAfter") },
                        onAbrirMapa = { navController.navigate("Mapa") }
                    )
                }
                4 -> { // NOTIFICACOES
                    NotificacoesScreen()
                }
            }
        }
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/MainActivity.kt ===

package com.example.pegapista

import PegaPistaScreen
import android.Manifest
import android.app.NotificationChannel
import android.app.NotificationManager
import android.content.Context
import android.content.pm.PackageManager
import android.icu.util.Calendar
import android.os.Build
import android.os.Bundle
import android.util.Log
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.annotation.RequiresApi
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.material3.*
import androidx.compose.runtime.remember
import androidx.compose.ui.Modifier
import androidx.core.view.WindowCompat
import androidx.navigation.compose.rememberNavController
import androidx.work.ExistingPeriodicWorkPolicy
import androidx.work.PeriodicWorkRequestBuilder
import androidx.work.WorkManager
import com.example.pegapista.di.storageModule
import com.example.pegapista.service.RunningState
import com.example.pegapista.ui.theme.PegaPistaTheme
import com.example.pegapista.utils.CHANNEL_ID
import com.example.pegapista.worker.LembreteWorker
import com.google.firebase.messaging.FirebaseMessaging
import org.koin.android.ext.koin.androidContext
import org.koin.core.context.GlobalContext.startKoin
import java.util.concurrent.TimeUnit

class MainActivity : ComponentActivity() {
    @RequiresApi(Build.VERSION_CODES.O)
    override fun onCreate(savedInstanceState: Bundle?) {
        FirebaseMessaging.getInstance().token
            .addOnCompleteListener { task ->
                if (!task.isSuccessful) {
                    Log.e("FCM_TOKEN", "Erro ao obter token", task.exception)
                    return@addOnCompleteListener
                }

                val token = task.result
                Log.d("FCM_TOKEN", token)
            }

        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        WindowCompat.setDecorFitsSystemWindows(window, false)
        createNotificationChannel()
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            if (checkSelfPermission(Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                requestPermissions(arrayOf(Manifest.permission.POST_NOTIFICATIONS), 101)
            }
        }
        agendarNotificacaoDiaria()
        setContent {
            PegaPistaTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    PegaPistaScreen()
                }
            }
        }
    }

    private fun createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val name = "Notificações PegaPista"
            val descriptionText = "Canal para avisos de corridas, redes sociais e conquistas"
            val importance = NotificationManager.IMPORTANCE_DEFAULT
            val channel = NotificationChannel(CHANNEL_ID, name, importance).apply {
                description = descriptionText
            }
            val notificationManager: NotificationManager =
                getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
            notificationManager.createNotificationChannel(channel)
        }
    }

    private fun agendarNotificacaoDiaria() {
        val horaAlvo = 8
        val minutoAlvo = 0

        val agora = Calendar.getInstance()
        val horarioNotificacao = Calendar.getInstance().apply {
            set(Calendar.HOUR_OF_DAY, horaAlvo)
            set(Calendar.MINUTE, minutoAlvo)
            set(Calendar.SECOND, 0)
        }

        if (horarioNotificacao.before(agora)) {
            horarioNotificacao.add(Calendar.DAY_OF_MONTH, 1)
        }

        val tempoAteInicio = horarioNotificacao.timeInMillis - agora.timeInMillis

        val lembreteRequest = PeriodicWorkRequestBuilder<LembreteWorker>(24, TimeUnit.HOURS)
            .setInitialDelay(tempoAteInicio, TimeUnit.MILLISECONDS)
            .addTag("lembrete_diario")
            .build()

        WorkManager.getInstance(this).enqueueUniquePeriodicWork(
            "WorkNotificacaoDiaria",
            ExistingPeriodicWorkPolicy.REPLACE,
            lembreteRequest
        )
    }
}

=== ARQUIVO: app/src/main/java/com/example/pegapista/service/RunningState.kt ===

package com.example.pegapista.service

import com.google.android.gms.maps.model.LatLng
import kotlinx.coroutines.flow.MutableStateFlow

object RunningState {
    val tempoSegundos = MutableStateFlow(0L)
    val distanciaMetros = MutableStateFlow(0f)
    val pace = MutableStateFlow("-:--")
    val percurso = MutableStateFlow<List<LatLng>>(emptyList())
    val isRastreando = MutableStateFlow(false)
}



=== ARQUIVO: app/src/main/java/com/example/pegapista/service/MyFirebaseMessagingService.kt ===

package com.example.pegapista.service

import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.messaging.FirebaseMessagingService

class MyFirebaseMessagingService : FirebaseMessagingService() {

    override fun onNewToken(token: String) {
        super.onNewToken(token)

        val uid = FirebaseAuth.getInstance().currentUser?.uid
        if (uid != null) {
            FirebaseFirestore.getInstance()
                .collection("usuarios")
                .document(uid)
                .update("fcmToken", token)
        }
    }
}




=== ARQUIVO: app/src/main/java/com/example/pegapista/service/RunningService.kt ===

package com.example.pegapista.service

import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.Service
import android.content.Intent
import android.location.Location
import android.os.Build
import android.os.IBinder
import androidx.core.app.NotificationCompat
import com.example.pegapista.R
import com.example.pegapista.data.location.LocationManager
import com.google.android.gms.maps.model.LatLng
import kotlinx.coroutines.*

class RunningService: Service() {

    private val serviceScope = CoroutineScope(Dispatchers.Main + SupervisorJob())
    private lateinit var locationManager: LocationManager
    private val notificationId = 1
    private var distanciaAcumuladaOffset = 0f

    override fun onCreate() {
        super.onCreate()
        locationManager = LocationManager(this)
        createNotificationChannel()
    }

    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        when (intent?.action) {
            "START" -> startRun()
            "PAUSE" -> pauseRun()
            "STOP" -> stopRun()
        }
        return START_STICKY
    }

    private fun startRun() {
        if (RunningState.isRastreando.value) return
        distanciaAcumuladaOffset = RunningState.distanciaMetros.value
        RunningState.isRastreando.value = true

        startForeground(notificationId, buildNotification())

        locationManager.startTracking(object : LocationManager.LocationListener {
            override fun onLocationUpdate(velocidadeKmh: Double, distanciaMetros: Float, location: Location) {
                val distanciaTotal = distanciaAcumuladaOffset + distanciaMetros
                RunningState.distanciaMetros.value = distanciaTotal
                val novoPonto = LatLng(location.latitude, location.longitude)
                val listaAtual = RunningState.percurso.value.toMutableList()
                listaAtual.add(novoPonto)
                RunningState.percurso.value = listaAtual

                updateNotification("Distância: %.2f km".format(distanciaMetros / 1000))
            }
        })

        serviceScope.launch {
            while (RunningState.isRastreando.value) {
                delay(1000L)
                val novoTempo = RunningState.tempoSegundos.value + 1
                RunningState.tempoSegundos.value = novoTempo

                calcularPace(RunningState.distanciaMetros.value, novoTempo)
            }
        }
    }

    private fun pauseRun() {
        RunningState.isRastreando.value = false
        locationManager.stopTracking()
        updateNotification("Corrida Pausada")
    }

    private fun stopRun() {
        pauseRun()
        stopForeground(STOP_FOREGROUND_REMOVE)
        stopSelf()
        distanciaAcumuladaOffset = 0f
    }

    private fun calcularPace(distanciaMetros: Float, segundos: Long) {
        if (distanciaMetros < 50) return
        val distKm = distanciaMetros / 1000.0
        val tempoMin = segundos / 60.0
        if (distKm > 0) {
            val paceDec = tempoMin / distKm
            val min = paceDec.toInt()
            val sec = ((paceDec - min) * 60).toInt()
            if (min < 60) RunningState.pace.value = "%d:%02d".format(min, sec)
        }
    }

    private fun createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                "running_channel",
                "Rastreamento de Corrida",
                NotificationManager.IMPORTANCE_LOW
            )
            val manager = getSystemService(NotificationManager::class.java)
            manager.createNotificationChannel(channel)
        }
    }

    private fun buildNotification(): android.app.Notification {
        return NotificationCompat.Builder(this, "running_channel")
            .setContentTitle("PegaPista Ativo")
            .setContentText("Rastreando sua corrida...")
            .setSmallIcon(R.drawable.ic_notification)
            .setOngoing(true)
            .build()
    }

    private fun updateNotification(texto: String) {
        val notification = NotificationCompat.Builder(this, "running_channel")
            .setContentTitle("PegaPista Ativo")
            .setContentText(texto)
            .setSmallIcon(R.drawable.ic_notification)
            .setOngoing(true)
            .setOnlyAlertOnce(true)
            .build()

        val manager = getSystemService(NotificationManager::class.java)
        manager.notify(notificationId, notification)
    }

    override fun onDestroy() {
        super.onDestroy()
        serviceScope.cancel()
    }

    override fun onBind(intent: Intent?): IBinder? = null
}

=== ARQUIVO: app/src/main/AndroidManifest.xml ===

<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">
    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-feature android:name="android.hardware.camera" android:required="false" />
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:name=".PegaPistaApplication"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.PegaPista">
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.provider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
        <service
            android:name=".service.RunningService"
            android:foregroundServiceType="location"
            android:exported="false" />
        <service
            android:name=".service.MyFirebaseMessagingService"
            android:exported="false">
            <intent-filter>
                <action android:name="com.google.firebase.MESSAGING_EVENT" />
            </intent-filter>
        </service>
        <meta-data
            android:name="com.google.android.geo.API_KEY"
            android:value="AIzaSyDGY5GDAk8C0-4dnDFAHTcg2A_m1mylGQk" />
        <meta-data
            android:name="com.google.firebase.messaging.default_notification_icon"
            android:resource="@drawable/ic_notification" />
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name"
            android:windowSoftInputMode="adjustResize">
            android:theme="@style/Theme.PegaPista">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>